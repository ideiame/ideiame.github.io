
<!DOCTYPE html>
<html lang="en" class="dark-mode">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Using the Timescale gem with Ruby</title>
    <meta name="description" content="I joined Timescale as a developer advocate. One of my creative tasks there was live streaming. As I've been working with Ruby since 2007, I created a live st...">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Always use dark mode -->
    <script>
      (function() {
        document.documentElement.classList.add('dark-mode');
        document.write('<style>body,html{background-color:#0c0c0c!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JetBrains Mono and other developer fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    <!-- Site styles -->
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/modern-theme.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/modern-effects.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body class="dark-mode">
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Geometric background pattern -->
    <div class="geometric-bg"></div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <span class="logo">
            <span class="i">i</span>
            <span class="d">d</span>
            <span class="e">e</span>
            <span class="i2">i</span>
            <span class="a">a</span>
            <span class="dot">.</span>
            <span class="m">m</span>
            <span class="e2">e</span>
          </span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              </a>
              <ul class="dropdown-menu shadow-sm glass-card" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Using the Timescale gem with Ruby
          </div>
          
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> September 07, 2022</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 15 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#time-series-ref" class="text-muted">time-series</a>, 
        
          <a href="#postgresql-ref" class="text-muted">postgresql</a>, 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>I joined Timescale as a developer advocate. One of my creative tasks there was live streaming.
As I’ve been working with Ruby since 2007, I created a live streaming series about how to use Timescale with Ruby.</p>

<p>I’d like to teach you how to use the gem with Ruby. Not Rails. Only plain Ruby and some ActiveRecord flavor that turns it more interesting.</p>

<p>In this post, I will cover the basics of inserting, querying, looking at some timescale metadata, and the compression system. Soon, I’ll cover more features like compression policies, <a href="/timescale-continuous-aggregates-with-ruby">continuous aggregates</a>, and more advanced features.</p>

<p>If you want to run the complete example yourself, it’s <a href="https://github.com/jonatas/timescaledb/blob/master/examples/all_in_one/all_in_one.rb">alive</a> and belongs to the official <a href="https://jonatas.github.io/timescaledb/">docs</a>. If you find any bugs or want to improve the example, feel free to <a href="https://github.com/jonatas/timescaledb/pulls">submit a PR</a>.</p>

<p>If you’re curious about the live streaming, you can also check the links from all episodes <a href="https://github.com/jonatas/timescaledb#more-resources">here</a>.</p>

<h2 id="dependencies">Dependencies</h2>

<p>The Timescale gem depends on <a href="https://github.com/ged/ruby-pg">PG</a> and ActiveRecord. I chose ActiveRecord as it was the main wrapper for ORM in the Ruby ecosystem. In addition, the concepts are pretty simple and can be easily migrated to another framework.</p>

<p>Let’s start requiring bundler inline to avoid the creation of the <code class="language-plaintext highlighter-rouge">Gemfile</code>. I’m adding the <a href="https://docs.timescale.com/install/latest/">timescaledb</a> gem, and the mentioned libraries will be fetched as dependencies. Also, <a href="http://pry.github.io">pry</a> is here because it’s the best REPL to debug any Ruby code.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># all_in_one.rb file</span>
<span class="nb">require</span> <span class="s1">'bundler/inline

gemfile(true) do
  gem '</span><span class="n">timescaledb</span><span class="s1">'
  gem '</span><span class="n">pry</span><span class="err">'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>A good part of using the bundler inline is that you don’t have to require the dependencies.</p>

<p>Now, let’s start by establishing the connection. Let’s use the URI as the last parameter from the command line. For example, to run from my localhost, I can refer to the database URI like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby all_in_one.RB postgres://jonatasdp@localhost:5432/playground
</code></pre></div></div>

<p>Make sure you change the <code class="language-plaintext highlighter-rouge">jonatasdp</code> to your username and the <code class="language-plaintext highlighter-rouge">playground</code> to
your database name. Check <a href="https://docs.timescale.com/install/latest/">how to install Timescale</a> first, or you can try a
free instance on the <a href="https://www.timescale.com/timescale-signup/">Timescale cloud</a>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span><span class="p">(</span> <span class="no">ARGV</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
</code></pre></div></div>

<p>With this line, you’re making the connection to the database, and you can already
start making queries or whatever you want.</p>

<h2 id="creating-the-first-hypertable-with-ruby">Creating the first hypertable with Ruby</h2>

<p>The concept is that <a href="https://docs.timescale.com/timescaledb/latest/overview/core-concepts/hypertables-and-chunks/">Hypertables</a> are PostgreSQL tables designed to handle time-series data. So anything you can do with a regular PostgreSQL table, you can do with a hypertable. The advantage is that you have an outstanding performance and user experience for time-series data.</p>

<p>It improves performance by partitioning time-series data on its time column. While you can still perform all your operations using the table name, Timescale is smart to maintain the hypertable’s partitions while you can deal with a single, regular PostgreSQL table.</p>

<p>It’s also able to compress the data of the child tables and fold the partitions
in multiple dimensions.</p>

<p>As we’re not going to have the Rails migrations system in this small example, we
can start defining what our hypertable looks like.</p>

<p>Let’s call it <code class="language-plaintext highlighter-rouge">Event</code>, starting from the model, and the objective is to store events that happen at a specific time with a payload that can allow us to give the event more details.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="n">acts_as_hypertable</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that Timescale hypertables are all about time-series data, and you generally
don’t need to have primary keys.</p>

<p>ActiveRecord default returns the object’s id when you insert it into the database. Setting a <code class="language-plaintext highlighter-rouge">primary_key</code> to another column helps us to avoid this behavior as it would say the column <code class="language-plaintext highlighter-rouge">id</code> was not found.</p>

<p>The following line is about saying it’s hypertable. The <code class="language-plaintext highlighter-rouge">acts_as_hypertable</code> macro allows you to override several options. By default, it uses the <code class="language-plaintext highlighter-rouge">created_at</code> as the time column, and the rest of the hypertable configurations are using the defaults just to allow us to make some progress here.</p>

<h3 id="creating-the-minimum-migration-system">Creating the minimum migration system</h3>

<p>Now, let’s create the minimum migration setup and use the hypertable.</p>

<p>Let’s start moving the logs to the standard output as ActiveRecord is configured to send the information to a file. The feedback will help check how every step is executed as we test.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
</code></pre></div></div>

<p>The next step is to call the <code class="language-plaintext highlighter-rouge">create_table</code> method from ActiveRecord. And here is where the timescaledb gem acts. Then, finally, we can inject the desired behavior with the <code class="language-plaintext highlighter-rouge">hypertable</code> option.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>

  <span class="n">drop_table</span><span class="p">(</span><span class="ss">:events</span><span class="p">)</span> <span class="k">if</span> <span class="no">Event</span><span class="p">.</span><span class="nf">table_exists?</span>

  <span class="n">hypertable_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">time_column: </span><span class="s1">'created_at'</span><span class="p">,</span>
    <span class="ss">chunk_time_interval: </span><span class="s1">'1 day'</span><span class="p">,</span>
    <span class="ss">compress_segmentby: </span><span class="s1">'identifier'</span><span class="p">,</span>
    <span class="ss">compression_interval: </span><span class="s1">'7 days'</span>
  <span class="p">}</span>

  <span class="n">create_table</span><span class="p">(</span><span class="ss">:events</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">hypertable: </span><span class="n">hypertable_options</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:identifier</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">jsonb</span> <span class="ss">:payload</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>I love using <a href="https://ruby-doc.org/core-3.1.2/BasicObject.html#method-i-instance_exec">instance_exec</a> as it allows me to execute several commands from a different perspective. Instead of having the connection as a variable, I can jump into the scope and declare some code similar to the rails migration files. Easier to move to an actual app later if I’m only prototyping for a while ;)</p>

<p>Now, let’s break down what  we have in the hypertable options:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">hypertable_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">time_column: </span><span class="s1">'created_at'</span><span class="p">,</span>
    <span class="ss">chunk_time_interval: </span><span class="s1">'1 day'</span><span class="p">,</span>
    <span class="ss">compress_segmentby: </span><span class="s1">'identifier'</span><span class="p">,</span>
    <span class="ss">compression_interval: </span><span class="s1">'7 days'</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">time_column</code> option calls the <code class="language-plaintext highlighter-rouge">create_hypertable</code> function in the command line. So, converting to SQL, after creating the table, it will have an extra line like calling the <a href="https://docs.timescale.com/api/latest/hypertable/create_hypertable/">create_hypertable</a> function:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">create_hypertable</span><span class="p">(</span><span class="s1">'events'</span><span class="p">,</span> <span class="s1">'created_at'</span> <span class="p">)</span>
</code></pre></div></div>

<p>The hypertable contains several <a href="https://docs.timescale.com/api/latest/hypertable/create_hypertable/#create-hypertable">optional arguments</a> that can also be used in this migration helper. In our case, we’re overriding only the <code class="language-plaintext highlighter-rouge">chunk_time_interval</code> that the default is <code class="language-plaintext highlighter-rouge">7 days</code>, and we’re going with <code class="language-plaintext highlighter-rouge">1 day</code>.</p>

<p>The following two options are related to the <a href="https://docs.timescale.com/timescaledb/latest/overview/core-concepts/compression/">compression</a> concept. First, it reduces the amount of space used by your data. Some queries also speed up query time because fewer bytes must be read from the disk.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="ss">compress_segmentby: </span><span class="s1">'identifier'</span><span class="p">,</span>
    <span class="ss">compression_interval: </span><span class="s1">'7 days'</span>
</code></pre></div></div>

<p>The <a href="https://docs.timescale.com/timescaledb/latest/overview/core-concepts/compression/architecture/#hybrid-row-columnar-format-for-chunks">segmentby</a> option works like a group by clause for compression. In our case, we have an <code class="language-plaintext highlighter-rouge">identifier</code> that will be used to group types of events.</p>

<p>Check the <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/compression/about-compression/#segment-by-columns">segmentation guide</a> to better understand this feature’s power.</p>

<p>Behind the scenes, the timescale gem is just inserting some SQL queries that interface with Timescale functions. For this example, it’s running the
following queries:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">events</span> <span class="k">SET</span> <span class="p">(</span>
  <span class="n">timescaledb</span><span class="p">.</span><span class="n">compress</span><span class="p">,</span>
  <span class="n">timescaledb</span><span class="p">.</span><span class="n">compress_segmentby</span> <span class="o">=</span> <span class="s1">'identifier'</span>
<span class="p">);</span>
</code></pre></div></div>

<p>And the <code class="language-plaintext highlighter-rouge">compression_interval</code> is responsible for establishing a policy on when to compress the data. So in our example, after the data is 7 days old, we can already compress it to save space.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">add_compression_policy</span><span class="p">(</span><span class="s1">'events'</span><span class="p">,</span> <span class="n">INTERVAL</span> <span class="s1">'7 days'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="inserting-some-data">Inserting some data</h2>

<p>Now, let’s insert some random data into the hypertable to see how it works:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">insert_all</span> <span class="p">[</span>
  <span class="p">{</span> <span class="ss">identifier: </span><span class="s2">"sign_up"</span><span class="p">,</span> <span class="ss">payload: </span><span class="p">{</span><span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Eon"</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">identifier: </span><span class="s2">"login"</span><span class="p">,</span> <span class="ss">payload: </span><span class="p">{</span><span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"eon@timescale.com"</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">identifier: </span><span class="s2">"click"</span><span class="p">,</span> <span class="ss">payload: </span><span class="p">{</span><span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="s2">"eon"</span><span class="p">,</span> <span class="s2">"path"</span> <span class="o">=&gt;</span> <span class="s2">"/install/timescaledb"</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">identifier: </span><span class="s2">"scroll"</span><span class="p">,</span> <span class="ss">payload: </span><span class="p">{</span><span class="s2">"user"</span> <span class="o">=&gt;</span> <span class="s2">"eon"</span><span class="p">,</span> <span class="s2">"path"</span> <span class="o">=&gt;</span> <span class="s2">"/install/timescaledb"</span><span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">identifier: </span><span class="s2">"logout"</span><span class="p">,</span> <span class="ss">payload: </span><span class="p">{</span><span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="s2">"eon@timescale.com"</span><span class="p">}</span> <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>As we’re using the <code class="language-plaintext highlighter-rouge">created_at</code> column as the time column, we don’t need to
specify it because ActiveRecord will automatically set it.</p>

<p>If you want to assign it, you’ll need to override this method to allow it to pass in the payload:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">timestamp_attributes_for_create_in_model</span>
    <span class="p">[]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Also, note that I’m using <a href="https://apidock.com/rails/v6.0.0/ActiveRecord/Persistence/ClassMethods/insert_all">insert_all</a> because it’s faster than trying to go record by record.</p>

<h2 id="generate-data-with-faker">Generate data with faker</h2>

<p>Now, let’s use the faker gem to create some massive fake data for the events table:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># all_in_one.rb file</span>
<span class="nb">require</span> <span class="s1">'bundler/inline

gemfile(true) do
  gem '</span><span class="n">timescaledb</span><span class="s1">'
  gem '</span><span class="n">faker</span><span class="s1">'
  gem '</span><span class="n">pry</span><span class="err">'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s create a method to generate a random payload using different emails and names.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_fake_data</span><span class="p">(</span><span class="ss">total: </span><span class="mi">100_000</span><span class="p">)</span>
  <span class="n">time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="nf">month</span><span class="p">.</span><span class="nf">ago</span>
  <span class="n">total</span><span class="p">.</span><span class="nf">times</span><span class="p">.</span><span class="nf">flat_map</span> <span class="k">do</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="sx">%w[sign_up login click scroll logout view]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">60</span><span class="p">).</span><span class="nf">seconds</span>
    <span class="p">{</span>
      <span class="ss">created_at: </span><span class="n">time</span><span class="p">,</span>
      <span class="ss">updated_at: </span><span class="n">time</span><span class="p">,</span>
      <span class="ss">identifier: </span><span class="n">identifier</span><span class="p">.</span><span class="nf">sample</span><span class="p">,</span>
      <span class="ss">payload: </span><span class="p">{</span>
        <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
        <span class="s2">"email"</span> <span class="o">=&gt;</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The fake data generator will start creating records from 1 year ago, and the period between the records is from 1 to 60 seconds. Now, inserting a few thousand records will be easy:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batch</span> <span class="o">=</span> <span class="n">generate_fake_data</span> <span class="ss">total: </span><span class="mi">10_000</span>
<span class="no">Event</span><span class="p">.</span><span class="nf">insert_all</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="ss">returning: </span><span class="kp">false</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, it’s time to query the data and learn how to use the helpers that are
available for querying data.</p>

<h2 id="querying-data">Querying data</h2>

<p>A few scopes are available to help filter the data and make it easier to work with the time column and filter by standard time frames.</p>

<h3 id="filtering-by-date">Filtering by date</h3>

<p>Counting events from the previous month:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">previous_month</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 10000</span>
</code></pre></div></div>

<p>Similar scopes filtering by time can be:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">previous_week</code> and <code class="language-plaintext highlighter-rouge">previous_day</code></li>
  <li><code class="language-plaintext highlighter-rouge">last_week</code> and <code class="language-plaintext highlighter-rouge">last_hour</code></li>
  <li><code class="language-plaintext highlighter-rouge">this_week</code> and <code class="language-plaintext highlighter-rouge">this_month</code></li>
  <li><code class="language-plaintext highlighter-rouge">yesterday</code>, <code class="language-plaintext highlighter-rouge">today</code> and <code class="language-plaintext highlighter-rouge">last_hour</code></li>
</ul>

<p>As the scopes are smart, you can combine them with more complex queries.
For example, let’s count records from the previous month grouped by identifier:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">previous_month</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s1">'identifier'</span><span class="p">).</span><span class="nf">count</span>
 <span class="p">{</span><span class="s2">"click"</span><span class="o">=&gt;</span><span class="mi">1665</span><span class="p">,</span>
 <span class="s2">"login"</span><span class="o">=&gt;</span><span class="mi">1681</span><span class="p">,</span>
 <span class="s2">"logout"</span><span class="o">=&gt;</span><span class="mi">1662</span><span class="p">,</span>
 <span class="s2">"scroll"</span><span class="o">=&gt;</span><span class="mi">1606</span><span class="p">,</span>
 <span class="s2">"sign_up"</span><span class="o">=&gt;</span><span class="mi">1684</span><span class="p">,</span>
 <span class="s2">"view"</span><span class="o">=&gt;</span><span class="mi">1702</span><span class="p">}</span>
</code></pre></div></div>

<h3 id="using-the-timescale-time_bucket-function">Using the Timescale <code class="language-plaintext highlighter-rouge">time_bucket</code> function</h3>

<p>You can combine it with the <a href="https://docs.timescale.com/api/latest/hyperfunctions/time_bucket/">time_bucket</a> function. For now, I couldn’t find an exciting way to build a DSL for the time bucket, but you can make it with SQL through the query.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span>
  <span class="p">.</span><span class="nf">previous_month</span>
  <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"time_bucket('1 day', created_at) as time, identifier, count(*)"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s2">"1,2"</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:attributes</span><span class="p">)</span>
<span class="p">[{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"click"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">224</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"login"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">244</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"logout"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">239</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"scroll"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">230</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"sign_up"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">227</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">06</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"view"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">245</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"click"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">516</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"login"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">471</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"logout"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">484</span><span class="p">},</span>
 <span class="p">{</span><span class="s2">"time"</span><span class="o">=&gt;</span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span> <span class="s2">"identifier"</span><span class="o">=&gt;</span><span class="s2">"scroll"</span><span class="p">,</span> <span class="s2">"count"</span><span class="o">=&gt;</span><span class="mi">451</span><span class="p">},</span>
 <span class="c1"># ... more records here</span>
<span class="p">]</span>
</code></pre></div></div>

<p>If you’re interested in materializing the time_bucket grouped results to faster access to the processed data, take a look in the <a href="/timescale-continuous-aggregates-with-ruby">Creating continous aggregates with Ruby and Timescale</a> post.</p>

<h3 id="querying-metadata">Querying metadata</h3>

<p>The gem also contains several methods to inspect the Timescale metadata. So let’s start diving into the methods and how they can be helpful.</p>

<p>The <code class="language-plaintext highlighter-rouge">hypertable</code> method is available directly from the model and can give you the details in the <code class="language-plaintext highlighter-rouge">timescaledb_information.hypertables</code> view.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">hypertable</span>
<span class="c1"># =&gt; #&lt;Timescaledb::Hypertable:0x00007fefc7b0ea78</span>
 <span class="ss">hypertable_schema: </span><span class="s2">"public"</span><span class="p">,</span>
 <span class="ss">hypertable_name: </span><span class="s2">"events"</span><span class="p">,</span>
 <span class="ss">owner: </span><span class="s2">"jonatasdp"</span><span class="p">,</span>
 <span class="ss">num_dimensions: </span><span class="mi">1</span><span class="p">,</span>
 <span class="ss">num_chunks: </span><span class="mi">5</span><span class="p">,</span>
 <span class="ss">compression_enabled: </span><span class="kp">true</span><span class="p">,</span>
 <span class="ss">is_distributed: </span><span class="kp">false</span><span class="p">,</span>
 <span class="ss">replication_factor: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">data_nodes: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">tablespaces: </span><span class="kp">nil</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Behind the scenes, it’s executing the following query:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="nv">"timescaledb_information"</span><span class="p">.</span><span class="nv">"hypertables"</span>
<span class="k">WHERE</span> <span class="nv">"hypertable_name"</span> <span class="o">=</span> <span class="s1">'events'</span><span class="p">;</span>
</code></pre></div></div>

<p>Remember that a model named <code class="language-plaintext highlighter-rouge">Timescaledb::Hypertable</code> is available, and you can build the same query directly in this model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Timescaledb</span><span class="o">::</span><span class="no">Hypertable</span><span class="p">.</span><span class="nf">find_by</span> <span class="ss">hypertable_name: </span><span class="no">Event</span><span class="p">.</span><span class="nf">table_name</span>
</code></pre></div></div>

<p>The same can be done for chunks. So, a hypertable has many chunks, and you can query them in an ActiveRecord relation style.</p>

<p>For example, the statement:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">hypertable</span><span class="p">.</span><span class="nf">chunks</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 5</span>
</code></pre></div></div>

<p>Will execute the following query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="nv">"timescaledb_information"</span><span class="p">.</span><span class="nv">"chunks"</span>
<span class="k">WHERE</span> <span class="nv">"hypertable_name"</span> <span class="o">=</span>  <span class="s1">'events'</span><span class="p">;</span>
</code></pre></div></div>

<p>As the previous example, a model <code class="language-plaintext highlighter-rouge">Timescaledb::Chunk</code> is also available, and you can build the query directly on that too:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Timescaledb</span><span class="o">::</span><span class="no">Chunk</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">hypertable_name: </span><span class="no">Event</span><span class="p">.</span><span class="nf">table_name</span><span class="p">).</span><span class="nf">count</span>
</code></pre></div></div>

<p>Let’s dive into some chunk objects:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chunk</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">hypertable</span><span class="p">.</span><span class="nf">chunks</span><span class="p">.</span><span class="nf">first</span>
<span class="c1"># =&gt; #&lt;Timescaledb::Chunk:0x00007fefc77096d0</span>
 <span class="ss">hypertable_schema: </span><span class="s2">"public"</span><span class="p">,</span>
 <span class="ss">hypertable_name: </span><span class="s2">"events"</span><span class="p">,</span>
 <span class="ss">chunk_schema: </span><span class="s2">"_timescaledb_internal"</span><span class="p">,</span>
 <span class="ss">chunk_name: </span><span class="s2">"_hyper_1415_11429_chunk"</span><span class="p">,</span>
 <span class="ss">primary_dimension: </span><span class="s2">"created_at"</span><span class="p">,</span>
 <span class="ss">primary_dimension_type: </span><span class="s2">"timestamp without time zone"</span><span class="p">,</span>
 <span class="ss">range_start: </span><span class="mi">2022</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span>
 <span class="ss">range_end: </span><span class="mi">2022</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">08</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span>
 <span class="ss">range_start_integer: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">range_end_integer: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">is_compressed: </span><span class="kp">false</span><span class="p">,</span>
 <span class="ss">chunk_tablespace: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">data_nodes: </span><span class="kp">nil</span><span class="o">&gt;</span>
</code></pre></div></div>

<h3 id="the-timescaledb-compression">The TimescaleDB Compression</h3>

<p>Chunk objects can also be compressed or decompressed. So, reusing the
last variable:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">chunk</span><span class="p">.</span><span class="nf">compress!</span>
</code></pre></div></div>

<p>That will basically execute the following query:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">compress_chunk</span><span class="p">((</span><span class="s1">'_timescaledb_internal._hyper_1415_11429_chunk'</span><span class="p">)::</span><span class="n">regclass</span><span class="p">)</span>
</code></pre></div></div>

<p>You can also check details about the detailed size of the hypertable. After
compressing, you can see how much space you’re saving.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">size</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">hypertable</span><span class="p">.</span><span class="nf">detailed_size</span>
<span class="c1">#&lt;2, total_bytes=1933312, node_name=nil&gt;`sql</span>
 <span class="no">SELECT</span> <span class="o">*</span> <span class="n">from</span> <span class="n">hypertable_compression_stats</span><span class="p">(</span><span class="s1">'events'</span><span class="p">)</span>
</code></pre></div></div>

<p>As you can see in the previous data, the compression was ineffective. So now, let’s compress all uncompressed chunks, as this was probably the chunk with fewer data.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Event</span><span class="p">.</span><span class="nf">hypertable</span><span class="p">.</span><span class="nf">chunks</span><span class="p">.</span><span class="nf">uncompressed</span><span class="p">.</span><span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:compress!</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, rechecking the status:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stats</span> <span class="o">=</span> <span class="no">Event</span><span class="p">.</span><span class="nf">hypertable</span><span class="p">.</span><span class="nf">compression_stats</span>
<span class="c1"># =&gt; #&lt;OpenStruct total_chunks=5</span>
<span class="c1">#  number_compressed_chunks=5</span>
<span class="c1">#  before_compression_table_bytes=1400832</span>
<span class="c1">#  before_compression_index_bytes=491520</span>
<span class="c1">#  before_compression_toast_bytes=40960</span>
<span class="c1">#  before_compression_total_bytes=1933312</span>
<span class="c1">#  after_compression_table_bytes=40960</span>
<span class="c1">#  after_compression_index_bytes=81920</span>
<span class="c1">#  after_compression_toast_bytes=688128</span>
<span class="c1">#  after_compression_total_bytes=811008</span>
<span class="c1">#  node_name=nil&gt;</span>
</code></pre></div></div>

<p>Now, let’s do some math to calculate the compression ratio and understand how
much space we’re saving in the table:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">after_compression_table_bytes</span> <span class="o">/</span> <span class="n">stats</span><span class="p">.</span><span class="nf">before_compression_table_bytes</span><span class="p">.</span><span class="nf">to_f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
<span class="o">=&gt;</span> <span class="mf">97.07602339181287</span>
</code></pre></div></div>

<p>Not bad! 97% of the space was saved 🚀</p>

<p>I hope you enjoyed this first post about the gem. If you have any feedback, don’t hesitate to reach out! Looking forward to seeing more Rubyists adopting TimescaleDB!</p>


  </div>
  
  
  <div class="article-tags">
    
      <a href="#time-series-ref" class="article-tag">time-series</a>
    
      <a href="#postgresql-ref" class="article-tag">postgresql</a>
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Using+the+Timescale+gem+with+Ruby&url=https%3A%2F%2Fideia.me%2Fusing-the-timescale-gem-with-ruby&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fusing-the-timescale-gem-with-ruby" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fusing-the-timescale-gem-with-ruby&title=Using+the+Timescale+gem+with+Ruby" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fusing-the-timescale-gem-with-ruby&title=Using+the+Timescale+gem+with+Ruby" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/writing-plans" title="Writing plans">
        Writing plans
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/tips-to-duplicate-massive-time-series-data-on-postgresql" title="Tips to duplicate massive time series data on Postgresql">
        Tips to duplicate massive time series data on P...
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
              
                
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
          
            
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/four-years-at-timescale">Four Years at Timescale: My Journey in Marketing</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> April 15, 2025
                        </small>
                      </p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
        
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/using-the-timescale-gem-with-ruby';
    this.page.identifier = '/using-the-timescale-gem-with-ruby';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Consolidated JS -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Apply highlighting to code blocks after content loads
        if (typeof enhanceCodeBlocks === 'function') {
          enhanceCodeBlocks();
        }
        
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Add fade-in animations
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Apply fade-in to cards and other elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .glass-card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Minimal delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
        
        // Smooth page transitions
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    
    <!-- Dedicated scripts -->
  </body>
</html>

