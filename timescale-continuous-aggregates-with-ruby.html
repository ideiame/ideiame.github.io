
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Creating continuous aggregates with Ruby and Timescale</title>
    <meta name="description" content="I created the [timescale gem][1] and wrote an introductory post on how [using the timescale gem with ruby][2].">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Immediate dark mode application to prevent flash -->
    <script>
      (function() {
        // Force dark mode for testing purposes
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.documentElement.classList.add('dark-mode');
          document.write('<style>body,html{background-color:#121212!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
        }
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- GitHub-style syntax highlighting -->
    <link href="/css/rouge-github.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/disqus-dark.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Creating continuous aggregates with Ruby and Timescale
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>Creating continuous aggregates with Ruby and Timescale</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> September 21, 2022</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 10 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#time-series-ref" class="text-muted">time-series</a>, 
        
          <a href="#PostgreSQL-ref" class="text-muted">PostgreSQL</a>, 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>I created the <a href="https://github.com/jonatas/timescaledb">timescale gem</a> and wrote an introductory post on how <a href="/using-the-timescale-gem-with-ruby">using the timescale gem with ruby</a>.</p>

<p>Now, it’s time to learn more about the <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/">continuous aggregates</a> feature. Accordingly, the Timescale website says:</p>

<blockquote>
  <p>Continuous aggregates are designed to make queries on very large datasets run faster. TimescaleDB continuous aggregates use PostgreSQL materialized views to continuously and incrementally refresh a query in the background, so that when you run the query, only the data that has changed needs to be computed, not the entire dataset.</p>
</blockquote>

<p>This feature is a core feature of the TimescaleDB. If you’re already using TimescaleDB probably, you’ll find an excellent opportunity to use this.</p>

<p>We’re going to use the <a href="https://docs.timescale.com/api/latest/hyperfunctions/time_bucket/">time_bucket</a> function that was already explored in the <a href="https://ideia.me/using-the-timescale-gem-with-ruby#using-the-timescale-time_bucket-function">previous post</a> but now using applying the <a href="https://en.wikipedia.org/wiki/Candlestick_pattern">candlestick</a> pattern.</p>

<blockquote>
  <p>Candlesticks are graphical representations of price movements for a given period. They are commonly formed by a financial instrument’s opening, high, low, and closing prices. <a href="https://en.wikipedia.org/wiki/Candlestick_pattern">Learn more</a>.</p>
</blockquote>

<h3 id="migration-for-the-hypertable-creation">Migration for the hypertable creation</h3>

<p>Let’s continue with a minimal migration system to prove the concept before we jump into a more advanced migration scenario.
In this example, we’ll start with creating the ticks table representing stock market events and then group the events by minute to show the candlestick pattern.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>
  <span class="n">drop_table</span> <span class="ss">:ticks</span><span class="p">,</span> <span class="ss">force: :cascade</span>

  <span class="n">hypertable_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">time_column: </span><span class="s1">'time'</span><span class="p">,</span>
    <span class="ss">chunk_time_interval: </span><span class="s1">'1 day'</span><span class="p">,</span>
    <span class="ss">compress_segmentby: </span><span class="s1">'symbol'</span><span class="p">,</span>
    <span class="ss">compress_orderby: </span><span class="s1">'created_at'</span><span class="p">,</span>
    <span class="ss">compression_interval: </span><span class="s1">'7 days'</span>
  <span class="p">}</span>

  <span class="n">create_table</span> <span class="ss">:ticks</span><span class="p">,</span> <span class="ss">hypertable: </span><span class="n">hypertable_options</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">timestamp</span> <span class="ss">:time</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:symbol</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:price</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:volume</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The previous code instruction only involves the hypertable creation, and \ the continuous aggregate steps will be covered soon.</p>

<p>Note that the <code class="language-plaintext highlighter-rouge">drop_table</code> statement uses <code class="language-plaintext highlighter-rouge">force: :cascade</code> as it will also destroy the respective view if it exists. This example is also intended to be for <strong>testing purposes only</strong> as it’s also dropping and recreating the table every time you run it.</p>

<h3 id="activerecord-model-for-the-hypertable">ActiveRecord model for the hypertable</h3>

<p>And here is the ActiveRecord model simplified for the example.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Tick</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="s1">'ticks'</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">acts_as_hypertable</span> <span class="ss">time_column: </span><span class="s1">'time'</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The only data we need to override for now is the <code class="language-plaintext highlighter-rouge">time_column</code>, but you can override anything in the official documentation.</p>

<h3 id="generating-data">Generating data</h3>

<p>During this example, we’re not going to connect to a market data stream, but
generate some fake data to just understand how to use it.</p>

<p>Let’s create fake data for the <a href="https://www.investopedia.com/terms/f/faang-stocks.asp">FAANG stocks</a>.</p>

<p>Let’s define some helper variables that can help to generate the data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FAANG</span> <span class="o">=</span> <span class="sx">%w[META AMZN AAPL NFLX GOOG]</span>
<span class="no">OPERATION</span> <span class="o">=</span> <span class="p">[:</span><span class="o">+</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="p">]</span>
<span class="no">RAND_VOLUME</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">}</span>
</code></pre></div></div>

<p>Clarifying step by step:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">FAANG</code> will be the symbols that we will iterate.</li>
  <li><code class="language-plaintext highlighter-rouge">OPERATION</code> is the pricing signal that will be added or reduced randomly.</li>
  <li><code class="language-plaintext highlighter-rouge">RAND_VOLUME</code> will simply generate a contract volume for each event.</li>
</ul>

<p>Now defining the fake data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_fake_data</span><span class="p">(</span><span class="ss">total: </span><span class="mi">100</span><span class="p">)</span>
  <span class="n">previous_price</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
  <span class="p">(</span><span class="n">total</span> <span class="o">/</span> <span class="no">FAANG</span><span class="p">.</span><span class="nf">size</span><span class="p">).</span><span class="nf">times</span><span class="p">.</span><span class="nf">flat_map</span> <span class="k">do</span>
    <span class="no">FAANG</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">symbol</span><span class="o">|</span>
      <span class="n">time</span> <span class="o">+=</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">previous_price</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span>
        <span class="n">price</span> <span class="o">=</span> <span class="n">previous_price</span><span class="p">[</span><span class="n">symbol</span><span class="p">].</span><span class="nf">send</span><span class="p">(</span><span class="no">OPERATION</span><span class="p">.</span><span class="nf">sample</span><span class="p">,</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">price</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">+</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">time: </span><span class="n">time</span><span class="p">,</span> <span class="ss">symbol: </span><span class="n">symbol</span><span class="p">,</span> <span class="ss">price: </span><span class="nb">rand</span><span class="p">(),</span> <span class="ss">volume: </span><span class="no">RAND_VOLUME</span><span class="o">.</span><span class="p">()</span> <span class="p">}</span>
      <span class="n">previous_price</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>
      <span class="n">payload</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>It will generate a bunch of payloads that can be inserted.</p>

<p>The last step in generating the data is combining the data generated with the insert command. Again, we can go with <code class="language-plaintext highlighter-rouge">insert_all</code>, a faster method to persist the data using ActiveRecord.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batch</span> <span class="o">=</span> <span class="n">generate_fake_data</span> <span class="ss">total: </span><span class="mi">50</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="no">Tick</span><span class="p">.</span><span class="nf">insert_all</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="ss">returning: </span><span class="kp">false</span><span class="p">)</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
</code></pre></div></div>

<p>To confirm the data is of good quality, take a look on what are the generated prices:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">FAANG</span><span class="p">.</span><span class="nf">inject</span><span class="p">({})</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="n">s</span><span class="o">|</span>
  <span class="n">h</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="no">Tick</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span> <span class="ss">symbol: </span><span class="n">s</span><span class="p">).</span><span class="nf">order</span><span class="p">(</span><span class="ss">:time</span><span class="p">).</span><span class="nf">pluck</span><span class="p">(</span><span class="ss">:price</span><span class="p">).</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_f</span><span class="p">)</span>
  <span class="n">h</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The results will be a hash like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="s2">"META"</span><span class="o">=&gt;</span><span class="p">[</span><span class="mf">142.0</span><span class="p">,</span> <span class="mf">141.98</span><span class="p">,</span> <span class="mf">141.96</span><span class="p">,</span> <span class="mf">141.98</span><span class="p">,</span> <span class="mf">141.98</span><span class="p">,</span> <span class="mf">141.98</span><span class="p">,</span> <span class="mf">141.96</span><span class="p">,</span> <span class="mf">141.96</span><span class="p">,</span> <span class="mf">141.97</span><span class="p">,</span> <span class="mf">141.97</span><span class="p">],</span>
 <span class="s2">"AMZN"</span><span class="o">=&gt;</span><span class="p">[</span><span class="mf">103.0</span><span class="p">,</span> <span class="mf">103.0</span><span class="p">,</span> <span class="mf">103.01</span><span class="p">,</span> <span class="mf">103.0</span><span class="p">,</span> <span class="mf">103.01</span><span class="p">,</span> <span class="mf">103.0</span><span class="p">,</span> <span class="mf">103.0</span><span class="p">,</span> <span class="mf">103.01</span><span class="p">,</span> <span class="mf">103.03</span><span class="p">,</span> <span class="mf">103.05</span><span class="p">],</span>
 <span class="s2">"AAPL"</span><span class="o">=&gt;</span><span class="p">[</span><span class="mf">82.0</span><span class="p">,</span> <span class="mf">81.99</span><span class="p">,</span> <span class="mf">81.98</span><span class="p">,</span> <span class="mf">81.96</span><span class="p">,</span> <span class="mf">81.96</span><span class="p">,</span> <span class="mf">81.96</span><span class="p">,</span> <span class="mf">81.97</span><span class="p">,</span> <span class="mf">81.99</span><span class="p">,</span> <span class="mf">81.97</span><span class="p">,</span> <span class="mf">81.97</span><span class="p">],</span>
 <span class="s2">"NFLX"</span><span class="o">=&gt;</span><span class="p">[</span><span class="mf">60.0</span><span class="p">,</span> <span class="mf">59.99</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">59.99</span><span class="p">,</span> <span class="mf">59.99</span><span class="p">,</span> <span class="mf">60.01</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">60.02</span><span class="p">,</span> <span class="mf">60.02</span><span class="p">,</span> <span class="mf">60.02</span><span class="p">],</span>
 <span class="s2">"GOOG"</span><span class="o">=&gt;</span><span class="p">[</span><span class="mf">148.0</span><span class="p">,</span> <span class="mf">147.99</span><span class="p">,</span> <span class="mf">147.98</span><span class="p">,</span> <span class="mf">148.0</span><span class="p">,</span> <span class="mf">148.01</span><span class="p">,</span> <span class="mf">148.02</span><span class="p">,</span> <span class="mf">148.03</span><span class="p">,</span> <span class="mf">148.02</span><span class="p">,</span> <span class="mf">148.02</span><span class="p">,</span> <span class="mf">148.01</span><span class="p">]}</span>
</code></pre></div></div>

<p>The data varies very slowly, as expected. Now, feel free to change the fake data generation to generate at least a few hours of data. 10k will generate at least a few hours.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batch</span> <span class="o">=</span> <span class="n">generate_fake_data</span> <span class="ss">total: </span><span class="mi">10_000</span>
</code></pre></div></div>

<h3 id="querying-the-candlestick">Querying the candlestick</h3>

<p>Now, it’s time to focus on the <code class="language-plaintext highlighter-rouge">Tick</code> model again and add the <code class="language-plaintext highlighter-rouge">OHLC</code> method to return the candlestick from ActiveRecord. As it will return attributes not recognized by the model, let’s declare the accessors to be easier to read the values later.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Tick</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># skipping previous code for readability</span>
  <span class="sx">%w[open high low close]</span><span class="p">.</span><span class="nf">each</span><span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="n">attribute</span> <span class="nb">name</span><span class="p">,</span> <span class="ss">:decimal</span><span class="p">}</span>

  <span class="n">scope</span> <span class="ss">:ohlc</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">timeframe</span><span class="o">=</span><span class="s1">'1m'</span><span class="p">)</span> <span class="k">do</span>
    <span class="nb">select</span><span class="p">(</span><span class="s2">"time_bucket('</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">', time) as time,
      symbol,
      FIRST(price, time) as open,
      MAX(price) as high,
      MIN(price) as low,
      LAST(price, time) as close,
      SUM(volume) as volume"</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s2">"1,2"</span><span class="p">)</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>Testing the data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Tick</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">symbol: </span><span class="s2">"GOOG"</span><span class="p">).</span><span class="nf">ohlc</span>
<span class="p">[</span><span class="c1">#&lt;Tick:0x00007f9d62fdbb58 time: 2022-09-20 12:00:00 UTC, symbol: "GOOG", volume: 18600, open: 0.83e2, high: 0.8305e2, low: 0.8298e2, close: 0.8305e2&gt;,</span>
 <span class="c1">#&lt;Tick:0x00007f9d62fdba90 time: 2022-09-20 12:01:00 UTC, symbol: "GOOG", volume: 6000, open: 0.8305e2, high: 0.8307e2, low: 0.8305e2, close: 0.8306e2&gt;,</span>
 <span class="c1">#&lt;Tick:0x00007f9d62fdb9c8 time: 2022-09-20 12:02:00 UTC, symbol: "GOOG", volume: 55400, open: 0.8307e2, high: 0.8314e2, low: 0.8307e2, close: 0.8313e2&gt;,</span>
 <span class="c1">#&lt;Tick:0x00007f9d62fdb900 time: 2022-09-20 12:03:00 UTC, symbol: "GOOG", volume: 29300, open: 0.8315e2, high: 0.832e2, low: 0.8315e2, close: 0.832e2&gt;,</span>
 <span class="o">...</span> <span class="c1"># more records here ]</span>
</code></pre></div></div>

<p>Now testing with one-hour intervals:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Tick</span><span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="s1">'time'</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">symbol: </span><span class="s2">"GOOG"</span><span class="p">).</span><span class="nf">ohlc</span><span class="p">(</span><span class="s1">'1h'</span><span class="p">)</span>
<span class="c1"># =&gt; [#&lt;Tick:0x00007f9d62f2ae98 time: 2022-09-20 12:00:00 UTC, symbol: "GOOG", volume: 1617800, open: 0.83e2, high: 0.8325e2, low: 0.829e2, close: 0.83e2&gt;,</span>
<span class="c1">#   #&lt;Tick:0x00007f9d62f2add0 time: 2022-09-20 13:00:00 UTC, symbol: "GOOG", volume: 1634600, open: 0.83e2, high: 0.832e2, low: 0.8261e2, close: 0.8261e2&gt;,</span>
<span class="c1">#   #&lt;Tick:0x00007f9d62f2ad08 time: 2022-09-20 14:00:00 UTC, symbol: "GOOG", volume: 783300, open: 0.826e2, high: 0.826e2, low: 0.8231e2, close: 0.8249e2&gt;]</span>
</code></pre></div></div>

<p>It seems like everything is working as expected, and the last step is finally to create the continuous aggregates 🎉</p>

<h3 id="creating-the-continuous-aggregates">Creating the continuous aggregates</h3>

<p>Every time the <code class="language-plaintext highlighter-rouge">ohlc</code> scope is invoked, it queries the raw data from the ticks table and groups the data to consume. So let’s go with a materialized view that will make the same for us and continuously aggregate the values.</p>

<p>Continuous aggregates will persist the data from past minutes and only compute the data for the still open candlesticks. So, for example, if you’re processing buckets of one hour, it will materialize the data from previous hours and only compute the data from the last hour.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>
  <span class="n">create_continuous_aggregates</span><span class="p">(</span><span class="s1">'ohlc_1m'</span><span class="p">,</span> <span class="no">Tick</span><span class="p">.</span><span class="nf">ohlc</span><span class="p">(</span><span class="s1">'1m'</span><span class="p">),</span> <span class="ss">with_data: </span><span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">create_continuous_aggregates</code> method is available in the connection scope that is the same of the Rails Migrations.
In the background, the following query is being executed:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">ohlc_1m</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1m'</span><span class="p">,</span> <span class="nb">time</span><span class="p">)</span> <span class="k">as</span> <span class="nb">time</span><span class="p">,</span>
      <span class="n">symbol</span><span class="p">,</span>
      <span class="k">FIRST</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="nb">time</span><span class="p">)</span> <span class="k">as</span> <span class="k">open</span><span class="p">,</span>
      <span class="k">MAX</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">high</span><span class="p">,</span>
      <span class="k">MIN</span><span class="p">(</span><span class="n">price</span><span class="p">)</span> <span class="k">as</span> <span class="n">low</span><span class="p">,</span>
      <span class="k">LAST</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="nb">time</span><span class="p">)</span> <span class="k">as</span> <span class="k">close</span><span class="p">,</span>
      <span class="k">SUM</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="k">as</span> <span class="n">volume</span> <span class="k">FROM</span> <span class="nv">"ticks"</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span>
<span class="k">WITH</span> <span class="k">DATA</span><span class="p">;</span>
</code></pre></div></div>

<p>The last parameter, <code class="language-plaintext highlighter-rouge">with_data</code>, will automatically process the present data. If false, the <a href="https://docs.timescale.com/api/latest/continuous-aggregates/refresh_continuous_aggregate/#refresh-continuous-aggregate">refresh_continous_aggregates</a> can do the job later. If you have too much data to process, and you’re adding it to a Rails migration, maybe that’s a good idea to process it in a background job to not block your deployment.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Ohlc1m</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="s1">'ohlc_1m'</span>
  <span class="n">attribute</span> <span class="ss">:time</span><span class="p">,</span> <span class="ss">:time</span>
  <span class="n">attribute</span> <span class="ss">:symbol</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="sx">%w[open high low close volume]</span><span class="p">.</span><span class="nf">each</span><span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="n">attribute</span> <span class="nb">name</span><span class="p">,</span> <span class="ss">:decimal</span><span class="p">}</span>

  <span class="k">def</span> <span class="nf">readonly?</span>
   <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Comparing performance here is unfair as we don’t have enough data to see too much difference. But, testing with 10k, it’s already 4 times faster using pre-processed data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Tick</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">symbol</span><span class="ss">:"AAPL"</span><span class="p">).</span><span class="nf">ohlc</span><span class="p">(</span><span class="s1">'1m'</span><span class="p">)</span> <span class="c1"># Tick Load (13.8ms) </span>
<span class="no">Ohlc1m</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">symbol</span><span class="ss">:"AAPL"</span><span class="p">).</span><span class="nf">all</span>      <span class="c1"># Ohlc1m Load (3.6ms)</span>
</code></pre></div></div>

<h3 id="scenic-support">Scenic support</h3>

<p>If you’re using the <a href="https://github.com/scenic-views/scenic">scenic</a> views, it will work smoothly too. However, the scenic gem doesn’t support the <code class="language-plaintext highlighter-rouge">WITH</code> clause in the views, and the Timescale gem adds this support.
It dumps the views with the <code class="language-plaintext highlighter-rouge">WITH (timescaledb.continuous)</code> statement in SQL that is <a href="https://github.com/scenic-views/scenic/issues/310">skipped in the official gem</a>.</p>

<h2 id="extra-resources">Extra resources</h2>

<p>Download the code from this tutorial <a href="https://docs.timescale.com/api/latest/hyperfunctions/time_bucket/">here</a> and test yourself!</p>

<p>Here are a few extra resources that can be useful if you’re hacking TimescaleDB
with Ruby.</p>

<ol>
  <li><a href="/using-the-timescale-gem-with-ruby">Using TimescaleDB gem with Ruby</a></li>
  <li><a href="https://jonatas.github.io/timescaledb/migrations/#the-create_continuous_aggregate-helper">Official Gem documentation</a></li>
  <li><a href="https://github.com/jonatas/timescaledb">Timescale Gem GitHub project</a></li>
  <li><a href="https://github.com/jonatas/timescaledb/tree/master/examples">Official examples from source code</a></li>
</ol>

<p>Also, there is a fantastic <a href="https://www.youtube.com/watch?v=5KNY_5mH040">video</a> from Ryan Booz that dives deeper into Continuous
Aggregates and how it compares to PostgreSQL materialized views.</p>


  </div>
  
  
  <div class="article-tags">
    
      <a href="#time-series-ref" class="article-tag">time-series</a>
    
      <a href="#PostgreSQL-ref" class="article-tag">PostgreSQL</a>
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Creating+continuous+aggregates+with+Ruby+and+Timescale&url=https%3A%2F%2Fideia.me%2Ftimescale-continuous-aggregates-with-ruby&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Ftimescale-continuous-aggregates-with-ruby" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Ftimescale-continuous-aggregates-with-ruby&title=Creating+continuous+aggregates+with+Ruby+and+Timescale" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Ftimescale-continuous-aggregates-with-ruby&title=Creating+continuous+aggregates+with+Ruby+and+Timescale" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/tips-to-duplicate-massive-time-series-data-on-postgresql" title="Tips to duplicate massive time series data on Postgresql">
        Tips to duplicate massive time series data on P...
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/identify-your-needs-and-feelings" title="Identify Your Needs And Feelings">
        Identify Your Needs And Feelings
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
          
            
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/benchmarking-ruby-orms">Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> March 19, 2025
                        </small>
                      </p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/my-first-contribution-to-rubygems">My First Contribution To Rubygems</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> July 04, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Adding to my goal of being helpful in the software world, I had my first contribution to RubyGems [merged][new_pr] 🎉</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
        
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread" class="comments-section"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/timescale-continuous-aggregates-with-ruby';
    this.page.identifier = '/timescale-continuous-aggregates-with-ruby';
    
    // Handle dark mode for Disqus
    const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                        document.body.classList.contains('dark-mode') || 
                        window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (isDarkMode) {
      // Enable dark mode for Disqus
      this.page.functions = [];
      this.callbacks = {
        onReady: [function() {
          // Message the iframe to apply dark theme once loaded
          const message = {
            name: 'theme',
            data: {
              theme: 'dark'
            }
          };
          
          // Try to send the message multiple times as Disqus can load slowly
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 2000);
          
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 4000);
        }]
      };
    }
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    
    // Add dark styling for container
    if (document.documentElement.classList.contains('dark-mode') || 
        document.body.classList.contains('dark-mode') || 
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // Style the container immediately
      const style = document.createElement('style');
      style.textContent = `
        #disqus_thread {
          background-color: #1e1e1e !important;
          color: #f0f2f5 !important;
          padding: 20px;
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          margin-top: 30px;
          margin-bottom: 30px;
        }
        
        iframe {
          background-color: #1e1e1e !important;
          color-scheme: dark !important;
        }
        
        /* Force the iframe document to use dark mode */
        iframe[src*="disqus.com"] {
          color-scheme: dark !important;
          filter: invert(90%) hue-rotate(180deg) !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="/css/disable-line-numbers.css">
<script src="/js/disable-line-numbers.js"></script>


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.documentElement.classList.add('dark-mode');
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
              console.log('Dark mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            } else {
              document.documentElement.classList.remove('dark-mode');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
              console.log('Light mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            }
            
            // Force reload the page to ensure all styles are applied correctly
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
        }
        
        // Apply highlighting to code blocks after content loads
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Configure Disqus for dark mode if needed
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        if (isDarkMode) {
          // Insert dark mode CSS for Disqus
          const style = document.createElement('style');
          style.innerHTML = `
            #disqus_thread {
              background-color: #1e1e1e !important;
              color: #f0f2f5 !important;
              padding: 20px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            }
          `;
          document.head.appendChild(style);
          
          // Set Disqus config variable for dark mode
          window.disqus_config = function() {
            this.page.identifier = window.location.pathname;
            this.page.url = window.location.href;
            this.language = 'en';
            this.sso = {
              name: 'SiteName',
            };
            this.callbacks.onReady = [function() {
              const interval = setInterval(function() {
                if (document.getElementById('dsq-app2')) {
                  clearInterval(interval);
                  const disqusIframe = document.getElementById('dsq-app2');
                  disqusIframe.contentWindow.postMessage({
                    name: 'setTheme',
                    data: 'dark',
                  }, '*');
                }
              }, 100);
            }];
          };
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
    
    <!-- Disqus Dark Mode Handler -->
    <script>
      // Function to handle Disqus dark mode
      function setupDisqusDarkMode() {
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        // Add a style element to target the Disqus iframe
        const disqusStyle = document.createElement('style');
        disqusStyle.innerHTML = `
          html.dark-mode iframe, body.dark-mode iframe {
            color-scheme: dark !important;
          }
          
          html.dark-mode #disqus_thread, body.dark-mode #disqus_thread {
            background-color: #1e1e1e !important;
            color: #f0f2f5 !important;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        `;
        document.head.appendChild(disqusStyle);
        
        // Check for Disqus iframe and inject dark styles if needed
        const checkForDisqus = setInterval(() => {
          const disqusThread = document.getElementById('disqus_thread');
          const disqusIframes = document.querySelectorAll('iframe[src*="disqus.com"]');
          
          if (disqusThread || disqusIframes.length > 0) {
            clearInterval(checkForDisqus);
            
            if (isDarkMode) {
              // Try to signal Disqus to use dark theme
              if (window.DISQUS) {
                try {
                  window.DISQUS.host._loadEmbed({
                    color: 'dark',
                  });
                } catch (e) {
                  console.log('Could not set Disqus theme via API');
                }
              }
              
              // Direct CSS approach to all iframes
              disqusIframes.forEach(iframe => {
                try {
                  // Try to access the iframe document
                  const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                  
                  // Add dark mode classes and styles
                  if (iframeDocument.body) {
                    iframeDocument.body.classList.add('dark-mode');
                    
                    const darkStyle = iframeDocument.createElement('style');
                    darkStyle.textContent = `
                      body { background-color: #1e1e1e !important; color: #f0f2f5 !important; }
                      .textarea-wrapper, .post-actions, .alert { background-color: #2a2d31 !important; }
                      .wysiwyg__placeholder, input, textarea { color: #f0f2f5 !important; }
                      .publisher-background-color { background-color: #1e1e1e !important; }
                      .publisher-border-color { border-color: rgba(255, 255, 255, 0.1) !important; }
                      .publisher-anchor-color, a { color: #5c9eff !important; }
                    `;
                    iframeDocument.head.appendChild(darkStyle);
                  }
                } catch (e) {
                  console.log('Could not modify Disqus iframe due to CORS policy');
                  
                  // Add a fallback with filter approach
                  if (isDarkMode) {
                    // Apply a CSS filter to invert the colors
                    iframe.style.filter = 'invert(92%) hue-rotate(180deg)';
                  }
                }
              });
            }
          }
        }, 500);
      }
      
      // Run setup when DOM is loaded and after any content changes
      document.addEventListener('DOMContentLoaded', setupDisqusDarkMode);
      document.addEventListener('ajaxComplete', setupDisqusDarkMode);
      
      // Also run after a delay in case Disqus loads later
      setTimeout(setupDisqusDarkMode, 2000);
      setTimeout(setupDisqusDarkMode, 5000);
    </script>
    
    <!-- Dedicated Disqus dark mode handler -->
    <script src="/js/disqus-dark.js"></script>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        // Check saved preference first
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Apply theme based on saved preference or system preference
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
          console.log('Dark mode applied on initial load');
        } else {
          document.body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
          console.log('Light mode applied on initial load');
        }
        
        // Listen for changes in the OS color scheme only if no saved preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          // Only apply system preference if user hasn't manually chosen a theme
          if (localStorage.getItem('theme') === null) {
            const newColorScheme = e.matches ? 'dark' : 'light';
            if (newColorScheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.documentElement.classList.add('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = true;
              console.log('Dark mode applied from system preference change');
            } else {
              document.body.classList.remove('dark-mode');
              document.documentElement.classList.remove('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = false;
              console.log('Light mode applied from system preference change');
            }
          }
        });
      }

      // Initialize dark mode immediately before DOM content is fully loaded
      detectColorScheme();
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
      });
    </script>
  </body>
</html>

