
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>ActiveRecord update without primary key</title>
    <meta name="description" content="This weekend I [crossed a Twitter thread][1] that ended up motivating me to write this blog post.">
    <meta name="author" content="JÃ´natas Davi Paganini">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/code-highlighting.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Style overrides for Prism -->
    <style>
      /* Override Prism default styles to fix text shadow issues */
      code[class*="language-"],
      pre[class*="language-"],
      pre code,
      .token {
        text-shadow: none !important;
        -webkit-text-shadow: none !important;
        border: none !important;
        background: none;
      }
      
      /* Ensure proper background only on container elements */
      pre[class*="language-"] {
        background: var(--prism-background);
      }
      
      .dark-mode pre[class*="language-"] {
        background: var(--prism-background);
      }
    </style>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-ruby.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <div id="fb-root"></div>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        if (isDarkMode) {
          document.body.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
        }
        
        // Listen for changes in the OS color scheme
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          const newColorScheme = e.matches ? 'dark' : 'light';
          if (newColorScheme === 'dark') {
            document.body.classList.add('dark-mode');
            if (darkModeToggle) darkModeToggle.checked = true;
          } else {
            document.body.classList.remove('dark-mode');
            if (darkModeToggle) darkModeToggle.checked = false;
          }
        });
      }

      // Add code block enhancements
      function enhanceCodeBlocks() {
        document.querySelectorAll('pre code').forEach((codeBlock, index) => {
          // Get the parent pre element
          const preElement = codeBlock.parentElement;
          if (!preElement.classList.contains('enhanced')) {
            preElement.classList.add('enhanced');
            
            // Create a wrapper div with the highlight class
            const highlightDiv = document.createElement('div');
            highlightDiv.className = 'highlight';
            
            // Insert the wrapper before the pre element
            preElement.parentNode.insertBefore(highlightDiv, preElement);
            
            // Move the pre element inside the wrapper
            highlightDiv.appendChild(preElement);
            
            // Get language class from code element
            let language = '';
            codeBlock.classList.forEach(className => {
              if (className.startsWith('language-')) {
                language = className.substring(9);
              }
            });
            
            // Auto-detect language if none is specified
            if (!language) {
              // Check for Ruby
              if (codeBlock.textContent.includes('require') || 
                  codeBlock.textContent.includes('def ') ||
                  codeBlock.textContent.includes('class ') ||
                  codeBlock.textContent.includes('module ') ||
                  codeBlock.textContent.match(/\w+\s*=\s*\w+/g)) {
                language = 'ruby';
                codeBlock.classList.add('language-ruby');
              }
              // Check for SQL
              else if (codeBlock.textContent.includes('SELECT') || 
                       codeBlock.textContent.includes('FROM') ||
                       codeBlock.textContent.includes('WHERE') ||
                       codeBlock.textContent.includes('CREATE TABLE')) {
                language = 'sql';
                codeBlock.classList.add('language-sql');
              }
            }
            
            // If language is found, add it as a data attribute
            if (language) {
              highlightDiv.setAttribute('data-language', language);
            }
            
            // Create copy button
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = 'Copy';
            copyButton.setAttribute('aria-label', 'Copy code to clipboard');
            copyButton.onclick = function() {
              navigator.clipboard.writeText(codeBlock.textContent)
                .then(() => {
                  copyButton.textContent = 'Copied!';
                  copyButton.classList.add('copied');
                  setTimeout(() => {
                    copyButton.textContent = 'Copy';
                    copyButton.classList.remove('copied');
                  }, 2000);
                })
                .catch(err => {
                  console.error('Could not copy text: ', err);
                });
            };
            
            // Add copy button to the highlight div
            highlightDiv.appendChild(copyButton);
          }
        });
      }
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
        enhanceCodeBlocks();
      });
    </script>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            ActiveRecord update without primary key
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>ActiveRecord update without primary key</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> October 18, 2022</span>
      <span class="separator">â€¢</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 7 min read
    </span>
  
 
      
      
      <span class="separator">â€¢</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>, 
        
          <a href="#postgresql-ref" class="text-muted">postgresql</a>, 
        
          <a href="#timescaledb-ref" class="text-muted">timescaledb</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>This weekend I <a href="https://twitter.com/XasinTheSystem/status/1581424684301979648">crossed a Twitter thread</a> that ended up motivating me to write this blog post.</p>

<blockquote>
  <p>Thanks, find_by works perfectly, but IIRC, ActiveRecord needs an ID field to save/modify data. Iâ€™ll try out composite_primary_keys with an ID+Timestamp combo, then. Iâ€™ve got a use case where I want to change a record in a hypertable to add metadata info.</p>
</blockquote>

<p>In this scenario, thereâ€™s an enriching process to add metadata.
Generally, time-series data comes from sensors and other sources representing a state of something or action of someone at a point in time. These states and actions are generally unchangeable, so I never overthought them.</p>

<p>On the core concepts of the TimescaleDB, hypertables use local indices
instead of having a unique index for the entire hypertable. Check what the <a href="https://docs.timescale.com/timescaledb/latest/overview/core-concepts/hypertables-and-chunks/hypertable-architecture/#chunk-local-indexes">official documentation</a> says:</p>

<blockquote>
  <p>Rather than building a global index over an entire hypertable, TimescaleDB builds local indexes on each chunk. In other words, each chunk has its own index that only indexes data within that chunk. Even with multiple local indexes, TimescaleDB can still ensure global uniqueness for keys. It enforces an important constraint: any key that requires uniqueness, such as a PRIMARY KEY, must include all columns that are used for data partitioning.</p>
</blockquote>

<p>So, if you need to update the data, record by record, here is a small idea that might help you make it using <a href="https://apidock.com/rails/ActiveRecord/Base/update_all/class">update_all</a>.</p>

<p>I will get a random scenario from the test database I used to build the gem.</p>

<p>I have the following ActiveRecord model as an example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="no">Tick</span> <span class="c1"># =&gt; Timescaledb::Tick(symbol: text, price: decimal, time: datetime)</span>
<span class="n">tick</span> <span class="o">=</span> <span class="no">Tick</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">symbol: </span><span class="s2">"TEST"</span><span class="p">,</span> <span class="ss">price: </span><span class="mf">123.4</span><span class="p">,</span> <span class="ss">time: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Timescaledb::Tick:0x00007f9fd96f5358 symbol: "TEST", price: 0.1234e3, time: 2022-10-18 12:56:13.409779 UTC&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, if I try to update an attribute of the record:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">tick</span><span class="p">.</span><span class="nf">symbol</span> <span class="o">=</span> <span class="s2">"OTHER"</span> <span class="c1"># =&gt; "OTHER"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And then, when I try to save it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">tick</span><span class="p">.</span><span class="nf">save</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">StatementInvalid</span><span class="p">:</span> <span class="no">PG</span><span class="o">::</span><span class="no">SyntaxError</span><span class="p">:</span> <span class="no">ERROR</span><span class="p">:</span>  <span class="n">zero</span><span class="o">-</span><span class="n">length</span> <span class="n">delimited</span> <span class="n">identifier</span> <span class="n">at</span> <span class="ow">or</span> <span class="n">near</span> <span class="s2">""""</span>
<span class="no">LINE</span> <span class="mi">1</span><span class="p">:</span> <span class="no">UPDATE</span> <span class="s2">"ticks"</span> <span class="no">SET</span> <span class="s2">"symbol"</span> <span class="o">=</span> <span class="vg">$1</span> <span class="no">WHERE</span> <span class="s2">"ticks"</span><span class="o">.</span><span class="s2">""</span> <span class="no">IS</span> <span class="no">NULL</span>
                                                       <span class="o">^</span>
<span class="no">Caused</span> <span class="n">by</span> <span class="no">PG</span><span class="o">::</span><span class="no">SyntaxError</span><span class="p">:</span> <span class="no">ERROR</span><span class="p">:</span>  <span class="n">zero</span><span class="o">-</span><span class="n">length</span> <span class="n">delimited</span> <span class="n">identifier</span> <span class="n">at</span> <span class="ow">or</span> <span class="n">near</span> <span class="s2">""""</span>
<span class="no">LINE</span> <span class="mi">1</span><span class="p">:</span> <span class="no">UPDATE</span> <span class="s2">"ticks"</span> <span class="no">SET</span> <span class="s2">"symbol"</span> <span class="o">=</span> <span class="vg">$1</span> <span class="no">WHERE</span> <span class="s2">"ticks"</span><span class="o">.</span><span class="s2">""</span> <span class="no">IS</span> <span class="no">NULL</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Boom! ðŸ’¥</p>

<p>Here comes the problem. A primary key will be necessary to update it. As the ActiveRecord depends on <code class="language-plaintext highlighter-rouge">id</code> to update records, now you need to find a new way
to specify it.</p>

<p>For that reason, thereâ€™s a gem <a href="https://github.com/composite-primary-keys/composite_primary_keys">composite_primary_key</a> that allows you to specify
the attributes that should be used in the primary key.</p>

<p>I initially added it to the timescaledb gem, but as most of the use cases will not depend on updates, I dropped the dependency and covered a possible solution using the <a href="https://docs.timescale.com/timescaledb/latest/overview/core-concepts/hypertables-and-chunks/hypertable-architecture/#chunk-local-indexes">update_all</a> as a solution.</p>

<h2 id="understanding-the-changes">Understanding the <code class="language-plaintext highlighter-rouge">changes</code></h2>

<p>Letâ€™s continue using the Tick model  as an example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Tick</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">acts_as_hypertable</span> <span class="o">...</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The primary key is nil, but we can get a simple record by limiting it. Probably youâ€™ll also be managing a few records that are already in the memory, so it will work fine:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">t</span> <span class="o">=</span> <span class="no">Tick</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># =&gt; #&lt;Timescaledb::Tick:0x00007fb0a77a9360 symbol: "TEST", price: 0.1234e3, time: 2022-10-18 12:56:13.409779 UTC&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, letâ€™s change the record attributes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">t</span><span class="p">.</span><span class="nf">symbol</span> <span class="o">=</span> <span class="s2">"Other"</span> <span class="c1"># =&gt; "Other"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, you can see the <a href="https://apidock.com/rails/ActiveRecord/Dirty/changes">changes</a> are being tracked on memory:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">t</span><span class="p">.</span><span class="nf">changes</span> <span class="c1"># =&gt; {"symbol"=&gt;["TEST", "Other"]}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you make more changes, theyâ€™ll continue being tracked:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">t</span><span class="p">.</span><span class="nf">price</span> <span class="o">=</span> <span class="mi">999</span> <span class="c1"># =&gt; 999</span>
<span class="n">t</span><span class="p">.</span><span class="nf">changes</span> <span class="c1"># =&gt; {"symbol"=&gt;["TEST", "Other"], "price"=&gt;[0.1234e3, 0.999e3]}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, letâ€™s rebuild hashes to use <code class="language-plaintext highlighter-rouge">before</code> and <code class="language-plaintext highlighter-rouge">after</code> the changes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">before</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">changes</span><span class="p">.</span><span class="nf">transform_values</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first</span><span class="p">)</span>
<span class="c1"># =&gt; {"symbol"=&gt;"TEST", "price"=&gt;0.1234e3}</span>
<span class="n">after</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">changes</span><span class="p">.</span><span class="nf">transform_values</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:last</span><span class="p">)</span>
<span class="c1"># =&gt; {"symbol"=&gt;"Other", "price"=&gt;0.999e3}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We still need to combine and merge the values with the
<code class="language-plaintext highlighter-rouge">attributes</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">t</span><span class="p">.</span><span class="nf">attributes</span> <span class="c1"># =&gt; {"symbol"=&gt;"Other", "price"=&gt;0.999e3, "time"=&gt;2022-10-18 12:56:13.409779 UTC}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Now, we can build a variable merging the actual attributes which the changes <code class="language-plaintext highlighter-rouge">before</code>, meaning where they came <code class="language-plaintext highlighter-rouge">from</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">from</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">attributes</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
<span class="c1"># =&gt; {"symbol"=&gt;"TEST", "price"=&gt;0.1234e3, "time"=&gt;2022-10-18 12:56:13.409779 UTC}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>And another variable merging attributes with where theyâ€™re going <code class="language-plaintext highlighter-rouge">to</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">to</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">attributes</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
<span class="c1"># =&gt; {"symbol"=&gt;"Other", "price"=&gt;0.999e3, "time"=&gt;2022-10-18 12:56:13.409779 UTC}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Indeed this is the same as <code class="language-plaintext highlighter-rouge">attributes</code>, and the <code class="language-plaintext highlighter-rouge">to</code> variable could be simply <code class="language-plaintext highlighter-rouge">t.attributes</code>, but for learning purposes, letâ€™s use the explicit mode here.</p>

<p>Now, <a href="https://apidock.com/rails/ActiveRecord/Base/update_all/class">update_all</a> can use select data-building conditions <code class="language-plaintext highlighter-rouge">from</code> the original scenario and update all <code class="language-plaintext highlighter-rouge">to</code> the new state:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="no">Tick</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">from</span><span class="p">).</span><span class="nf">update_all</span><span class="p">(</span><span class="n">to</span><span class="p">)</span> <span class="c1"># =&gt; 1</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Note that it can be expensive if you donâ€™t build the proper indices
to find the records and you have a huge dataset. Keep in mind this example is for learning purposes, and youâ€™ll need to update and adjust it to your needs if you want to use it in production.</p>

<p>Also, creating the indices will depend on how often you make updates and how fast you need to have the results up to date.</p>

<h2 id="wrapping-update_all-into-a-new-save-method">Wrapping <code class="language-plaintext highlighter-rouge">update_all</code> into a new <code class="language-plaintext highlighter-rouge">save</code> method</h2>

<p>Now, to wrap up here, letâ€™s implement the new <code class="language-plaintext highlighter-rouge">save</code> method that allows you to reuse the scenario in several models.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Tick</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="kp">nil</span>

  <span class="n">acts_as_hypertable</span> <span class="o">...</span>

  <span class="k">def</span> <span class="nf">save</span>
    <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">||</span>
       <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="ss">:primary_keys</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">primary_keys</span><span class="p">.</span><span class="nf">any?</span>

      <span class="k">return</span> <span class="k">super</span>
    <span class="k">end</span>

    <span class="n">before</span> <span class="o">=</span> <span class="n">changes</span><span class="p">.</span><span class="nf">transform_values</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first</span><span class="p">)</span>
    <span class="n">from</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">before</span><span class="p">)</span>
    <span class="n">to</span> <span class="o">=</span> <span class="n">changes</span><span class="p">.</span><span class="nf">transform_values</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:last</span><span class="p">)</span>

    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">from</span><span class="p">).</span><span class="nf">update_all</span><span class="p">(</span><span class="n">to</span><span class="p">)</span>
    <span class="n">clear_changes_information</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Note that in the first lines of the save method, thereâ€™s a clause to use
the default behavior in case the model is configured with a primary key or has a composite primary key.</p>

<p>The <code class="language-plaintext highlighter-rouge">update_all</code> doesnâ€™t run the model validations, so be careful with this
kind of usage that is highly dependent on your control. We could make the behavior precisely the same by adding an extra guard clause to <code class="language-plaintext highlighter-rouge">return unless valid?</code> at the top of the methods and ensuring it will update only validated records.</p>

<p>The only point I havenâ€™t covered is the <code class="language-plaintext highlighter-rouge">clear_changes_information</code> that cleans the <code class="language-plaintext highlighter-rouge">changes</code> attribute to track new changes in case the user
makes several changes in the same record without reloading it.</p>

<p>If you have any concerns or comments, feel free to drop me a comment on <a href="https://twitter.com/jonatasdp">Twitter</a> or reach out on
<a href="https://www.linkedin.com/in/jonatasdp/">linkedin</a>!</p>

<p>Thanks for reading.</p>


  </div>
  
  
  <div class="article-tags">
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
      <a href="#postgresql-ref" class="article-tag">postgresql</a>
    
      <a href="#timescaledb-ref" class="article-tag">timescaledb</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=ActiveRecord+update+without+primary+key&url=https%3A%2F%2Fideia.me%2Factiverecord-update-without-primary-key&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Factiverecord-update-without-primary-key" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Factiverecord-update-without-primary-key&title=ActiveRecord+update+without+primary+key" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Factiverecord-update-without-primary-key&title=ActiveRecord+update+without+primary+key" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="JÃ´natas Davi Paganini">
  <div class="author-bio-content">
    <h4>JÃ´natas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/libpq-no-such-file-load-error" title="Load error - libpq no such file">
        Load error - libpq no such file
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/hierarchical-continuous-aggregates-with-ruby" title="Hierarchical continuous aggregates with Ruby and Timescaledb">
        Hierarchical continuous aggregates with Ruby an...
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
          
            
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/my-first-contribution-to-rubygems">My First Contribution To Rubygems</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> July 04, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Adding to my goal of being helpful in the software world, I had my first contribution to RubyGems [merged][new_pr] ðŸŽ‰</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
        
        
      </div>
    </div>
  </div>
</div>
 
  <div class="comments-section card mb-4">
  <div class="card-header">
    <h4>Comments</h4>
  </div>
  <div class="card-body">
    <div id="disqus_thread"></div>
    <script>
      /**
      *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
      *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
      
      var disqus_config = function () {
        this.page.url = "https://ideia.me/activerecord-update-without-primary-key";
        this.page.identifier = "/activerecord-update-without-primary-key";
      };
      
      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://ideiame.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</div> 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">Â© 2025 JÃ´natas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.getElementById('darkModeToggle').addEventListener('change', function() {
        // Add transition class before changing mode
        document.body.classList.add('theme-transition');
        
        if (this.checked) {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
        
        // Remove transition class after transition completes
        setTimeout(() => {
          document.body.classList.remove('theme-transition');
        }, 500);
      });
      
      // Apply highlighting to code blocks after content loads
      document.addEventListener('DOMContentLoaded', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
  </body>
</html>

