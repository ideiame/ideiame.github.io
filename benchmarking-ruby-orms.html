
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</title>
    
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Immediate dark mode application to prevent flash -->
    <script>
      (function() {
        // Force dark mode for testing purposes
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.documentElement.classList.add('dark-mode');
          document.write('<style>body,html{background-color:#121212!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
        }
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- GitHub-style syntax highlighting -->
    <link href="/css/rouge-github.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/disqus-dark.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> March 19, 2025</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 17 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>, 
        
          <a href="#postgresql-ref" class="text-muted">postgresql</a>, 
        
          <a href="#performance-ref" class="text-muted">performance</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>Hey Ruby friends! This year I’m super excited to offer a PostgreSQL Performance Workshop for Rubyists. I already ran the first one at the <a href="https://rubycommunityconference.com">Ruby Community Conference</a>, and it was a blast!</p>

<p>I wanted to share some key learnings we discovered during the workshop and reflect on how our technology choices impact performance. I’m particularly interested in how we can mix technologies to keep all the conveniences Rails offers while still achieving fast execution and low memory footprint for those high-throughput bottlenecks we all struggle with.</p>

<p><img src="/images/postgresql-performance-workshop.webp" alt="Performance Workshop" title="Performance Workshop ORMs comparison" /></p>

<p>With Ruby 3.3’s impressive performance improvements and Rails 8’s focus on speed, I’ve been watching the ORM performance landscape evolve rapidly. The benchmarks I’ve been running show up to 70% faster Ruby code execution with YJIT in Ruby 3.3, but I kept wondering: how does this translate to real-world database operations? As our applications scale and data grows, choosing the right ORM strategy becomes more critical than ever.</p>

<p>In this post, I’ll dive into the latest performance differences I found between ActiveRecord and Sequel when working with TimescaleDB, a specialized PostgreSQL extension for time-series data. My benchmarks were conducted using Ruby 3.3.6 and the latest versions of both ORMs running on an Apple M4 chip, and I’ve made special efforts to ensure the comparisons are fair and accurate.</p>

<h2 id="the-orm-performance-benchmark-challenge">The ORM Performance Benchmark Challenge</h2>

<p>My no-brain choice is always ActiveRecord but for the Performance workshop, I started collecting also information from the community and decided to also build comparison between different ORMs for the workshop. Each ORM offers unique features, syntax, and performance characteristics. The benchmarks I’m sharing aim to provide insights into these performance differences to help you make informed decisions for your projects.</p>

<blockquote>
  <p><strong>UPDATE (March 21, 2025)</strong>: After receiving valuable feedback from the community (special thanks to Maurício Szabo!), I’ve updated these benchmarks to ensure the queries being compared are equivalent. This post now contains the updated results from these improved benchmarks.</p>
</blockquote>

<p>It’s important to note that these benchmarks focus purely on execution time and memory usage - they don’t account for developer productivity, which is a crucial factor when choosing an ORM. While Sequel may outperform ActiveRecord in raw speed for certain operations, ActiveRecord’s integration with Rails and familiar syntax can significantly reduce development time. The true cost of an ORM includes both execution performance and the time developers spend writing and maintaining code.</p>

<h3 id="updated-benchmark-results-march-2025">Updated Benchmark Results (March 2025)</h3>

<p>After ensuring that the SQL queries generated by both ORMs are equivalent, here are the updated benchmark results. All tests were performed on a MacBook Pro with an Apple M4 chip, running Ruby 3.3.6 with TimescaleDB 2.18 on PostgreSQL 17.2 through the timescaledb-ha docker image.</p>

<p>Here’s the full output of the benchmark, you can get the <a href="https://github.com/timescale/postgresql-performance-for-rubyists/blob/main/examples/05_ruby/03_orm_comparison.rb">orm_comparison.rb</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby 03_orm_comparison.rb
Fetching gem metadata from https://rubygems.org/.......
Resolving dependencies...
[✔] Generating sample data ... Done!

Generated:
┌──────────┬────────┐
│ Users    │ 1,000  │
│ Posts    │ 10,000 │
│ Comments │ 50,000 │
└──────────┴────────┘

=== ORM Comparison Examples (Significant Differences &gt;10%) ===
Dataset: 1000 users, 10000 posts, 50000 comments

1. Simple Query Performance (1000 users, limit: 100)
Query: WHERE created_at &lt; current_time LIMIT 100
ruby 3.3.6 (2024-11-05 revision 75015d4c1f) [arm64-darwin24]
Warming up --------------------------------------
ActiveRecord - simple query
                        34.000 i/100ms
Sequel - simple query
                       275.000 i/100ms
Calculating -------------------------------------
ActiveRecord - simple query
                        372.005 (±23.7%) i/s    (2.69 ms/i) -      1.802k in   5.038347s
Sequel - simple query
                          2.777k (± 4.6%) i/s  (360.12 μs/i) -     14.025k in   5.063636s

Comparison:
Sequel - simple query:     2776.9 i/s
ActiveRecord - simple query:      372.0 i/s - 7.46x  slower


2. Aggregation Performance (10000 posts)
Query: GROUP BY user_id HAVING COUNT(*) &gt; 5
ruby 3.3.6 (2024-11-05 revision 75015d4c1f) [arm64-darwin24]
Warming up --------------------------------------
ActiveRecord - aggregation with HAVING
                        15.000 i/100ms
Sequel - aggregation with HAVING
                        22.000 i/100ms
Calculating -------------------------------------
ActiveRecord - aggregation with HAVING
                        152.437 (± 7.9%) i/s    (6.56 ms/i) -    765.000 in   5.046387s
Sequel - aggregation with HAVING
                        208.504 (± 4.8%) i/s    (4.80 ms/i) -      1.056k in   5.075211s

Comparison:
Sequel - aggregation with HAVING:      208.5 i/s
ActiveRecord - aggregation with HAVING:      152.4 i/s - 1.37x  slower


3. Query Building Approaches (1000 users, limit: 100)
Query: Complex conditions with LIKE pattern '%test%', date range, order by created_at desc
ruby 3.3.6 (2024-11-05 revision 75015d4c1f) [arm64-darwin24]
Warming up --------------------------------------
ActiveRecord - method chain
                       234.000 i/100ms
Sequel - method chain
                       252.000 i/100ms
Calculating -------------------------------------
ActiveRecord - method chain
                          2.221k (± 6.0%) i/s  (450.22 μs/i) -     11.232k in   5.075242s
Sequel - method chain
                          2.449k (± 2.8%) i/s  (408.39 μs/i) -     12.348k in   5.046805s

Comparison:
Sequel - method chain:     2448.7 i/s
ActiveRecord - method chain:     2221.2 i/s - 1.10x  slower
</code></pre></div></div>

<p>Ok, now let’s go case by case and check what’s going on.</p>

<h4 id="simple-queries-performance">Simple Queries Performance</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="c1"># Using proper warmup and measurement times for stability</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">2</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - simple query"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - simple query"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">where</span><span class="p">(</span><span class="no">Sequel</span><span class="p">.</span><span class="nf">lit</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results:</strong></p>

<table>
  <thead>
    <tr>
      <th>Implementation</th>
      <th>Performance (i/s)</th>
      <th>Comparison</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Sequel</td>
      <td>2,774.5 i/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>ActiveRecord</td>
      <td>417.0 i/s</td>
      <td>6.65x slower</td>
    </tr>
  </tbody>
</table>

<h4 id="complex-join-performance">Complex Join Performance</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">2</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - complex join"</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># Both queries select the same columns and use the same GROUP BY</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">posts: :comments</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'users.id, users.name, COUNT(DISTINCT posts.id) as posts_count, COUNT(comments.id) as comments_count'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s1">'users.id, users.name'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - complex join"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
      <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="ss">:posts</span><span class="p">,</span> <span class="ss">user_id: :id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="ss">:comments</span><span class="p">,</span> <span class="ss">post_id: </span><span class="no">Sequel</span><span class="p">[</span><span class="ss">:posts</span><span class="p">][</span><span class="ss">:id</span><span class="p">])</span>
      <span class="p">.</span><span class="nf">select</span><span class="p">(</span>
        <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:id</span><span class="p">],</span>
        <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:name</span><span class="p">],</span>
        <span class="no">Sequel</span><span class="p">.</span><span class="nf">lit</span><span class="p">(</span><span class="s1">'COUNT(DISTINCT posts.id) as posts_count'</span><span class="p">),</span>
        <span class="no">Sequel</span><span class="p">.</span><span class="nf">function</span><span class="p">(</span><span class="ss">:count</span><span class="p">,</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:comments</span><span class="p">][</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">as</span><span class="p">(</span><span class="ss">:comments_count</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:id</span><span class="p">],</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:name</span><span class="p">])</span>
      <span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results:</strong></p>

<table>
  <thead>
    <tr>
      <th>Implementation</th>
      <th>Performance (i/s)</th>
      <th>Comparison</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Sequel</td>
      <td>62.9 i/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>ActiveRecord</td>
      <td>60.3 i/s</td>
      <td>1.04x slower</td>
    </tr>
  </tbody>
</table>

<h4 id="aggregation-performance">Aggregation Performance</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">2</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - aggregation with HAVING"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Post</span><span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'user_id, COUNT(*) as posts_count, AVG(LENGTH(content)) as avg_content_length'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">having</span><span class="p">(</span><span class="s1">'COUNT(*) &gt; 5'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - aggregation with HAVING"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:posts</span><span class="p">]</span>
      <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">select_append</span> <span class="p">{</span> <span class="p">[</span>
        <span class="n">count</span><span class="p">(</span><span class="nb">id</span><span class="p">).</span><span class="nf">as</span><span class="p">(</span><span class="ss">:posts_count</span><span class="p">),</span>
        <span class="n">avg</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">content</span><span class="p">)).</span><span class="nf">as</span><span class="p">(</span><span class="ss">:avg_content_length</span><span class="p">)</span>
      <span class="p">]</span> <span class="p">}</span>
      <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="ss">:user_id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">having</span> <span class="p">{</span> <span class="n">count</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="p">}</span>
      <span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results:</strong></p>

<table>
  <thead>
    <tr>
      <th>Implementation</th>
      <th>Performance (i/s)</th>
      <th>Comparison</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Sequel</td>
      <td>211.7 i/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>ActiveRecord</td>
      <td>154.0 i/s</td>
      <td>1.38x slower</td>
    </tr>
  </tbody>
</table>

<h4 id="bulk-update-performance">Bulk Update Performance</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">2</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - bulk update"</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># Update all users who were created before now</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">updated_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - bulk update"</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># Sequel doesn't support updates with limit, so we use a different approach</span>
    <span class="c1"># First get the ids of 100 users</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="no">Sequel</span><span class="p">.</span><span class="nf">lit</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">))</span>
      <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
    
    <span class="c1"># Then update those specific users</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">id: </span><span class="n">ids</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">updated_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results from previous run:</strong></p>

<table>
  <thead>
    <tr>
      <th>Implementation</th>
      <th>Performance (i/s)</th>
      <th>Comparison</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ActiveRecord</td>
      <td>1,643.7 i/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>Sequel</td>
      <td>1,474.6 i/s</td>
      <td>1.11x slower</td>
    </tr>
  </tbody>
</table>

<h3 id="memory-usage-patterns-mb">Memory Usage Patterns (MB)</h3>

<table>
  <thead>
    <tr>
      <th>Operation Type</th>
      <th>ActiveRecord</th>
      <th>Sequel</th>
      <th>Key Insights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Large Result Set</td>
      <td>125</td>
      <td>45</td>
      <td>ActiveRecord objects consume ~2.8x more memory than Sequel</td>
    </tr>
    <tr>
      <td>Batch Processing</td>
      <td>60</td>
      <td>35</td>
      <td>Using <code class="language-plaintext highlighter-rouge">find_each</code> with ActiveRecord helps control memory usage</td>
    </tr>
    <tr>
      <td>JSON Processing</td>
      <td>80</td>
      <td>50</td>
      <td>JSONB is more memory-efficient than standard JSON</td>
    </tr>
    <tr>
      <td>Aggregations</td>
      <td>40</td>
      <td>35</td>
      <td>Memory patterns are similar for aggregation operations</td>
    </tr>
  </tbody>
</table>

<h2 id="key-findings-from-the-updated-benchmarks">Key Findings from the Updated Benchmarks</h2>

<p>Before diving into the detailed results, I want to share some revised insights from my benchmarking study. These findings represent patterns I observed across multiple test scenarios with properly equivalent queries and adequate warmup periods.</p>

<p><img src="/images/jonatas-paganini-jeremy-evans-polished-ruby-book-rubyconf-thailand-2023.jpeg" alt="Jeremy Evans and I discussing Ruby performance at RubyConf Thailand" title="Meeting with Jeremy Evans, the creator of Sequel, at RubyConf Thailand 2023" /></p>

<p>I had the incredible privilege of meeting Jeremy Evans (that’s us in the photo above), the creator of Sequel and author of “Polished Ruby Programming,” at RubyConf Thailand 2023. His insights have been invaluable in helping me understand the design decisions that make Sequel so performant in many scenarios.</p>

<p>Jeremy recently <a href="https://x.com/jeremyevans0/status/1902733224574693528">shared some valuable insights on Twitter</a> about why Sequel performs so well:</p>

<blockquote>
  <p>Sequel does not use async queries, it has a lot of optimizations and a more efficient design. Some of the Sequel examples shown in the blog post could be tuned even further (where/cond.all-&gt;where_all/cond), storing static intermediate datasets instead of rebuilding them)</p>
</blockquote>

<p>This confirms what my benchmarks revealed - Sequel’s design emphasizes efficiency and optimization at every level, from query building to execution.</p>

<p>My updated benchmarks revealed several consistent patterns:</p>

<ol>
  <li>
    <p><strong>Sequel still excels at raw speed for simple queries</strong> - For basic CRUD operations with properly warmed-up benchmarks, Sequel consistently outperforms ActiveRecord by 6-7x for simple selects, though this is less dramatic than my initial tests showed.</p>
  </li>
  <li>
    <p><strong>With equivalent complex queries, the performance gap narrows dramatically</strong> - When comparing truly equivalent complex joins and aggregations, the performance difference is much smaller than I initially reported (1.04-1.38x).</p>
  </li>
  <li>
    <p><strong>ActiveRecord leads in bulk updates</strong> - ActiveRecord appears to have better optimizations for bulk update operations, showing about a 11% performance advantage over Sequel in this specific use case.</p>
  </li>
  <li>
    <p><strong>Proper benchmark methodology is crucial</strong> - Using adequate warmup periods (2+ seconds) and multiple runs produces much more stable and reliable results than quick benchmarks.</p>
  </li>
  <li>
    <p><strong>Memory usage remains a significant differentiator</strong> - In high-throughput applications, memory consumption frequently becomes the bottleneck before query speed, making lightweight ORMs particularly valuable.</p>
  </li>
</ol>

<p>Let’s examine these findings in more detail with some additional benchmark results:</p>

<h3 id="batch-processing-comparison">Batch Processing Comparison</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Benchmark setup</span>
<span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">30000</span><span class="p">)</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="c1"># Processing all records at once</span>
  <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="p">.</span><span class="nf">touch</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="c1"># Using find_each with default batch size</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">30000</span><span class="p">).</span><span class="nf">find_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">user</span><span class="p">.</span><span class="nf">touch</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="k">do</span>
  <span class="c1"># Using update_all</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">30000</span><span class="p">).</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">updated_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results:</strong>
|  Operation                              |    Time  | Queries |     Rate  | Relative Speed |
|—————————————–|———-|———|———–|—————-|
| Processing all records at once          | 10.342 s | 30,001  |   2.9k/s  | baseline       |
| Using find_each with default batch size |  9.657 s | 30,031  |   3.1k/s  | 1.1x faster    |
| Using update_all                        |  0.282 s |      1  | 106.4k/s  | 36.6x faster   |</p>

<p>The results are clear: bulk operations like <code class="language-plaintext highlighter-rouge">update_all</code> are dramatically faster (36.6x) but bypass ActiveRecord callbacks and validations. I’ve found this represents a common trade-off I need to make between performance and application logic. Sometimes I choose performance, sometimes I need those callbacks!</p>

<h3 id="multiple-runs-for-stability">Multiple Runs for Stability</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Run </span><span class="si">#{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/3:"</span>
  <span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
    <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">2</span><span class="p">)</span>

    <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - simple query"</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">to_a</span>
    <span class="k">end</span>

    <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - simple query"</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">where</span><span class="p">(</span><span class="no">Sequel</span><span class="p">.</span><span class="nf">lit</span><span class="p">(</span><span class="s2">"created_at &lt; ?"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nf">all</span>
    <span class="k">end</span>

    <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results:</strong>
| Run | ActiveRecord | Sequel | Difference |
|—–|————–|——–|————|
| 1 | 414.1 i/s | 2,823.8 i/s | 6.82x faster |
| 2 | 405.2 i/s | 2,739.4 i/s | 6.76x faster |
| 3 | 431.8 i/s | 2,760.3 i/s | 6.39x faster |</p>

<p>This demonstrates that with proper warmup periods, benchmark results become more stable across runs, providing more reliable data for decision-making.</p>

<h2 id="memory-optimization-with-occamsrecord">Memory Optimization with OccamsRecord</h2>

<p>One of the most impressive optimizations I’ve found for memory usage is OccamsRecord:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Standard ActiveRecord</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">memory</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord with associations"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">users_data</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="p">{</span>
        <span class="ss">name: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
        <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
        <span class="ss">post_count: </span><span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span>
      <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"OccamsRecord"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">users_data</span> <span class="o">=</span> <span class="no">OccamsRecord</span>
      <span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">run</span>
      <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="p">{</span>
        <span class="ss">name: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
        <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
        <span class="ss">post_count: </span><span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span>
      <span class="p">}}</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p><strong>Results:</strong>
| Implementation | Memory Allocated | Memory Retained |
|—————-|——————|—————–|
| ActiveRecord with associations | 27.30 MB | 68.34 KB |
| OccamsRecord | 16.03 MB | 16.30 KB |</p>

<p>This is a dramatic improvement in memory usage - OccamsRecord uses 41% less allocated memory and 76% less retained memory compared to standard ActiveRecord!</p>

<h2 id="best-practices-for-orm-performance">Best Practices for ORM Performance</h2>

<p>Based on my updated benchmarks, I’ve revised some best practices for optimizing ORM performance:</p>

<h3 id="1-ensure-benchmark-accuracy">1. Ensure Benchmark Accuracy</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Poor benchmark methodology</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">1</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mf">0.5</span><span class="p">)</span>
  <span class="c1"># This will produce unstable results...</span>
<span class="k">end</span>

<span class="c1"># Better benchmark methodology </span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">2</span><span class="p">)</span>
  <span class="c1"># This provides more stable and realistic results</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="2-compare-equivalent-queries">2. Compare Equivalent Queries</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inequivalent queries lead to misleading comparisons</span>
<span class="no">ActiveRecord</span><span class="p">:</span> <span class="no">User</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'*'</span><span class="p">).</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s1">'users.id'</span><span class="p">)</span>  
<span class="no">Sequel</span><span class="p">:</span> <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">join</span><span class="p">(</span><span class="ss">:posts</span><span class="p">,</span> <span class="ss">user_id: :id</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="ss">:name</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>

<span class="c1"># Equivalent queries for fair comparison</span>
<span class="no">ActiveRecord</span><span class="p">:</span> <span class="no">User</span><span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'users.id, users.name'</span><span class="p">).</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">group</span><span class="p">(</span><span class="s1">'users.id, users.name'</span><span class="p">)</span>
<span class="no">Sequel</span><span class="p">:</span> <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">join</span><span class="p">(</span><span class="ss">:posts</span><span class="p">,</span> <span class="ss">user_id: :id</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:id</span><span class="p">],</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:name</span><span class="p">]).</span><span class="nf">group</span><span class="p">(</span><span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:id</span><span class="p">],</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:name</span><span class="p">])</span>
</code></pre></div></div>

<h3 id="3-use-index-friendly-query-patterns">3. Use Index-Friendly Query Patterns</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Poor index usage (can't use index on name column)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"name LIKE ?"</span><span class="p">,</span> <span class="s2">"%smith%"</span><span class="p">)</span>

<span class="c1"># Better index usage (can use index on name column)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"name LIKE ?"</span><span class="p">,</span> <span class="s2">"smith%"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="4-batch-processing">4. Batch Processing</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inefficient</span>
<span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">status: </span><span class="s1">'active'</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># Efficient (36x faster)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">status: </span><span class="s1">'active'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="join-me-for-postgresql-performance-optimization-at-tropical-on-rails-2025">Join Me for PostgreSQL Performance Optimization at Tropical on Rails 2025!</h2>

<p>Want to dive deeper into these concepts and learn how to optimize your Ruby applications with PostgreSQL? Come hang out with me at my upcoming <strong>PostgreSQL Performance for Ruby Developers</strong> workshop at Tropical on Rails 2025!</p>

<p>The workshop is based on our PostgreSQL Performance course, which has helped hundreds of developers optimize their database interactions and improve application performance. I’ve refined it based on feedback from previous sessions.</p>

<h3 id="workshop-details">Workshop Details:</h3>
<ul>
  <li><strong>When</strong>: April 2nd, 2025 -  2 PM to 6 PM</li>
  <li><strong>Language</strong>: English</li>
  <li><strong>Location</strong>: São Paulo, Brazil</li>
</ul>

<p><a href="https://www.tropicalonrails.com/#workshops"><img src="/images/banners/tropicalonrails-2025-banner.png" alt="Tropical On Rails Banner" /></a></p>

<p><a href="https://www.tropicalonrails.com/#workshops">Register for the workshop</a></p>

<h2 id="my-updated-conclusions">My Updated Conclusions</h2>

<p>After addressing the feedback from the community and running more accurate benchmarks, my conclusions have evolved. The choice between ActiveRecord and Sequel isn’t as clear-cut as my initial benchmarks suggested. While Sequel still generally offers better raw performance for simple queries, the gap is much smaller for complex operations when comparing equivalent queries.</p>

<p>Here’s what I consider when choosing an ORM:</p>
<ol>
  <li>I use Sequel for performance-critical, simple data operations where raw speed matters</li>
  <li>I stick with ActiveRecord for standard CRUD and Rails integration</li>
  <li>Sometimes I use both in the same application where appropriate (yes, this works!)</li>
  <li>I always profile my specific use case with equivalent queries before committing to an ORM</li>
  <li>I use bulk operations whenever possible for better performance</li>
</ol>

<p>Remember that the best ORM for your application depends on your specific requirements and constraints. My updated benchmarks provide a more realistic starting point for your decision-making process, but your mileage may vary based on your specific architecture and usage patterns.</p>

<p>What’s your experience with ORM performance? I’d love to hear your thoughts in the comments. And if you’re interested in diving deeper, join me at Tropical on Rails 2025 to continue the conversation!</p>

<h2 id="resources">Resources</h2>

<ol>
  <li><a href="https://github.com/timescale/timescaledb-ruby">TimescaleDB Ruby Gem</a></li>
  <li><a href="https://github.com/timescale/postgresql-performance-for-rubyists">PostgreSQL Performance Workshop for Rubyists</a></li>
  <li><a href="https://github.com/jeremyevans/sequel">Sequel Documentation</a></li>
  <li><a href="https://guides.rubyonrails.org/active_record_querying.html">ActiveRecord Query Interface</a></li>
  <li><a href="https://github.com/jhollinger/occams-record">OccamsRecord</a></li>
  <li><a href="https://github.com/evanphx/benchmark-ips">Benchmark-ips Gem</a></li>
  <li><a href="https://pragprog.com/titles/adrpo/ruby-performance-optimization/">Ruby Performance Optimization Book</a></li>
  <li><a href="https://www.manning.com/books/polished-ruby-programming">Polished Ruby Programming by Jeremy Evans</a></li>
</ol>

<h2 id="take-your-postgresql-performance-to-the-next-level">Take Your PostgreSQL Performance to the Next Level!</h2>

<p>Looking for even more dramatic performance improvements in your Ruby + PostgreSQL applications? Check out the <a href="https://github.com/timescale/timescaledb-ruby">timescaledb gem</a> that I maintain! This powerful extension enables time-series data optimization, hypertables, and advanced query capabilities that can deliver 10-100x performance gains for time-series workloads.</p>

<p>As a maintainer, I’ve seen teams transform their application performance with minimal code changes. Drop me a message if you have questions or need implementation advice - I love helping people optimize their database performance!</p>

<p>👉 <strong><a href="https://github.com/timescale/timescaledb-ruby">Get started with TimescaleDB for Ruby today!</a></strong></p>

  </div>
  
  
  <div class="article-tags">
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
      <a href="#postgresql-ref" class="article-tag">postgresql</a>
    
      <a href="#performance-ref" class="article-tag">performance</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Benchmarking+Ruby+ORMs%3A+ActiveRecord+vs+Sequel+Performance+with+TimescaleDB&url=https%3A%2F%2Fideia.me%2Fbenchmarking-ruby-orms&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fbenchmarking-ruby-orms" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fbenchmarking-ruby-orms&title=Benchmarking+Ruby+ORMs%3A+ActiveRecord+vs+Sequel+Performance+with+TimescaleDB" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fbenchmarking-ruby-orms&title=Benchmarking+Ruby+ORMs%3A+ActiveRecord+vs+Sequel+Performance+with+TimescaleDB" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/programming-is-a-drug" title="Programming is a Drug: How AI Amplified My 20-Year Coding Addiction">
        Programming is a Drug: How AI Amplified My 20-Y...
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/tech-community-universities-building-mindful-partnerships" title="Tech Community and Universities: Building Mindful Partnerships">
        Tech Community and Universities: Building Mindf...
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
            
        
        
        
        
        
          
            
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/tropical-on-rails-2025-a-celebration-of-ruby-community">Tropical on Rails 2025: A Celebration of the Ruby Community</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> April 09, 2025
                        </small>
                      </p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/my-first-contribution-to-rubygems">My First Contribution To Rubygems</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> July 04, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Adding to my goal of being helpful in the software world, I had my first contribution to RubyGems [merged][new_pr] 🎉</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
        
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread" class="comments-section"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/benchmarking-ruby-orms';
    this.page.identifier = '/benchmarking-ruby-orms';
    
    // Handle dark mode for Disqus
    const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                        document.body.classList.contains('dark-mode') || 
                        window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (isDarkMode) {
      // Enable dark mode for Disqus
      this.page.functions = [];
      this.callbacks = {
        onReady: [function() {
          // Message the iframe to apply dark theme once loaded
          const message = {
            name: 'theme',
            data: {
              theme: 'dark'
            }
          };
          
          // Try to send the message multiple times as Disqus can load slowly
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 2000);
          
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 4000);
        }]
      };
    }
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    
    // Add dark styling for container
    if (document.documentElement.classList.contains('dark-mode') || 
        document.body.classList.contains('dark-mode') || 
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // Style the container immediately
      const style = document.createElement('style');
      style.textContent = `
        #disqus_thread {
          background-color: #1e1e1e !important;
          color: #f0f2f5 !important;
          padding: 20px;
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          margin-top: 30px;
          margin-bottom: 30px;
        }
        
        iframe {
          background-color: #1e1e1e !important;
          color-scheme: dark !important;
        }
        
        /* Force the iframe document to use dark mode */
        iframe[src*="disqus.com"] {
          color-scheme: dark !important;
          filter: invert(90%) hue-rotate(180deg) !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="/css/disable-line-numbers.css">
<script src="/js/disable-line-numbers.js"></script>


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.documentElement.classList.add('dark-mode');
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
              console.log('Dark mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            } else {
              document.documentElement.classList.remove('dark-mode');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
              console.log('Light mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            }
            
            // Force reload the page to ensure all styles are applied correctly
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
        }
        
        // Apply highlighting to code blocks after content loads
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Configure Disqus for dark mode if needed
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        if (isDarkMode) {
          // Insert dark mode CSS for Disqus
          const style = document.createElement('style');
          style.innerHTML = `
            #disqus_thread {
              background-color: #1e1e1e !important;
              color: #f0f2f5 !important;
              padding: 20px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            }
          `;
          document.head.appendChild(style);
          
          // Set Disqus config variable for dark mode
          window.disqus_config = function() {
            this.page.identifier = window.location.pathname;
            this.page.url = window.location.href;
            this.language = 'en';
            this.sso = {
              name: 'SiteName',
            };
            this.callbacks.onReady = [function() {
              const interval = setInterval(function() {
                if (document.getElementById('dsq-app2')) {
                  clearInterval(interval);
                  const disqusIframe = document.getElementById('dsq-app2');
                  disqusIframe.contentWindow.postMessage({
                    name: 'setTheme',
                    data: 'dark',
                  }, '*');
                }
              }, 100);
            }];
          };
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
    
    <!-- Disqus Dark Mode Handler -->
    <script>
      // Function to handle Disqus dark mode
      function setupDisqusDarkMode() {
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        // Add a style element to target the Disqus iframe
        const disqusStyle = document.createElement('style');
        disqusStyle.innerHTML = `
          html.dark-mode iframe, body.dark-mode iframe {
            color-scheme: dark !important;
          }
          
          html.dark-mode #disqus_thread, body.dark-mode #disqus_thread {
            background-color: #1e1e1e !important;
            color: #f0f2f5 !important;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        `;
        document.head.appendChild(disqusStyle);
        
        // Check for Disqus iframe and inject dark styles if needed
        const checkForDisqus = setInterval(() => {
          const disqusThread = document.getElementById('disqus_thread');
          const disqusIframes = document.querySelectorAll('iframe[src*="disqus.com"]');
          
          if (disqusThread || disqusIframes.length > 0) {
            clearInterval(checkForDisqus);
            
            if (isDarkMode) {
              // Try to signal Disqus to use dark theme
              if (window.DISQUS) {
                try {
                  window.DISQUS.host._loadEmbed({
                    color: 'dark',
                  });
                } catch (e) {
                  console.log('Could not set Disqus theme via API');
                }
              }
              
              // Direct CSS approach to all iframes
              disqusIframes.forEach(iframe => {
                try {
                  // Try to access the iframe document
                  const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                  
                  // Add dark mode classes and styles
                  if (iframeDocument.body) {
                    iframeDocument.body.classList.add('dark-mode');
                    
                    const darkStyle = iframeDocument.createElement('style');
                    darkStyle.textContent = `
                      body { background-color: #1e1e1e !important; color: #f0f2f5 !important; }
                      .textarea-wrapper, .post-actions, .alert { background-color: #2a2d31 !important; }
                      .wysiwyg__placeholder, input, textarea { color: #f0f2f5 !important; }
                      .publisher-background-color { background-color: #1e1e1e !important; }
                      .publisher-border-color { border-color: rgba(255, 255, 255, 0.1) !important; }
                      .publisher-anchor-color, a { color: #5c9eff !important; }
                    `;
                    iframeDocument.head.appendChild(darkStyle);
                  }
                } catch (e) {
                  console.log('Could not modify Disqus iframe due to CORS policy');
                  
                  // Add a fallback with filter approach
                  if (isDarkMode) {
                    // Apply a CSS filter to invert the colors
                    iframe.style.filter = 'invert(92%) hue-rotate(180deg)';
                  }
                }
              });
            }
          }
        }, 500);
      }
      
      // Run setup when DOM is loaded and after any content changes
      document.addEventListener('DOMContentLoaded', setupDisqusDarkMode);
      document.addEventListener('ajaxComplete', setupDisqusDarkMode);
      
      // Also run after a delay in case Disqus loads later
      setTimeout(setupDisqusDarkMode, 2000);
      setTimeout(setupDisqusDarkMode, 5000);
    </script>
    
    <!-- Dedicated Disqus dark mode handler -->
    <script src="/js/disqus-dark.js"></script>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        // Check saved preference first
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Apply theme based on saved preference or system preference
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
          console.log('Dark mode applied on initial load');
        } else {
          document.body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
          console.log('Light mode applied on initial load');
        }
        
        // Listen for changes in the OS color scheme only if no saved preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          // Only apply system preference if user hasn't manually chosen a theme
          if (localStorage.getItem('theme') === null) {
            const newColorScheme = e.matches ? 'dark' : 'light';
            if (newColorScheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.documentElement.classList.add('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = true;
              console.log('Dark mode applied from system preference change');
            } else {
              document.body.classList.remove('dark-mode');
              document.documentElement.classList.remove('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = false;
              console.log('Light mode applied from system preference change');
            }
          }
        });
      }

      // Initialize dark mode immediately before DOM content is fully loaded
      detectColorScheme();
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
      });
    </script>
  </body>
</html>

