
<!DOCTYPE html>
<html lang="en" class="dark-mode">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Hierarchical continuous aggregates with Ruby and Timescaledb</title>
    <meta name="description" content="Today I'm very happy to share that a new version of the [timescaledb gem][gem-repo] is available. It's compatible with TimescaleDB 2.9 and the objective of t...">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Always use dark mode -->
    <script>
      (function() {
        document.documentElement.classList.add('dark-mode');
        document.write('<style>body,html{background-color:#0c0c0c!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JetBrains Mono and other developer fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    <!-- Site styles -->
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/modern-theme.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/modern-effects.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body class="dark-mode">
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Geometric background pattern -->
    <div class="geometric-bg"></div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <span class="logo">
            <span class="i">i</span>
            <span class="d">d</span>
            <span class="e">e</span>
            <span class="i2">i</span>
            <span class="a">a</span>
            <span class="dot">.</span>
            <span class="m">m</span>
            <span class="e2">e</span>
          </span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              </a>
              <ul class="dropdown-menu shadow-sm glass-card" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Hierarchical continuous aggregates with Ruby and Timescaledb
          </div>
          
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> February 04, 2023</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 21 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>Today I’m very happy to share that a new version of the <a href="https://github.com/jonatas/timescaledb">timescaledb gem</a>
is available. It’s compatible with TimescaleDB 2.9 and the objective of this
post is exemplify how to use <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/hierarchical-continuous-aggregates/">hierarchical continuous aggregates</a>.</p>

<p>I already brought posts about how to use <a href="/using-the-timescale-gem-with-ruby">timescale with ruby</a>
and and how to create a <a href="/timescale-continuous-aggregates-with-ruby">timescale continuous aggregates with ruby</a>.</p>

<p>Yes! it’s finally available and here is a small definition which can help you to
imagine a scenario that it would be useful!</p>

<blockquote>
  <p>You can create continuous aggregates on top of other continuous aggregates.
This allows you to summarize data at different granularities. For example,
you might have an hourly continuous aggregate that summarizes
minute-by-minute data. To get a daily summary, you can create a new
continuous aggregate on top of your hourly aggregate.
This is more efficient than creating the daily aggregate on top of the
original hypertable, because you can reuse the calculations from the hourly
aggregate.
This feature is available in TimescaleDB 2.9 and above.</p>
</blockquote>

<p>Continuous aggregates are materialized views persisted as hypertables which make
them have faster inserts.</p>

<p>I published originally this content originally on the
<a href="https://jonatas.github.io/timescaledb/toolkit_candlestick/">candlestick tutorial</a>, and I decide to post it here as
it’s all my content and I’m very excited about this new feature. The content
there is more complete and goes beyond even exploring a simple sinatra app to
<a href="https://jonatas.github.io/timescaledb/toolkit_candlestick/#plotting-data">plot the candlesticks</a> in a web application.</p>

<p>In this tutorial, we’re going to collect tick data from financial markets using
timescaledb hypertables and aggregate the data into candlesticks, being able to
access the open, high, low, close, volume (OHLCV) of every timeframe we want to
track.</p>

<p>We’ll be using the <a href="https://github.com/timescale/timescaledb-toolkit">toolkit extension</a> and the
<a href="https://docs.timescale.com/api/latest/hyperfunctions/financial-analysis/candlestick_agg/">candlestick_agg</a> to process the candlestick data grouped by
minute, hour and day periods.</p>

<p>So, instead of processing the raw data, to compute the hour candlestick, it’s
only necessary to merge the 60 candlesticks based on the minutes of that hour.
The same is applicable from hours to days.</p>

<p>It saves a lot of processing cycles and it’s very easy to maintain.</p>

<h2 id="candlesticks">Candlesticks</h2>

<p>Candlesticks are a popular tool in technical analysis, used by traders to determine
potential market movements.</p>

<p>The <a href="https://github.com/timescale/timescaledb-toolkit">toolkit</a> also allows you to compute candlesticks with the
<a href="https://docs.timescale.com/api/latest/hyperfunctions/financial-analysis/candlestick_agg/">candlestick_agg</a> function.</p>

<p>Candlesticks are a type of price chart that displays the high, low, open, and
close prices of a security for a specific period. They can be useful because
they can provide information about market trends and reversals. For example,
if you see that the stock has been trading in a range for a while, it may be
worth considering buying or selling when the price moves outside of this range.
Additionally, candlesticks can be used in conjunction with other technical
indicators to make trading decisions.</p>

<p>Let’s start defining a table that stores the trades from financial market data
and then we can calculate the candlesticks with the Timescaledb Toolkit.</p>

<h2 id="storing-your-market-data">Storing your market data</h2>

<p>Market data is generally a massive data events stream. You can watch multiple
stock transactions globabally and receive trading, bidding and asking events.</p>

<p>Events happen in time, and it makes them timeseries data, which makes it a
perfect scenario to adopt hypertables.</p>

<p>The most granular data of trading events from market data is generally called tick.
Tick represents a single trade of something at a point in time. The tick
contains the necessary attributes of a deal in the financial markets.</p>

<p>The most simplified version of a tick is represented by:</p>

<ul>
  <li>a <strong>time</strong> which the transaction happened.</li>
  <li>a <strong>symbol</strong> which generally is the stock name.</li>
  <li>a <strong>price</strong> representing the unit price of any stock.</li>
  <li>a <strong>volume</strong> representing the amount of stocks being traded.</li>
</ul>

<p>Let’s create the hypertable to store this information using the <code class="language-plaintext highlighter-rouge">create_table</code>
method from ActiveRecord API.</p>

<h2 id="create-the-hypertable">Create the hypertable</h2>

<p>We’ll call <code class="language-plaintext highlighter-rouge">ticks</code> the hypertable name to store the market data.</p>

<p>The strategy will be the following:</p>

<ul>
  <li>Partition the data into a week interval chunks. So, it means that every new week
a new partition depending on the <strong>time</strong> column.</li>
  <li>Compress the data after a month to save storage.</li>
  <li>Remove the raw data after six months and just leave the aggregated data for
longer time.</li>
</ul>

<p>Ticks are massive. They can reach milions of events per day. That’s why it’s
important to have a compression policy since day one. Compressing data is a key
timescaledb feature. It can be done automatically and every chunk can be
compressed after a desired period. Timescaledb has an excellent compression
ratio for market data and you can easily reach 95% savings on storage by
adopting compression.</p>

<p>The timescaledb gem adds the <code class="language-plaintext highlighter-rouge">hypertable</code> keyword to the <code class="language-plaintext highlighter-rouge">create_table</code> method,
which allows you to specify anything related to the hypertable.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>
  <span class="n">hypertable_options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">time_column: </span><span class="s1">'time'</span><span class="p">,</span>
    <span class="ss">chunk_time_interval: </span><span class="s1">'1 week'</span><span class="p">,</span>
    <span class="ss">compress_segmentby: </span><span class="s1">'symbol'</span><span class="p">,</span>
    <span class="ss">compress_orderby: </span><span class="s1">'time'</span><span class="p">,</span>
    <span class="ss">compression_interval: </span><span class="s1">'1 month'</span>
  <span class="p">}</span>
  <span class="n">create_table</span> <span class="ss">:ticks</span><span class="p">,</span> <span class="ss">hypertable: </span><span class="n">hypertable_options</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">timestamp</span> <span class="ss">:time</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:symbol</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:price</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">decimal</span> <span class="ss">:volume</span>
  <span class="k">end</span>

  <span class="n">add_index</span> <span class="ss">:ticks</span><span class="p">,</span> <span class="p">[</span><span class="ss">:time</span><span class="p">,</span> <span class="ss">:symbol</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that the previous command is a standard <code class="language-plaintext highlighter-rouge">create_table</code> method call. The
timescaledb gem is just adding the <code class="language-plaintext highlighter-rouge">hypertable</code> keyword which allows to
configure everything in the same point.</p>

<p>In this case, we have the following commands being executed behind the scenes:</p>

<ol>
  <li>Create the standard table</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"ticks"</span> <span class="p">(</span>
  <span class="nv">"time"</span> <span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span><span class="p">,</span>
  <span class="nv">"symbol"</span> <span class="nb">text</span><span class="p">,</span>
  <span class="nv">"price"</span> <span class="nb">decimal</span><span class="p">,</span>
  <span class="nv">"volume"</span> <span class="nb">float</span><span class="p">);</span>
</code></pre></div></div>

<ol>
  <li>Convert it to a hypertable with <code class="language-plaintext highlighter-rouge">chunk_time_interval</code> of <strong>1 week</strong>.</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">create_hypertable</span><span class="p">(</span><span class="s1">'ticks'</span><span class="p">,</span> <span class="s1">'time'</span><span class="p">,</span> <span class="n">chunk_time_interval</span> <span class="o">=&gt;</span> <span class="n">INTERVAL</span> <span class="s1">'1 week'</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>The compression is enabled and configured in the hypertable.</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">ticks</span> <span class="k">SET</span> <span class="p">(</span>
  <span class="n">timescaledb</span><span class="p">.</span><span class="n">compress</span><span class="p">,</span>
  <span class="n">timescaledb</span><span class="p">.</span><span class="n">compress_orderby</span> <span class="o">=</span> <span class="s1">'time'</span><span class="p">,</span>
  <span class="n">timescaledb</span><span class="p">.</span><span class="n">compress_segmentby</span> <span class="o">=</span> <span class="s1">'symbol'</span>
<span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>Index by time and symbol</li>
</ol>

<p>It will be high used the combination of time and symbol. It’s good to have a
symbol. The <code class="language-plaintext highlighter-rouge">create_index</code> is the last call and it will make common queries run
faster.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="nv">"index_ticks_on_time_and_symbol"</span> <span class="k">ON</span> <span class="nv">"ticks"</span> <span class="p">(</span><span class="nv">"time"</span><span class="p">,</span> <span class="nv">"symbol"</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>Add the compression policy to compress data after a month</li>
</ol>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">add_compression_policy</span><span class="p">(</span><span class="s1">'ticks'</span><span class="p">,</span> <span class="n">INTERVAL</span> <span class="s1">'1 month'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="create-the-orm-model">Create the ORM model</h2>

<p>To define the model, we’re going to inherit <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>
to create a model.</p>

<p>Timeseries data will always require the time column and the primary key can be
discarded. A few default methods will not work if they depend on the if of the
object.</p>

<p>The model is the best place to describe how you’ll be using the timescaledb to
keep your model DRY and consistent.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Tick</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">acts_as_hypertable</span> <span class="ss">time_column: :time</span>
  <span class="n">acts_as_time_vector</span> <span class="ss">value_column: :price</span><span class="p">,</span> <span class="ss">segment_by: :symbol</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">acts_as_hypertable</code> macro will assume the actual model corresponds to a
hypertable and inject useful scopes and methods that can be wrapping to the
following TimescaleDB features:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">.hypertable</code> will give you access to the [hypertable][hypertable] domain,
the <code class="language-plaintext highlighter-rouge">table_name</code> will be used to get all metadata from the
<code class="language-plaintext highlighter-rouge">_timescaledb_catalog</code> and combine all the functions that receives a 
hypertable_name as a parameter.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">time_column</code> keyword argument will be used to build scopes like
<code class="language-plaintext highlighter-rouge">.yesterday</code>, <code class="language-plaintext highlighter-rouge">.previous_week</code>, <code class="language-plaintext highlighter-rouge">.last_hour</code>. And can be used for your own
scopes using the <code class="language-plaintext highlighter-rouge">time_column</code> metadata.</p>
  </li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">acts_as_time_vector</code> will be offering functions related to timescaledb
toolkit.</p>

<p>The <code class="language-plaintext highlighter-rouge">value_column:</code> will be combined with the <code class="language-plaintext highlighter-rouge">time_column</code> from the hypertable
to use scopes like  <code class="language-plaintext highlighter-rouge">candlestick</code>, <code class="language-plaintext highlighter-rouge">volatility</code>, <code class="language-plaintext highlighter-rouge">lttb</code> and just configure the
missing information.</p>

<p>The <code class="language-plaintext highlighter-rouge">segment_by:</code> will be widely used in the scopes to group by the data.</p>

<p>When the keywords <code class="language-plaintext highlighter-rouge">time_column</code>, <code class="language-plaintext highlighter-rouge">value_column</code> and <code class="language-plaintext highlighter-rouge">segment_by</code> are used in the
<code class="language-plaintext highlighter-rouge">acts_as_{hypertable,time_vector}</code> modules.</p>

<p>By convention, all scopes reuse the metadata from the configuration. It can facilitate
the process of build a lot of hypertable abstractions to facilitate the use combined scopes in the queries.</p>

<h3 id="the-acts_as_hypertable-macro">The <code class="language-plaintext highlighter-rouge">acts_as_hypertable</code> macro</h3>

<p>The <code class="language-plaintext highlighter-rouge">acts_as_hypertable</code> will bring the <code class="language-plaintext highlighter-rouge">Model.hypertable</code> which will allow us
to use a set of timeseries related set what are the default columns used to
calculate the data.</p>

<h3 id="the-acts_as_time_vector-macro">The <code class="language-plaintext highlighter-rouge">acts_as_time_vector</code> macro</h3>

<p>The <code class="language-plaintext highlighter-rouge">acts_as_time_vector</code> will allow us to set what are the default columns used
to calculate the data.</p>

<p>The <code class="language-plaintext highlighter-rouge">acts_as_time_vector</code> will inject handy scopes that wraps the
default formulas from timescaledb-toolkit extension.</p>

<p>It will be very powerful to build your set of abstractions over it and simplify
the maintenance of complex queries directly in the database.</p>

<h2 id="inserting-data">Inserting data</h2>

<p>The <code class="language-plaintext highlighter-rouge">generate_series</code> sql function can speed up the process to seed some random
data and make it available to start playing with the queries.</p>

<p>The following code will insert tick data simulating prices from the previews
week until yesterday. We’re using a single symbol and one tick every 10 seconds.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>
  <span class="n">data_range</span> <span class="o">=</span> <span class="p">{</span><span class="ss">from: </span><span class="mi">1</span><span class="p">.</span><span class="nf">week</span><span class="p">.</span><span class="nf">ago</span><span class="p">.</span><span class="nf">to_date</span><span class="p">,</span> <span class="ss">to: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">from_now</span><span class="p">.</span><span class="nf">to_date</span><span class="p">}</span>
  <span class="n">execute</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">sanitize_sql_for_conditions</span><span class="p">(</span> <span class="p">[</span><span class="o">&lt;&lt;~</span><span class="no">SQL</span><span class="p">,</span> <span class="n">data_range</span><span class="p">]))</span><span class="sh">
    INSERT INTO ticks
    SELECT time, 'SYMBOL', 1 + (random()*30)::int, 100*(random()*10)::int
    FROM generate_series(
      TIMESTAMP :from,
      TIMESTAMP :to,
      INTERVAL '10 second') AS time;
</span><span class="no">    SQL</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The database will seed a week of trade data with a randomize prices and volumes
simulating one event every 10 seconds.</p>

<p>The candlestick will split the timeframe by the <code class="language-plaintext highlighter-rouge">time_column</code> and use the <code class="language-plaintext highlighter-rouge">price</code>
as the default value to process the candlestick. It will also segment the
candles by the <code class="language-plaintext highlighter-rouge">symbol</code>. Symbol can be any stock trade and it’s good to be
segmenting and indexing by it.</p>

<p>If you need to generate some data for your table, please check <a href="https://ideia.me/timescale-continuous-aggregates-with-ruby">this post</a>.</p>

<h2 id="query-data">Query data</h2>

<p>When the <code class="language-plaintext highlighter-rouge">acts_as_time_vector</code> method is used in the model, it will inject
several scopes from the toolkit to easily have access to functions like the
<code class="language-plaintext highlighter-rouge">_candlestick</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">candlestick</code> scope is available with a few parameters that inherits the
configuration from the <code class="language-plaintext highlighter-rouge">acts_as_time_vector</code> declared previously.</p>

<p>The simplest query is:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Tick</span><span class="p">.</span><span class="nf">candlestick</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1m'</span><span class="p">)</span>
</code></pre></div></div>

<p>It will generate the following SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">SELECT</span> <span class="n">symbol</span><span class="p">,</span>
    <span class="nv">"time"</span><span class="p">,</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1m'</span><span class="p">,</span> <span class="nb">time</span><span class="p">)</span> <span class="k">as</span> <span class="nb">time</span><span class="p">,</span>
      <span class="nv">"ticks"</span><span class="p">.</span><span class="nv">"symbol"</span><span class="p">,</span>
      <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">candlestick</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="nv">"ticks"</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">AS</span> <span class="n">candlestick</span>
</code></pre></div></div>

<p>The timeframe argument can also be skipped and the default is <code class="language-plaintext highlighter-rouge">1 hour</code>.</p>

<p>You can also combine other scopes to filter data before you get the data from
the candlestick:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Tick</span><span class="p">.</span><span class="nf">yesterday</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">symbol: </span><span class="s2">"SYMBOL"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">candlestick</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1m'</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">yesterday</code> scope is automatically included because of the <code class="language-plaintext highlighter-rouge">acts_as_hypertable</code> macro. And it will be combining with other where clauses.</p>

<h2 id="continuous-aggregates">Continuous aggregates</h2>

<p>If you would like to continuous process the stream and aggregate the candlesticks
on a materialized view you can use continuous aggregates for it.</p>

<p>The next examples shows how to create a continuous aggregates of 1 minute
candlesticks:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>
  <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">with_data: </span><span class="kp">true</span><span class="p">,</span>
    <span class="ss">refresh_policies: </span><span class="p">{</span>
      <span class="ss">start_offset: </span><span class="s2">"INTERVAL '1 month'"</span><span class="p">,</span>
      <span class="ss">end_offset: </span><span class="s2">"INTERVAL '1 minute'"</span><span class="p">,</span>
      <span class="ss">schedule_interval: </span><span class="s2">"INTERVAL '1 minute'"</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">'candlestick_1m'</span><span class="p">,</span> <span class="no">Tick</span><span class="p">.</span><span class="nf">_candlestick</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1m'</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">create_continuous_aggregate</code> calls the <code class="language-plaintext highlighter-rouge">to_sql</code> method in case
the second parameter is not a string.</p>

<p>Also, we’re using the <code class="language-plaintext highlighter-rouge">_candlestick</code> method scope instead of the <code class="language-plaintext highlighter-rouge">candlestick</code>
one.</p>

<p>The reason is that the <code class="language-plaintext highlighter-rouge">candlestick</code> method already bring the attribute values
while the <code class="language-plaintext highlighter-rouge">_candlestick</code> can bring you the pre-processed data in a intermediate
state that can be rolled up with other candlesticks. For example, let’s say you
already created a continuous aggregates of one minute and now you’d like to
process 5 minutes. You don’t need to reprocess the raw data. You can build the
candlestick using the information from the one minute candlesticks.</p>

<h2 id="models-for-views">Models for views</h2>

<p>It’s very convenient to setup models for continuous aggregates which can
make it easy to inherit all smart methods to compose queries.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Candlestick1m</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="s1">'candlestick_1m'</span>
  <span class="kp">include</span> <span class="no">Candlestick</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Candlestick1h</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="s1">'candlestick_1h'</span>
  <span class="kp">include</span> <span class="no">Candlestick</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Candlestick1d</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">table_name</span> <span class="o">=</span> <span class="s1">'candlestick_1d'</span>
  <span class="kp">include</span> <span class="no">Candlestick</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that all classes include the <code class="language-plaintext highlighter-rouge">Candlestick</code> module. Let’s define it to make
it easy to use the shared behavior.</p>

<h3 id="the-candlestick-concern">The candlestick concern</h3>

<p>Concerns are already available through active_support and they can help you to
organize shared logic that can be included in multiple models.</p>

<p>In this concern, we’ll have:</p>

<ol>
  <li>Use the <code class="language-plaintext highlighter-rouge">acts_as_hypertable</code> macro to inherit all query scopes.</li>
  <li>Define attributes for all candlestick attributes</li>
  <li>Define extra scopes to read the data and rollup to bigger timeframes.</li>
  <li>Mark the model as readonly.</li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"active_support/concern"</span>

<span class="k">module</span> <span class="nn">Candlestick</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">acts_as_hypertable</span> <span class="ss">time_column: </span><span class="s2">"time_bucket"</span>

    <span class="sx">%w[open high low close]</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
      <span class="n">attribute</span> <span class="nb">name</span><span class="p">,</span> <span class="ss">:decimal</span>
      <span class="n">attribute</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">_time"</span><span class="p">,</span> <span class="ss">:time</span>
    <span class="k">end</span>
    <span class="n">attribute</span> <span class="ss">:volume</span><span class="p">,</span> <span class="ss">:decimal</span>
    <span class="n">attribute</span> <span class="ss">:vwap</span><span class="p">,</span> <span class="ss">:decimal</span>

    <span class="n">scope</span> <span class="ss">:attributes</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">do</span>
      <span class="nb">select</span><span class="p">(</span><span class="s2">"symbol, time_bucket,
        toolkit_experimental.open(candlestick),
        toolkit_experimental.high(candlestick),
        toolkit_experimental.low(candlestick),
        toolkit_experimental.close(candlestick),
        toolkit_experimental.open_time(candlestick),
        toolkit_experimental.high_time(candlestick),
        toolkit_experimental.low_time(candlestick),
        toolkit_experimental.close_time(candlestick),
        toolkit_experimental.volume(candlestick),
        toolkit_experimental.vwap(candlestick)"</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">readonly?</span>
      <span class="kp">true</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="hierarchical-continuous-aggregates">Hierarchical continuous aggregates</h2>

<p>After you get the first one minute continuous aggregates, you don’t need to
revisit the raw data to create candlesticks from it. You can build the 1 hour
candlestick from the 1 minute candlestick. The <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/hierarchical-continuous-aggregates/">Hierarchical continuous aggregates</a>
are very useful to save IO and processing time.</p>

<h3 id="rollup">Rollup</h3>

<p>The <a href="https://docs.timescale.com/api/latest/hyperfunctions/financial-analysis/candlestick_agg/">candlestick_agg</a> function returns a <code class="language-plaintext highlighter-rouge">candlesticksummary</code> object.</p>

<p>The rollup allows you to combine candlestick summaries into new structures from
smaller timeframes to bigger timeframes without needing to reprocess all the data.</p>

<p>With this feature, you can group by the candlesticks multiple times saving processing 
from the server and make it easier to manage aggregations with different time intervals.</p>

<p>In the previous example, we used the <code class="language-plaintext highlighter-rouge">.candlestick</code> function that returns already the
attributes from the different timeframes. In the SQL command it’s calling the
<code class="language-plaintext highlighter-rouge">open</code>, <code class="language-plaintext highlighter-rouge">high</code>, <code class="language-plaintext highlighter-rouge">low</code>, <code class="language-plaintext highlighter-rouge">close</code>, <code class="language-plaintext highlighter-rouge">volume</code>, and <code class="language-plaintext highlighter-rouge">vwap</code> functions that can access
the values behind the candlesticksummary type.</p>

<p>To merge the candlesticks, the rollup method can aggregate several <code class="language-plaintext highlighter-rouge">candlesticksummary</code>
objects into a bigger timeframe.</p>

<p>Let’s rollup the structures:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Candlestick</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="c1"># ... previous code remains the same</span>

    <span class="n">scope</span> <span class="ss">:rollup</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1h'</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">bucket</span> <span class="o">=</span> <span class="sx">%|time_bucket('</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="sx">', "time_bucket")|</span>
      <span class="nb">select</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span><span class="s2">"symbol"</span><span class="p">,</span>
            <span class="s2">"toolkit_experimental.rollup(candlestick) as candlestick"</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, the new views in bigger timeframes can be added using it’s own objects.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">instance_exec</span> <span class="k">do</span>
  <span class="n">options</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">timeframe</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">{</span>
      <span class="ss">with_data: </span><span class="kp">false</span><span class="p">,</span>
      <span class="ss">refresh_policies: </span><span class="p">{</span>
        <span class="ss">start_offset: </span><span class="s2">"INTERVAL '1 month'"</span><span class="p">,</span>
        <span class="ss">end_offset: </span><span class="s2">"INTERVAL '</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">'"</span><span class="p">,</span>
        <span class="ss">schedule_interval: </span><span class="s2">"INTERVAL '</span><span class="si">#{</span><span class="n">timeframe</span><span class="si">}</span><span class="s2">'"</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">'candlestick_1h'</span><span class="p">,</span> <span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">rollup</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1 hour'</span><span class="p">),</span> <span class="o">**</span><span class="n">options</span><span class="p">[</span><span class="s1">'1 hour'</span><span class="p">])</span>
  <span class="n">create_continuous_aggregate</span><span class="p">(</span><span class="s1">'candlestick_1d'</span><span class="p">,</span> <span class="no">Candlestick1h</span><span class="p">.</span><span class="nf">rollup</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1 day'</span><span class="p">),</span>  <span class="o">**</span><span class="n">options</span><span class="p">[</span><span class="s1">'1 day'</span><span class="p">])</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The final SQL executed to create the first <a href="https://docs.timescale.com/timescaledb/latest/how-to-guides/continuous-aggregates/hierarchical-continuous-aggregates/">hierarchical continuous aggregates</a>
is the following:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">candlestick_1h</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
  <span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 hour'</span><span class="p">,</span> <span class="nv">"time_bucket"</span><span class="p">),</span>
    <span class="nv">"candlestick_1m"</span><span class="p">.</span><span class="nv">"symbol"</span><span class="p">,</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span>
  <span class="k">FROM</span> <span class="nv">"candlestick_1m"</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="k">WITH</span> <span class="k">DATA</span><span class="p">;</span>
</code></pre></div></div>

<p>So, as you can see all candlestick of one hour views follows the same interface of
one minute, having the same column names and values, allowing to be reuse in
larger timeframes.</p>

<h3 id="refresh-policy">Refresh policy</h3>

<p>Timescaledb is assuming you’re storing real time data. Which means you can
continuous feed the <code class="language-plaintext highlighter-rouge">ticks</code> table and aggregate the materialized data from time
to time.</p>

<p>When <code class="language-plaintext highlighter-rouge">create_continuous_aggregate</code> is called with a <code class="language-plaintext highlighter-rouge">schedule_interval</code> it will
also execute the following SQL line:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">add_continuous_aggregate_policy</span><span class="p">(</span><span class="s1">'candlestick_1h'</span><span class="p">,</span>
  <span class="n">start_offset</span> <span class="o">=&gt;</span> <span class="n">INTERVAL</span> <span class="s1">'1 month'</span><span class="p">,</span>
  <span class="n">end_offset</span> <span class="o">=&gt;</span> <span class="n">INTERVAL</span> <span class="s1">'1 hour'</span><span class="p">,</span>
  <span class="n">schedule_interval</span> <span class="o">=&gt;</span> <span class="n">INTERVAL</span> <span class="s1">'1 hour'</span><span class="p">);</span>
</code></pre></div></div>

<p>Instead of updating the values row by row, the refresh policy will automatically
run in background and aggregate the new data with the configured timeframe.</p>

<h2 id="querying-continuous-aggregates-with-custom-activerecord-models">Querying Continuous Aggregates with custom ActiveRecord models</h2>

<p>With the <code class="language-plaintext highlighter-rouge">Candlestick1m</code> and <code class="language-plaintext highlighter-rouge">Candlestick1h</code> wrapping the continuous aggregates
into models, now, it’s time to explore the available scopes and what to do with
it.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">yesterday</span><span class="p">.</span><span class="nf">first</span>
</code></pre></div></div>

<p>It will run the following SQL:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"candlestick_1m"</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span> <span class="nv">"candlestick_1m"</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'2023-01-23'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>And return the following object:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#&lt;Candlestick1m:0x000000010fbeff68</span>
 <span class="ss">time_bucket: </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span>
 <span class="ss">symbol: </span><span class="s2">"SYMBOL"</span><span class="p">,</span>
 <span class="ss">candlestick:
  </span><span class="s2">"(version:1,open:(ts:</span><span class="se">\"</span><span class="s2">2023-01-23 00:00:00+00</span><span class="se">\"</span><span class="s2">,val:9),high:(ts:</span><span class="se">\"</span><span class="s2">2023-01-23 00:00:10+00</span><span class="se">\"</span><span class="s2">,val:24),low:(ts:</span><span class="se">\"</span><span class="s2">2023-01-23 00:00:50+00</span><span class="se">\"</span><span class="s2">,val:2),close:(ts:</span><span class="se">\"</span><span class="s2">2023-01-23 00:00:50+00</span><span class="se">\"</span><span class="s2">,val:2),volume:Transaction(vol:2400,vwap:26200))"</span><span class="p">,</span>
 <span class="ss">open: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">open_time: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">high: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">high_time: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">low: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">low_time: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">close: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">close_time: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">volume: </span><span class="kp">nil</span><span class="p">,</span>
 <span class="ss">vwap: </span><span class="kp">nil</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Note that the attributes are not available in the object but a <code class="language-plaintext highlighter-rouge">candlestick</code>
attribute is present holding all the information. That’s why it’s necessary to
use the <code class="language-plaintext highlighter-rouge">attributes</code> scope:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">yesterday</span><span class="p">.</span><span class="nf">attributes</span><span class="p">.</span><span class="nf">first</span>
</code></pre></div></div>

<p>Which will run the following query:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">time_bucket</span><span class="p">,</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span>
<span class="k">FROM</span> <span class="nv">"candlestick_1m"</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="nb">DATE</span><span class="p">(</span><span class="n">time_bucket</span><span class="p">)</span> <span class="o">=</span> <span class="s1">'2023-01-23'</span><span class="p">)</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>And the object will be filled with the attributes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">=&gt;</span> <span class="c1">#&lt;Candlestick1m:0x000000010fc3e578</span>
 <span class="ss">time_bucket: </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="no">UTC</span><span class="p">,</span>
 <span class="ss">symbol: </span><span class="s2">"SYMBOL"</span><span class="p">,</span>
 <span class="ss">open: </span><span class="mf">0.9e1</span><span class="p">,</span>
 <span class="ss">open_time: </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
 <span class="ss">high: </span><span class="mf">0.24e2</span><span class="p">,</span>
 <span class="ss">high_time: </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">10</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
 <span class="ss">low: </span><span class="mf">0.2e1</span><span class="p">,</span>
 <span class="ss">low_time: </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">50</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
 <span class="ss">close: </span><span class="mf">0.2e1</span><span class="p">,</span>
 <span class="ss">close_time: </span><span class="mi">2023</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mi">50</span> <span class="o">+</span><span class="mo">0000</span><span class="p">,</span>
 <span class="ss">volume: </span><span class="mf">0.24e4</span><span class="p">,</span>
 <span class="ss">vwap: </span><span class="mf">0.1091666666666666e2</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>It’s a very convenient strategy to have the <code class="language-plaintext highlighter-rouge">Candlestick</code> as a shared concern
to allow to reuse queries in different views of the same type.</p>

<p>The <code class="language-plaintext highlighter-rouge">rollup</code> scope is the one that was used to redefine the data into big timeframes
and the <code class="language-plaintext highlighter-rouge">attributes</code> allow to access the attributes from the candlestick type.</p>

<p>In this way, the views become just shortcuts and complex sql can also be done
just nesting the model scope. For example, to rollup from a minute to one hour,
you can do:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">attributes</span><span class="p">.</span><span class="nf">from</span><span class="p">(</span>
  <span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">rollup</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1 hour'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>And from minute to one hour to a day:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">attributes</span><span class="p">.</span><span class="nf">from</span><span class="p">(</span>
  <span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">rollup</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1 day'</span><span class="p">).</span><span class="nf">from</span><span class="p">(</span>
    <span class="no">Candlestick1m</span><span class="p">.</span><span class="nf">rollup</span><span class="p">(</span><span class="ss">timeframe: </span><span class="s1">'1 hour'</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Both examples are just using the one minute continuous aggregates view and
reprocessing it from there.</p>

<p>Composing the subqueries will probably be less efficient and unnecessary as we
already created more continuous aggregates in the top of another continuous
aggregates. Here is the SQL generated from the last nested rollups code:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">time_bucket</span><span class="p">,</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">open</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">close</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">open_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">high_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">low_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">close_time</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">volume</span><span class="p">(</span><span class="n">candlestick</span><span class="p">),</span>
  <span class="n">toolkit_experimental</span><span class="p">.</span><span class="n">vwap</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 day'</span><span class="p">,</span> <span class="nv">"time_bucket"</span><span class="p">),</span>
    <span class="n">symbol</span><span class="p">,</span>
    <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span>
  <span class="k">FROM</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 hour'</span><span class="p">,</span> <span class="nv">"time_bucket"</span><span class="p">),</span>
      <span class="nv">"candlestick_1m"</span><span class="p">.</span><span class="nv">"symbol"</span><span class="p">,</span>
      <span class="n">toolkit_experimental</span><span class="p">.</span><span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span>
    <span class="k">FROM</span> <span class="nv">"candlestick_1m"</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
  <span class="p">)</span> <span class="n">subquery</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="p">)</span> <span class="n">subquery</span>
</code></pre></div></div>

<h2 id="feedback-or-questions">Feedback or questions?</h2>

<p>I hope you find this tutorial interesting and you can also check the
<code class="language-plaintext highlighter-rouge">candlestick.rb</code> file in the <a href="https://github.com/jonatas/timescaledb/tree/master/examples/toolkit-demo">examples/toolkit-demo</a> folder.</p>

<p>If you have any questions or concerns, feel free to reach me (<a href="https://twitter.com/jonatasdp">@jonatasdp</a>) in the <a href="https://timescale.com/community">Timescale community</a> or tag timescaledb in your StackOverflow issue.</p>

<p>If you’re interested in Data Processing with Ruby and Timescaledb, I talked at
RubyConf Thailand last December about processing data and here is the video of my presentation:</p>

<div class="video-container">
       <iframe width="560" height="420" frameborder="0" allowfullscreen="" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" src="https://www.youtube.com/embed/MXAtSZ5Szgk?color=white&amp;theme=light">
       </iframe>
    </div>

<p>If you liked it, you can see more content like this in my <a href="/talks">talks</a>.</p>


  </div>
  
  
  <div class="article-tags">
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Hierarchical+continuous+aggregates+with+Ruby+and+Timescaledb&url=https%3A%2F%2Fideia.me%2Fhierarchical-continuous-aggregates-with-ruby&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fhierarchical-continuous-aggregates-with-ruby" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fhierarchical-continuous-aggregates-with-ruby&title=Hierarchical+continuous+aggregates+with+Ruby+and+Timescaledb" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fhierarchical-continuous-aggregates-with-ruby&title=Hierarchical+continuous+aggregates+with+Ruby+and+Timescaledb" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/activerecord-update-without-primary-key" title="ActiveRecord update without primary key">
        ActiveRecord update without primary key
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/life-before-and-after-gpt" title="Life before and after Chat GPT">
        Life before and after Chat GPT
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
        
        
          <div class="col-12">
            <p>No related posts found. Check out <a href="/archive.html">recent posts</a> instead.</p>
          </div>
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/hierarchical-continuous-aggregates-with-ruby';
    this.page.identifier = '/hierarchical-continuous-aggregates-with-ruby';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Consolidated JS -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Apply highlighting to code blocks after content loads
        if (typeof enhanceCodeBlocks === 'function') {
          enhanceCodeBlocks();
        }
        
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Add fade-in animations
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Apply fade-in to cards and other elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .glass-card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Minimal delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
        
        // Smooth page transitions
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    
    <!-- Dedicated scripts -->
  </body>
</html>

