
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NV80WM9HT0');
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Anonymize your SQL statements</title>
    
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link id="bootstrap" href="/css/bootstrap.css" rel="stylesheet">
    <link id="bootstrap" href="/css/bootswatch.min.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">

    <script src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap-dropdown.js"></script>
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="/">
            <img class="img-circle" alt="ideiame logo" style="padding-top: 6px" src="/images/ideiame.png"></a>
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
           </button>
       </div>
   <div class="navbar-collapse collapse" id="navbar-main">
     <ul class="nav navbar-nav">
      <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Social<b class="caret"></b></a>
            <ul class="dropdown-menu" id="swatch-menu">
              <li><a href="https://github.com/jonatas">Github</a></li>
              <li><a href="https://twitter.com/jonatasdp">Twitter</a></li>
              <li><a href="https://instagram.com/jonatasdp">Instagram</a></li>
              <li><a href="https://www.meetup.com/Floripa-on-Rails/members/185190193/">Meetup</a></li>
              <li><a href="https://www.slideshare.net/jonataspaganini/">SlideShare</a></li>
              <li><a href="https://facebook.com/jonatas.paganini">Facebook</a></li>
              <li><a href="https://www.youtube.com/user/jonatasdp">Youtube</a></li>
           </ul>
          </li>
          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Projects<b class="caret"></b></a>
            <ul class="dropdown-menu">
            <li><a href="https://github.com/jonatas/fast">Fast</a></li>
            <li><a href="http://torf.ideia.me">2015: True Or False Game</a></li>
            <li><a href="http://github.com/jonatas/pixel.ideia.me">2013: Pixel art (collaborative) </a></li>
            <li><a href="http://github.com/jonatas/trybliss">2013: Try Bliss</a</li>
            <li><a href="http://github.com/jonatas/churumelas">2012: Regexp challenges</a></li>
            <li><a href="/camera-overlay">2012: Camera Overlay </a></li>
           </ul>
          </li>
          
          
          


  
    
      
      	
      	<li><a href="/archive">Arquivo</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categorias</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  



          </ul>
        </div>
      </div>
     </div>
    </div>
    <div class="container">
      
<div class="page-header">
    <h1>
       <img class="thumb img-circle" src="https://avatars0.githubusercontent.com/u/15484?s=50" title="Jônatas Davi Paganini" alt="Jônatas Davi Paganini profile pic"></img>
       Anonymize your SQL statements <small><br/>26/11/2023
    
      <span class="categories">
        
       </span>
     
     </small>
  </h1>
</div>
<div class="content">
    <p>As a community manager at Timescale, I frequently engage with our vibrant community, helping members tackle a variety of SQL-related challenges. One common concern that arises is the need to share SQL queries for collaboration or troubleshooting, without exposing sensitive data. Recognizing this need, I’ve embarked on developing a tool to anonymize SQL data effectively.</p>

<p>Following my previous work on a SQL formatter, this new venture focuses on SQL anonymization - transforming sensitive database identifiers into non-sensitive equivalents while retaining the query’s structure and logic.</p>

<p>In the realm of data management and privacy, anonymizing SQL data is an essential practice. Building on the capabilities of <a href="/fast-supports-sql">Fast, which now supports SQL</a>, I’m excited to share my explorations in this field.</p>

<p>Let’s take a basic SQL query as an example:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">name</span> <span class="k">FROM</span> <span class="n">weather_data</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">ASC</span>
</code></pre></div></div>

<p>Our goal is to transform it into:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">something</span> <span class="k">FROM</span> <span class="n">somewhere</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span> <span class="k">ASC</span>
</code></pre></div></div>

<p>The anonymize here is very basic, but it can go further, replacing not just table names, but column names and all identifiers.</p>

<h2 id="understanding-ast-tokens">Understanding AST Tokens</h2>

<p>The best way to start is with a hands-on example. Here’s a SQL script that showcases a range of interconnected database objects, such as tables and views:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">"ticks"</span> <span class="p">(</span><span class="nv">"time"</span> <span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"symbol"</span> <span class="nb">text</span><span class="p">,</span> <span class="nv">"price"</span> <span class="nb">decimal</span><span class="p">,</span> <span class="nv">"volume"</span> <span class="nb">float</span><span class="p">);</span>

<span class="k">SELECT</span> <span class="n">create_hypertable</span><span class="p">(</span><span class="s1">'ticks'</span><span class="p">,</span> <span class="s1">'time'</span><span class="p">,</span> <span class="n">chunk_time_interval</span> <span class="o">=&gt;</span> <span class="n">INTERVAL</span> <span class="s1">'1 day'</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">candlestick_1m</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1m'</span><span class="p">,</span> <span class="nb">time</span><span class="p">),</span>
       <span class="nv">"ticks"</span><span class="p">.</span><span class="nv">"symbol"</span><span class="p">,</span>
       <span class="n">candlestick_agg</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span>
<span class="k">FROM</span> <span class="nv">"ticks"</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="k">WITH</span> <span class="k">DATA</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">candlestick_1h</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span> <span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 hour'</span><span class="p">,</span> <span class="nv">"time_bucket"</span><span class="p">),</span>
       <span class="n">symbol</span><span class="p">,</span>
       <span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span> 
<span class="k">FROM</span> <span class="nv">"candlestick_1m"</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="k">WITH</span> <span class="k">NO</span> <span class="k">DATA</span><span class="p">;</span>
</code></pre></div></div>

<p>Which should be represented with anonymized references but keep all the example
with consistent references.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">x1</span> <span class="p">(</span><span class="nv">"time"</span> <span class="nb">timestamp</span> <span class="k">with</span> <span class="nb">time</span> <span class="k">zone</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span> <span class="nv">"symbol"</span> <span class="nb">text</span><span class="p">,</span> <span class="nv">"price"</span> <span class="nb">decimal</span><span class="p">,</span> <span class="nv">"volume"</span> <span class="nb">float</span><span class="p">);</span>

<span class="k">SELECT</span> <span class="n">create_hypertable</span><span class="p">(</span><span class="s1">'x1'</span><span class="p">,</span> <span class="s1">'time'</span><span class="p">,</span> <span class="n">chunk_time_interval</span> <span class="o">=&gt;</span> <span class="n">INTERVAL</span> <span class="s1">'1 day'</span><span class="p">);</span>

<span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">x3</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1m'</span><span class="p">,</span> <span class="nb">time</span><span class="p">),</span>
       <span class="n">x1</span><span class="p">.</span><span class="nv">"symbol"</span><span class="p">,</span>
       <span class="n">candlestick_agg</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span>
<span class="k">FROM</span> <span class="n">x1</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="k">WITH</span> <span class="k">DATA</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">x5</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span> <span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 hour'</span><span class="p">,</span> <span class="nv">"time_bucket"</span><span class="p">),</span>
       <span class="n">symbol</span><span class="p">,</span>
       <span class="k">rollup</span><span class="p">(</span><span class="n">candlestick</span><span class="p">)</span> <span class="k">as</span> <span class="n">candlestick</span>
<span class="k">FROM</span> <span class="n">x4</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">1</span>
<span class="k">WITH</span> <span class="k">NO</span> <span class="k">DATA</span><span class="p">;</span>
</code></pre></div></div>

<p>The output example is just anonymizing table names. Column names, aliases,
view names and other scenarios could also reveal business information.</p>

<p>This script presents a complex scenario with hierarchical views referencing in
cascade.</p>

<p>If you want to go deep, watch my live coding session exploring this topic.</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0;"><iframe src="https://www.loom.com/embed/dd9e9e18be564907afe518024110502e?sid=dabb247f-a567-4128-b74e-a83783722322" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen="" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></iframe></div>

<p>The short steps to cover this small scenario anonymizing table and view names are:</p>

<ol>
  <li><strong>Parsing SQL with AST</strong>: Using Fast, we begin by parsing the SQL file into an AST,
providing us with a structured format for manipulation.</li>
</ol>

<p>In this example, we use “gemfile inline” to fetch the library dynamicaly.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'bundler/inline'</span>

<span class="n">gemfile</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'ffast'</span> <span class="c1"># , path: "../fast"</span>
  <span class="n">gem</span> <span class="s1">'pry'</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s1">'fast'</span>
<span class="nb">require</span> <span class="s1">'fast/sql'</span>

<span class="n">ast</span> <span class="o">=</span> <span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql_file</span><span class="p">(</span><span class="s1">'file.sql'</span><span class="p">)</span>

<span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
</code></pre></div></div>

<p>Observing the entire ast structure:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ast</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="n">s</span><span class="p">(</span><span class="ss">:create_stmt</span><span class="p">,</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:relation</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"ticks"</span><span class="p">),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">)),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:table_elts</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:column_def</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:colname</span><span class="p">,</span> <span class="s2">"time"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:type_name</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:names</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"pg_catalog"</span><span class="p">)),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"timestamptz"</span><span class="p">))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:type_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:typemod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inhcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:is_local</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:coll_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:constraints</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:constraint</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:contype</span><span class="p">,</span> <span class="ss">:CONSTR_NOTNULL</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:old_pktable_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:column_def</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:colname</span><span class="p">,</span> <span class="s2">"symbol"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:type_name</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:names</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"text"</span><span class="p">))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:type_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:typemod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inhcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:is_local</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:coll_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:column_def</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:colname</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:type_name</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:names</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"pg_catalog"</span><span class="p">)),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"numeric"</span><span class="p">))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:type_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:typemod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inhcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:is_local</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:coll_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:column_def</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:colname</span><span class="p">,</span> <span class="s2">"volume"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:type_name</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:names</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"pg_catalog"</span><span class="p">)),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"float8"</span><span class="p">))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:type_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:typemod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inhcount</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:is_local</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:coll_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">))),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:oncommit</span><span class="p">,</span> <span class="ss">:ONCOMMIT_NOOP</span><span class="p">)),</span>
 <span class="n">s</span><span class="p">(</span><span class="ss">:select_stmt</span><span class="p">,</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:target_list</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:func_call</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:funcname</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"create_hypertable"</span><span class="p">))),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:args</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"ticks"</span><span class="p">))),</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"time"</span><span class="p">))),</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:named_arg_expr</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:arg</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:type_cast</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:arg</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span>
                        <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"1 day"</span><span class="p">)))),</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:type_name</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:names</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                        <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"pg_catalog"</span><span class="p">)),</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                        <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"interval"</span><span class="p">))),</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:type_oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:typemod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"chunk_time_interval"</span><span class="p">),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:argnumber</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:funcformat</span><span class="p">,</span> <span class="ss">:COERCE_EXPLICIT_CALL</span><span class="p">)))))),</span>
 <span class="n">s</span><span class="p">(</span><span class="ss">:create_table_as_stmt</span><span class="p">,</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:query</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:select_stmt</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:target_list</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:func_call</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcname</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"time_bucket"</span><span class="p">))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:args</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"1m"</span><span class="p">))),</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"time"</span><span class="p">))))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcformat</span><span class="p">,</span> <span class="ss">:COERCE_EXPLICIT_CALL</span><span class="p">)))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"ticks"</span><span class="p">)),</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"symbol"</span><span class="p">)))))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"candlestick"</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:func_call</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcname</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"candlestick_agg"</span><span class="p">))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:args</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"time"</span><span class="p">)))),</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">)))),</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"volume"</span><span class="p">))))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcformat</span><span class="p">,</span> <span class="ss">:COERCE_EXPLICIT_CALL</span><span class="p">))))),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:from_clause</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:range_var</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"ticks"</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">))),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:group_clause</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:sort_clause</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:sort_by</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:sortby_dir</span><span class="p">,</span> <span class="ss">:SORTBY_DEFAULT</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:sortby_nulls</span><span class="p">,</span> <span class="ss">:SORTBY_NULLS_DEFAULT</span><span class="p">))))),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:into</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:rel</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"candlestick_1m"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">)),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:options</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:def_elem</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:defnamespace</span><span class="p">,</span> <span class="s2">"timescaledb"</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:defname</span><span class="p">,</span> <span class="s2">"continuous"</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:defaction</span><span class="p">,</span> <span class="ss">:DEFELEM_UNSPEC</span><span class="p">))),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:on_commit</span><span class="p">,</span> <span class="ss">:ONCOMMIT_NOOP</span><span class="p">)),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:objtype</span><span class="p">,</span> <span class="ss">:OBJECT_MATVIEW</span><span class="p">)),</span>
 <span class="n">s</span><span class="p">(</span><span class="ss">:create_table_as_stmt</span><span class="p">,</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:query</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:select_stmt</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:target_list</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:func_call</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcname</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"time_bucket"</span><span class="p">))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:args</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"1 hour"</span><span class="p">))),</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"time_bucket"</span><span class="p">))))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcformat</span><span class="p">,</span> <span class="ss">:COERCE_EXPLICIT_CALL</span><span class="p">)))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"symbol"</span><span class="p">)))))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="s2">"candlestick"</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:func_call</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcname</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"rollup"</span><span class="p">))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:args</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
                  <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">,</span>
                    <span class="n">s</span><span class="p">(</span><span class="ss">:string</span><span class="p">,</span>
                      <span class="n">s</span><span class="p">(</span><span class="ss">:sval</span><span class="p">,</span> <span class="s2">"candlestick"</span><span class="p">))))),</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:funcformat</span><span class="p">,</span> <span class="ss">:COERCE_EXPLICIT_CALL</span><span class="p">))))),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:from_clause</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:range_var</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"candlestick_1m"</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">))),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:group_clause</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:sort_clause</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:sort_by</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span>
            <span class="n">s</span><span class="p">(</span><span class="ss">:a_const</span><span class="p">,</span>
              <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span>
                <span class="n">s</span><span class="p">(</span><span class="ss">:ival</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:sortby_dir</span><span class="p">,</span> <span class="ss">:SORTBY_DEFAULT</span><span class="p">),</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:sortby_nulls</span><span class="p">,</span> <span class="ss">:SORTBY_NULLS_DEFAULT</span><span class="p">))))),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:into</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:rel</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"candlestick_1h"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">)),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:options</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:def_elem</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:defnamespace</span><span class="p">,</span> <span class="s2">"timescaledb"</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:defname</span><span class="p">,</span> <span class="s2">"continuous"</span><span class="p">),</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:defaction</span><span class="p">,</span> <span class="ss">:DEFELEM_UNSPEC</span><span class="p">))),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:on_commit</span><span class="p">,</span> <span class="ss">:ONCOMMIT_NOOP</span><span class="p">),</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:skip_data</span><span class="p">,</span> <span class="kp">true</span><span class="p">)),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:objtype</span><span class="p">,</span> <span class="ss">:OBJECT_MATVIEW</span><span class="p">))]</span>
</code></pre></div></div>

<ol>
  <li><strong>Identifying sensitive data</strong>: Use Fast to identify sensitive elements such as table names within the AST.</li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">relnames</span> <span class="o">=</span> <span class="no">Fast</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s2">"(relname $_)"</span><span class="p">,</span> <span class="n">ast</span><span class="p">).</span><span class="nf">grep</span><span class="p">(</span><span class="no">String</span><span class="p">).</span><span class="nf">uniq</span>
<span class="c1"># =&gt; ["ticks", "candlestick_1m", "candlestick_1h"]</span>
</code></pre></div></div>

<ol>
  <li><strong>Anonymizing Data</strong>: We then replace these elements with generic placeholders. The anonymization process involves
replacing identified elements in the AST with ‘x’ followed by a unique number.</li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pattern</span> <span class="o">=</span> <span class="s2">"{relname (sval {</span><span class="si">#{</span><span class="n">relnames</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:inspect</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)</span><span class="si">}</span><span class="s2">})}"</span>
<span class="nb">puts</span> <span class="s2">"searching with </span><span class="si">#{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">"</span>

<span class="n">content</span> <span class="o">=</span> <span class="no">Fast</span><span class="o">::</span><span class="no">SQL</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">ast</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
  <span class="n">new_name</span> <span class="o">=</span> <span class="n">memo</span><span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="nf">source</span><span class="p">.</span><span class="nf">tr</span><span class="p">(</span><span class="sx">%|"'|</span><span class="p">,</span> <span class="s1">''</span><span class="p">)]</span> <span class="o">||=</span> <span class="s2">"x</span><span class="si">#{</span><span class="n">memo</span><span class="p">.</span><span class="nf">size</span><span class="si">}</span><span class="s2">"</span>
  <span class="n">new_name</span> <span class="o">=</span> <span class="s2">"'</span><span class="si">#{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">'"</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="nf">type</span> <span class="o">==</span> <span class="ss">:sval</span>
  <span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<ol>
  <li><strong>Visualizing Changes</strong>: <code class="language-plaintext highlighter-rouge">Fast.highlight</code> is employed to color-code and display the changes for better understanding.</li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="no">Fast</span><span class="p">.</span><span class="nf">highlight</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="ss">sql: </span><span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<p>The complete <code class="language-plaintext highlighter-rouge">Fastfile</code> is <a href="https://github.com/jonatas/fast/blob/ccde22cdfa7f7fa910fcfec54d4691250b18d48b/Fastfile#L118-L137">here</a>.</p>

<p>Transform sensitive SQL data into anonymized &amp; shareable code allow community to
bring more complex scenarios closer to production using such idea.</p>

<p>It can also serve as a third eye to see the data structures from a blind spot.
Allowing you to understand standards that repeats over different business
models.</p>

<p>Small shortcuts can also be introduced into your security culture and enables safe sharing of SQL queries within the community.</p>

<p>The power and flexibility of using AST and Fast for anonymizing SQL data open up new horizons in data privacy and security 🫶</p>

<p>I encourage you to experiment with the code and adapt it to your specific needs. If you have questions or insights, feel free to reach out. For more insights into manipulating SQL with Fast, revisit my <a href="https://ideia.me/building-a-sql-formatter-with-fast">previous post on building a SQL formatter</a>.</p>


</div>
<hr>

<div class="share-page">
  Share &rarr;
  <a href="https://twitter.com/intent/tweet?text=Anonymize your SQL statements&url=https://ideia.me/anonymizing-your-sql&via=jonatasdp&related=jonatasdp" rel="nofollow"title="Share on twitter">Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://ideia.me/anonymizing-your-sql" rel="nofollow" target="_blank" title="Share on Facebook">Facebook</a>
  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://ideia.me/anonymizing-your-sql" rel="nofollow" target="_blank" title="Share on Linkedin">Linkedin</a>
</div>
<hr>
<div class="pagination">
    
      <span class="prev">
        <a href="/building-a-sql-formatter-with-fast" title="Building a SQL formatter with Fast">&larr; Before</a>
      </span>
    
    | <span><a href="/archive.html">Archive</a></span> |
    
    <span class="next"><a href="/customize-multiple-refreshes-continuous-aggregates" title="Customize multiple refreshes for continuous aggregates">Next &rarr;</a></span>
    
</div>
<hr>

<p>
  Hello there, my name is Jônatas Davi Paganini and this is my personal blog.
  <br />
  I'm developer advocate at <a href="https://timescale.com">Timescale</a> and
  I also have a few open source projects on <a href="https://github.com/jonatas">github</a>.
</p>
<p>Check my
  <a href="/talks">talks</a> or connect with me via
  <a href="https://br.linkedin.com/in/jonatasdp" target="_blank">linkedin</a> /
  <a href="https://twitter.com/jonatasdp" target="_blank">twitter</a> /
  <a href="https://github.com/jonatas" target="_blank">github</a> /
  <a href="https://instagram.com/jonatasdp" target="_blank">instagram</a> /
  <a href="https://fb.com/jonatas.paganini" target="_blank">facebook</a> /
  <a href="https://www.strava.com/athletes/12104550" target="_blank">strava</a> /
  <a href="http://www.meetup.com/members/185190193/" target="_blank">meetup</a>.
</p>



    </div>
  </body>
</html>

