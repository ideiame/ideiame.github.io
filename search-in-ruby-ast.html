
<!DOCTYPE html>
<html lang="en" class="dark-mode">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Search in Ruby AST</title>
    <meta name="description" content="Some months ago I started coding some cops for RuboCop.">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Always use dark mode -->
    <script>
      (function() {
        document.documentElement.classList.add('dark-mode');
        document.write('<style>body,html{background-color:#0c0c0c!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JetBrains Mono and other developer fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    <!-- Site styles -->
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/modern-theme.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/modern-effects.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body class="dark-mode">
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Geometric background pattern -->
    <div class="geometric-bg"></div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm glass-card" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Search in Ruby AST
          </div>
          
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>Search in Ruby AST</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> May 20, 2017</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 8 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>, 
        
          <a href="#ast-ref" class="text-muted">ast</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>Some months ago I started coding some cops for
<a href="https://github.com/bbatsov/rubocop">RuboCop</a>.</p>

<p>I was amazed in my first contact with the Ruby <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>
and what I can do with that.</p>

<p>After some time looking for other cops, I discovered the
<a href="https://github.com/bbatsov/rubocop/blob/master/lib/rubocop/node_pattern.rb">NodePattern</a>
and it was an amazing experience. It reminds the mind blowing as when I learned
regular expressions, and now I got the same in the Abstract Syntax Tree.</p>

<p>To check how the AST works, please install the gem
<a href="https://github.com/whitequark/parser">parser</a>. It brings a helpful command <code class="language-plaintext highlighter-rouge">ruby-parse</code>
that can print the AST representation of some Ruby code.</p>

<p>Let’s start looking for the AST and how it works. The following class
declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SimpleClass</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Looking the AST representation with the <code class="language-plaintext highlighter-rouge">ruby-parse</code> utility:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby-parse simple_class.rb
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(class
  (const nil :SimpleClass) nil nil)
</code></pre></div></div>

<p>I created a small project to help me understand and do experiments with Ruby AST
and test the node pattern. You can check out it and follow this step by step:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone git@github.com:jonatas/rubocopular.git
</code></pre></div></div>

<p>Then basically it has a <code class="language-plaintext highlighter-rouge">bin/console</code> that allows you to play with to simple
methods <code class="language-plaintext highlighter-rouge">node</code> and <code class="language-plaintext highlighter-rouge">test</code>.</p>

<p>Lets check how it works:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd rubocopular
$ bin/console
</code></pre></div></div>

<p><strong>node</strong> is a method that can parse the AST representation of some Ruby as
string code.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; s(:lvasgn, :a, s(:int, 1))</span>
</code></pre></div></div>
<p>So, the output is pretty similar with <code class="language-plaintext highlighter-rouge">ruby-parse</code>. As it’s using <code class="language-plaintext highlighter-rouge">pry</code> 
you can check that the method <code class="language-plaintext highlighter-rouge">s</code> is a simple wrap to a node:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">show</span><span class="o">-</span><span class="nb">method</span> <span class="n">s</span>
<span class="c1"># From: /Users/jonatasdp/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/rubocop-0.48.1/lib/rubocop/ast/sexp.rb @ line 11:</span>
<span class="c1"># Owner: RuboCop::AST::Sexp</span>
<span class="c1"># Visibility: public</span>
<span class="c1"># Number of lines: 3</span>

<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">)</span>
  <span class="no">Node</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And basically, the node is an object that has a <code class="language-plaintext highlighter-rouge">#type</code> and <code class="language-plaintext highlighter-rouge">#children</code>.
The children can be symbols or other nodes and so on.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">)</span>          <span class="c1"># =&gt; s(:lvasgn, :a, s(:int, 1))</span>
<span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">).</span><span class="nf">type</span>     <span class="c1"># =&gt; :lvasgn</span>
<span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">).</span><span class="nf">children</span> <span class="c1"># =&gt; [:a, s(:int, i)]</span>
</code></pre></div></div>

<p>Let’s check a few more examples:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'class A ; end'</span><span class="p">)</span>    <span class="c1"># =&gt; s(:class, s(:const, nil, :A), nil, nil)</span>
</code></pre></div></div>

<p>Extended class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'class A &lt; B; end'</span><span class="p">)</span> <span class="c1"># =&gt; s(:class, s(:const, nil, :A), s(:const, nil, :B), nil)</span>
</code></pre></div></div>

<p>Implementing a method:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node('class A &lt; B; def method; end end')
# s(:class,
#   s(:const, nil, :A),
#   s(:const, nil, :B),
#   s(:def, :method,
#     s(:args), nil))
</code></pre></div></div>

<p>You can use puts to check the same result as <code class="language-plaintext highlighter-rouge">ruby-parse</code> outputs:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="n">node</span><span class="p">(</span><span class="s1">'class A &lt; B; def method; end end'</span><span class="p">)</span>
</code></pre></div></div>

<p>The output should be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(class
  (const nil :A)
  (const nil :B)
  (def :method
    (args) nil))
</code></pre></div></div>

<p>Then all are single nodes with a <code class="language-plaintext highlighter-rouge">#type</code> and possible <code class="language-plaintext highlighter-rouge">#children</code>.</p>

<p>A few examples with math:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'1 + 2 + 3'</span><span class="p">)</span> <span class="c1"># s(:send, s(:send, s(:int, 1), :+, s(:int, 2)), :+, s(:int, 3))</span>
</code></pre></div></div>

<p>Going deeply in some levels:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'1 + 2 + (3 / 5 * (6 ** 7))'</span><span class="p">)</span>
</code></pre></div></div>

<p>The output should be a tree a bit more complex:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s(:send,
  s(:send,
    s(:int, 1), :+,
    s(:int, 2)), :+,
  s(:begin,
    s(:send,
      s(:send,
        s(:int, 3), :/,
        s(:int, 5)), :*,
      s(:begin,
        s(:send,
          s(:int, 6), :**,
          s(:int, 7))))))
</code></pre></div></div>

<p>Other example with methods:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="n">node</span><span class="p">(</span><span class="s1">'a.b.c(d).e(f)'</span><span class="p">)</span>
</code></pre></div></div>

<p>AST output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(send
  (send
    (send
      (send nil :a) :b) :c
    (send nil :d)) :e
  (send nil :f))
</code></pre></div></div>

<p>Cool yeah? Let’s have fun with the Node Pattern 🕶</p>

<h3 id="rubocop-node-pattern">RuboCop Node Pattern</h3>

<p>The node pattern is a cool engine that allows you to match in some AST code
using the <strong>node pattern</strong>. It’s pretty similar of use regular expressions for
me. Let’s come back with our <code class="language-plaintext highlighter-rouge">a = 1</code> assignment example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; s(:lvasgn, :a, s(:int, 1))</span>
</code></pre></div></div>

<p>Did you remember the <a href="https://github.com/jonatas/rubocopular/blob/master/lib/rubocopular.rb#L14">test</a>
method I mentioned before?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(...)'</span><span class="p">,</span> <span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Cool, it matches with “something with last children”.</p>

<p>Now let’s check if it’s a <code class="language-plaintext highlighter-rouge">:lvasg</code> aka local variable assignment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; nil</span>
</code></pre></div></div>

<p>It does not match because the node has parameters. Lets specify that it comes
with something else using the <code class="language-plaintext highlighter-rouge">...</code> shortcut:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn ...)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<h4 id="capturing">Capturing</h4>

<p>It’s hard sometimes to just understand based on <code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">false</code>. Let’s use
<code class="language-plaintext highlighter-rouge">$</code> to capture and go deeply in the comprehension:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn $...)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; [:a, s(:int, 1)]</span>
</code></pre></div></div>

<p>Cool! It captures the children.</p>

<p>Let’s ignore the variable name using <code class="language-plaintext highlighter-rouge">_</code> that for me represents “one thing”,
I don’t care the name or value for a while.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ $...)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; [s(:int, 1)]</span>
</code></pre></div></div>

<p>We can also capture only the value:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (int $_)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; 1</span>
</code></pre></div></div>

<p>Or the assigned node:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ $(int _))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; s(:int, 1)</span>
</code></pre></div></div>

<p>Or capture multiple things independently:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ ($int $_))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; [:int, 1]</span>
</code></pre></div></div>

<p>That’s cool no?</p>

<p>Let’s imagine we want to restrict our search for float or int:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (int _))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Testing the expression with a float will not work:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (int _))'</span><span class="p">,</span><span class="s1">'a = 1.0'</span><span class="p">)</span> <span class="c1"># =&gt; nil</span>
</code></pre></div></div>

<p>Now let’s introduce <code class="language-plaintext highlighter-rouge">{}</code> that we can union patterns:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ ({int float} _))'</span><span class="p">,</span><span class="s1">'a = 1.0'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>And we can capture the type of the field as well:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (${int float} _))'</span><span class="p">,</span><span class="s1">'a = 1.0'</span><span class="p">)</span> <span class="c1"># =&gt; :float</span>
<span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (${int float} _))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; :int</span>
</code></pre></div></div>

<p>This search thing was amazing for me, and I tried to encapsulate in a search 
command to allow me to search in code with this expression as I do with <code class="language-plaintext highlighter-rouge">grep</code> or <code class="language-plaintext highlighter-rouge">ag</code>.</p>

<p>The prototype is in <a href="https://github.com/jonatas/rubocopular">rubocopular</a> project too. I created the <code class="language-plaintext highlighter-rouge">bin/search</code> for
it:</p>

<p>The search command syntax is pretty simple:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/search 'pattern' *path-to-ruby-files
</code></pre></div></div>

<p>Let’s try something:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/search '(const ... )' lib/*.rb                                                                                                                  11:58:01
lib/rubocopular.rb:5: Rubocopular
lib/rubocopular.rb:7: RuboCop::ProcessedSource
lib/rubocopular.rb:11: RuboCop::ProcessedSource
lib/rubocopular.rb:11: IO
lib/rubocopular.rb:15: RuboCop::AST::Node
lib/rubocopular.rb:16: RuboCop::NodePattern
lib/rubocopular.rb:20: RuboCop::NodePattern
</code></pre></div></div>

<p>Nice, we can filter a bit more and search only for things under <code class="language-plaintext highlighter-rouge">RuboCop</code>
scope:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/search '(const nil :RuboCop ... )' lib/*.rb                                                                                                     11:59:09
lib/rubocopular.rb:7: RuboCop
lib/rubocopular.rb:11: RuboCop
lib/rubocopular.rb:15: RuboCop
lib/rubocopular.rb:16: RuboCop
lib/rubocopular.rb:20: RuboCop
</code></pre></div></div>

<p>It’s cool, but we can also do it with <code class="language-plaintext highlighter-rouge">grep</code>. The difference here is that we’re
listing the nodes not only the code, than we can print some multiline nodes.</p>

<p>Let’s print all check static methods defined in Rubocopular library:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/search '(defs ... )' lib/*.rb                                                                                                                   12:00:48
lib/rubocopular.rb:6: def self.node(code)
    RuboCop::ProcessedSource.new(code.to_s, 2.3).ast
  end
lib/rubocopular.rb:10: def self.parse_source(path)
    RuboCop::ProcessedSource.new(IO.read(path), 2.3, path)
  end
lib/rubocopular.rb:14: def self.test(pattern, code)
    code = node(code) unless code.is_a?(RuboCop::AST::Node)
    RuboCop::NodePattern.new(pattern).match(code)
  end
lib/rubocopular.rb:19: def self.inspect(pattern, code)
    RuboCop::NodePattern.new(pattern.gsub(/(\.{3}|_)/, '$\1')).match(node(code))
  end
</code></pre></div></div>

<p>Awesome, it works!</p>

<p>Thanks for reading until here. If you’re interested in AST search, I’m working
in another library that is my “node pattern” implementation running without
RuboCop dependency. The idea is just starting: https://github.com/jonatas/fast</p>

<p>You can do similar things with plain ruby code and arrays to build the matcher:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">match?</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">:a</span><span class="p">),</span> <span class="ss">:b</span><span class="p">),</span> <span class="p">[</span><span class="ss">:send</span><span class="p">,</span> <span class="s1">'...'</span><span class="p">]))</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Checkout the <a href="https://github.com/jonatas/fast/blob/master/spec/fast_spec.rb#L48">current specs</a>.</p>

<p>In the next step, I’m thinking about do a <code class="language-plaintext highlighter-rouge">f()</code> for find and <code class="language-plaintext highlighter-rouge">c()</code> to capture things. Not sure
exactly how to proceed but the idea is something like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">match?</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">),</span> <span class="s1">'_'</span><span class="p">),</span> <span class="ss">:c</span><span class="p">),</span> <span class="s1">'_'</span><span class="p">)))</span> <span class="c1"># =&gt; s(:send, nil, :a)</span>
</code></pre></div></div>

<p>Any thoughts or ideas about how to be expressive in this search?</p>

  </div>
  
  
  <div class="article-tags">
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
      <a href="#ast-ref" class="article-tag">ast</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Search+in+Ruby+AST&url=https%3A%2F%2Fideia.me%2Fsearch-in-ruby-ast&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fsearch-in-ruby-ast" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fsearch-in-ruby-ast&title=Search+in+Ruby+AST" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fsearch-in-ruby-ast&title=Search+in+Ruby+AST" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/ruby-puzzle-gridlock" title="Gridlock game - solving with Ruby">
        Gridlock game - solving with Ruby
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/parsing-ruby-code" title="Parsing Ruby Code">
        Parsing Ruby Code
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
        
        
          <div class="col-12">
            <p>No related posts found. Check out <a href="/archive.html">recent posts</a> instead.</p>
          </div>
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/search-in-ruby-ast';
    this.page.identifier = '/search-in-ruby-ast';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Consolidated JS -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Apply highlighting to code blocks after content loads
        if (typeof enhanceCodeBlocks === 'function') {
          enhanceCodeBlocks();
        }
        
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Add fade-in animations
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Apply fade-in to cards and other elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .glass-card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Minimal delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
        
        // Smooth page transitions
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    
    <!-- Dedicated scripts -->
  </body>
</html>

