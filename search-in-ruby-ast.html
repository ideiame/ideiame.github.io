
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Search in Ruby AST</title>
    
    <meta name="author" content="J√¥natas Davi Paganini">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link id="bootstrap" href="/css/bootstrap.css" rel="stylesheet">
    <link id="bootstrap" href="/css/bootswatch.min.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">

    <script src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap-dropdown.js"></script>
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="/">
            <img class="img-circle" alt="ideiame logo" style="padding-top: 6px" src="/images/ideiame.png"></a>
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
           </button>
       </div>
   <div class="navbar-collapse collapse" id="navbar-main">
     <ul class="nav navbar-nav">
      <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Social<b class="caret"></b></a>
            <ul class="dropdown-menu" id="swatch-menu">
              <li><a href="https://github.com/jonatas">Github</a></li>
              <li><a href="https://twitter.com/jonatasdp">Twitter</a></li>
              <li><a href="https://instagram.com/jonatasdp">Instagram</a></li>
              <li><a href="https://www.meetup.com/Floripa-on-Rails/members/185190193/">Meetup</a></li>
              <li><a href="https://www.slideshare.net/jonataspaganini/">SlideShare</a></li>
              <li><a href="https://facebook.com/jonatas.paganini">Facebook</a></li>
              <li><a href="https://www.youtube.com/user/jonatasdp">Youtube</a></li>
           </ul>
          </li>
          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Projects<b class="caret"></b></a>
            <ul class="dropdown-menu">
            <li><a href="https://github.com/jonatas/fast">Fast</a></li>
            <li><a href="http://torf.ideia.me">2015: True Or False Game</a></li>
            <li><a href="http://github.com/jonatas/pixel.ideia.me">2013: Pixel art (collaborative) </a></li>
            <li><a href="http://github.com/jonatas/trybliss">2013: Try Bliss</a</li>
            <li><a href="http://github.com/jonatas/churumelas">2012: Regexp challenges</a></li>
            <li><a href="/camera-overlay">2012: Camera Overlay </a></li>
           </ul>
          </li>
          
          
          


  
    
      
      	
      	<li><a href="/archive">Arquivo</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categorias</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  



          </ul>
        </div>
      </div>
     </div>
    </div>
    <div class="container">
      
<div class="page-header">
    <h1>
       <img class="thumb img-circle" src="https://avatars0.githubusercontent.com/u/15484?s=50" title="J√¥natas Davi Paganini" alt="J√¥natas Davi Paganini profile pic"></img>
       Search in Ruby AST <small><br/>20/05/2017
    
      <span class="categories">
        
          <a  class="btn btn-primary" href=/categories.html#ruby-ref>ruby
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <span class="badge">18</span>
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
          </a>
         
          <a  class="btn btn-primary" href=/categories.html#ast-ref>ast
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
            <span class="badge">3</span>
            
          
            
          
            
          
          </a>
         
       </span>
     
     </small>
  </h1>
</div>
<div class="content">
    <p>Some months ago I started coding some cops for
<a href="https://github.com/bbatsov/rubocop">RuboCop</a>.</p>

<p>I was amazed in my first contact with the Ruby <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a>
and what I can do with that.</p>

<p>After some time looking for other cops, I discovered the
<a href="https://github.com/bbatsov/rubocop/blob/master/lib/rubocop/node_pattern.rb">NodePattern</a>
and it was an amazing experience. It reminds the mind blowing as when I learned
regular expressions, and now I got the same in the Abstract Syntax Tree.</p>

<p>To check how the AST works, please install the gem
<a href="https://github.com/whitequark/parser">parser</a>. It brings a helpful command <code class="language-plaintext highlighter-rouge">ruby-parse</code>
that can print the AST representation of some Ruby code.</p>

<p>Let‚Äôs start looking for the AST and how it works. The following class
declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SimpleClass</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Looking the AST representation with the <code class="language-plaintext highlighter-rouge">ruby-parse</code> utility:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ruby-parse simple_class.rb
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(class
  (const nil :SimpleClass) nil nil)
</code></pre></div></div>

<p>I created a small project to help me understand and do experiments with Ruby AST
and test the node pattern. You can check out it and follow this step by step:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone git@github.com:jonatas/rubocopular.git
</code></pre></div></div>

<p>Then basically it has a <code class="language-plaintext highlighter-rouge">bin/console</code> that allows you to play with to simple
methods <code class="language-plaintext highlighter-rouge">node</code> and <code class="language-plaintext highlighter-rouge">test</code>.</p>

<p>Lets check how it works:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd rubocopular
$ bin/console
</code></pre></div></div>

<p><strong>node</strong> is a method that can parse the AST representation of some Ruby as
string code.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; s(:lvasgn, :a, s(:int, 1))</span>
</code></pre></div></div>
<p>So, the output is pretty similar with <code class="language-plaintext highlighter-rouge">ruby-parse</code>. As it‚Äôs using <code class="language-plaintext highlighter-rouge">pry</code> 
you can check that the method <code class="language-plaintext highlighter-rouge">s</code> is a simple wrap to a node:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">show</span><span class="o">-</span><span class="nb">method</span> <span class="n">s</span>
<span class="c1"># From: /Users/jonatasdp/.rbenv/versions/2.3.3/lib/ruby/gems/2.3.0/gems/rubocop-0.48.1/lib/rubocop/ast/sexp.rb @ line 11:</span>
<span class="c1"># Owner: RuboCop::AST::Sexp</span>
<span class="c1"># Visibility: public</span>
<span class="c1"># Number of lines: 3</span>

<span class="k">def</span> <span class="nf">s</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">*</span><span class="n">children</span><span class="p">)</span>
  <span class="no">Node</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And basically, the node is an object that has a <code class="language-plaintext highlighter-rouge">#type</code> and <code class="language-plaintext highlighter-rouge">#children</code>.
The children can be symbols or other nodes and so on.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">)</span>          <span class="c1"># =&gt; s(:lvasgn, :a, s(:int, 1))</span>
<span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">).</span><span class="nf">type</span>     <span class="c1"># =&gt; :lvasgn</span>
<span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">).</span><span class="nf">children</span> <span class="c1"># =&gt; [:a, s(:int, i)]</span>
</code></pre></div></div>

<p>Let‚Äôs check a few more examples:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'class A ; end'</span><span class="p">)</span>    <span class="c1"># =&gt; s(:class, s(:const, nil, :A), nil, nil)</span>
</code></pre></div></div>

<p>Extended class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'class A &lt; B; end'</span><span class="p">)</span> <span class="c1"># =&gt; s(:class, s(:const, nil, :A), s(:const, nil, :B), nil)</span>
</code></pre></div></div>

<p>Implementing a method:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node('class A &lt; B; def method; end end')
# s(:class,
#   s(:const, nil, :A),
#   s(:const, nil, :B),
#   s(:def, :method,
#     s(:args), nil))
</code></pre></div></div>

<p>You can use puts to check the same result as <code class="language-plaintext highlighter-rouge">ruby-parse</code> outputs:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="n">node</span><span class="p">(</span><span class="s1">'class A &lt; B; def method; end end'</span><span class="p">)</span>
</code></pre></div></div>

<p>The output should be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(class
  (const nil :A)
  (const nil :B)
  (def :method
    (args) nil))
</code></pre></div></div>

<p>Then all are single nodes with a <code class="language-plaintext highlighter-rouge">#type</code> and possible <code class="language-plaintext highlighter-rouge">#children</code>.</p>

<p>A few examples with math:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'1 + 2 + 3'</span><span class="p">)</span> <span class="c1"># s(:send, s(:send, s(:int, 1), :+, s(:int, 2)), :+, s(:int, 3))</span>
</code></pre></div></div>

<p>Going deeply in some levels:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'1 + 2 + (3 / 5 * (6 ** 7))'</span><span class="p">)</span>
</code></pre></div></div>

<p>The output should be a tree a bit more complex:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s(:send,
  s(:send,
    s(:int, 1), :+,
    s(:int, 2)), :+,
  s(:begin,
    s(:send,
      s(:send,
        s(:int, 3), :/,
        s(:int, 5)), :*,
      s(:begin,
        s(:send,
          s(:int, 6), :**,
          s(:int, 7))))))
</code></pre></div></div>

<p>Other example with methods:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">puts</span> <span class="n">node</span><span class="p">(</span><span class="s1">'a.b.c(d).e(f)'</span><span class="p">)</span>
</code></pre></div></div>

<p>AST output:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(send
  (send
    (send
      (send nil :a) :b) :c
    (send nil :d)) :e
  (send nil :f))
</code></pre></div></div>

<p>Cool yeah? Let‚Äôs have fun with the Node Pattern üï∂</p>

<h3 id="rubocop-node-pattern">RuboCop Node Pattern</h3>

<p>The node pattern is a cool engine that allows you to match in some AST code
using the <strong>node pattern</strong>. It‚Äôs pretty similar of use regular expressions for
me. Let‚Äôs come back with our <code class="language-plaintext highlighter-rouge">a = 1</code> assignment example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="p">(</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; s(:lvasgn, :a, s(:int, 1))</span>
</code></pre></div></div>

<p>Did you remember the <a href="https://github.com/jonatas/rubocopular/blob/master/lib/rubocopular.rb#L14">test</a>
method I mentioned before?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(...)'</span><span class="p">,</span> <span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Cool, it matches with ‚Äúsomething with last children‚Äù.</p>

<p>Now let‚Äôs check if it‚Äôs a <code class="language-plaintext highlighter-rouge">:lvasg</code> aka local variable assignment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; nil</span>
</code></pre></div></div>

<p>It does not match because the node has parameters. Lets specify that it comes
with something else using the <code class="language-plaintext highlighter-rouge">...</code> shortcut:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn ...)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<h4 id="capturing">Capturing</h4>

<p>It‚Äôs hard sometimes to just understand based on <code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">false</code>. Let‚Äôs use
<code class="language-plaintext highlighter-rouge">$</code> to capture and go deeply in the comprehension:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn $...)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; [:a, s(:int, 1)]</span>
</code></pre></div></div>

<p>Cool! It captures the children.</p>

<p>Let‚Äôs ignore the variable name using <code class="language-plaintext highlighter-rouge">_</code> that for me represents ‚Äúone thing‚Äù,
I don‚Äôt care the name or value for a while.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ $...)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; [s(:int, 1)]</span>
</code></pre></div></div>

<p>We can also capture only the value:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (int $_)'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; 1</span>
</code></pre></div></div>

<p>Or the assigned node:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ $(int _))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; s(:int, 1)</span>
</code></pre></div></div>

<p>Or capture multiple things independently:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ ($int $_))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; [:int, 1]</span>
</code></pre></div></div>

<p>That‚Äôs cool no?</p>

<p>Let‚Äôs imagine we want to restrict our search for float or int:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (int _))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Testing the expression with a float will not work:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (int _))'</span><span class="p">,</span><span class="s1">'a = 1.0'</span><span class="p">)</span> <span class="c1"># =&gt; nil</span>
</code></pre></div></div>

<p>Now let‚Äôs introduce <code class="language-plaintext highlighter-rouge">{}</code> that we can union patterns:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ ({int float} _))'</span><span class="p">,</span><span class="s1">'a = 1.0'</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>And we can capture the type of the field as well:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (${int float} _))'</span><span class="p">,</span><span class="s1">'a = 1.0'</span><span class="p">)</span> <span class="c1"># =&gt; :float</span>
<span class="nb">test</span><span class="p">(</span><span class="s1">'(:lvasgn _ (${int float} _))'</span><span class="p">,</span><span class="s1">'a = 1'</span><span class="p">)</span> <span class="c1"># =&gt; :int</span>
</code></pre></div></div>

<p>This search thing was amazing for me, and I tried to encapsulate in a search 
command to allow me to search in code with this expression as I do with <code class="language-plaintext highlighter-rouge">grep</code> or <code class="language-plaintext highlighter-rouge">ag</code>.</p>

<p>The prototype is in <a href="https://github.com/jonatas/rubocopular">rubocopular</a> project too. I created the <code class="language-plaintext highlighter-rouge">bin/search</code> for
it:</p>

<p>The search command syntax is pretty simple:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/search 'pattern' *path-to-ruby-files
</code></pre></div></div>

<p>Let‚Äôs try something:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/search '(const ... )' lib/*.rb                                                                                                                  11:58:01
lib/rubocopular.rb:5: Rubocopular
lib/rubocopular.rb:7: RuboCop::ProcessedSource
lib/rubocopular.rb:11: RuboCop::ProcessedSource
lib/rubocopular.rb:11: IO
lib/rubocopular.rb:15: RuboCop::AST::Node
lib/rubocopular.rb:16: RuboCop::NodePattern
lib/rubocopular.rb:20: RuboCop::NodePattern
</code></pre></div></div>

<p>Nice, we can filter a bit more and search only for things under <code class="language-plaintext highlighter-rouge">RuboCop</code>
scope:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/search '(const nil :RuboCop ... )' lib/*.rb                                                                                                     11:59:09
lib/rubocopular.rb:7: RuboCop
lib/rubocopular.rb:11: RuboCop
lib/rubocopular.rb:15: RuboCop
lib/rubocopular.rb:16: RuboCop
lib/rubocopular.rb:20: RuboCop
</code></pre></div></div>

<p>It‚Äôs cool, but we can also do it with <code class="language-plaintext highlighter-rouge">grep</code>. The difference here is that we‚Äôre
listing the nodes not only the code, than we can print some multiline nodes.</p>

<p>Let‚Äôs print all check static methods defined in Rubocopular library:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/search '(defs ... )' lib/*.rb                                                                                                                   12:00:48
lib/rubocopular.rb:6: def self.node(code)
    RuboCop::ProcessedSource.new(code.to_s, 2.3).ast
  end
lib/rubocopular.rb:10: def self.parse_source(path)
    RuboCop::ProcessedSource.new(IO.read(path), 2.3, path)
  end
lib/rubocopular.rb:14: def self.test(pattern, code)
    code = node(code) unless code.is_a?(RuboCop::AST::Node)
    RuboCop::NodePattern.new(pattern).match(code)
  end
lib/rubocopular.rb:19: def self.inspect(pattern, code)
    RuboCop::NodePattern.new(pattern.gsub(/(\.{3}|_)/, '$\1')).match(node(code))
  end
</code></pre></div></div>

<p>Awesome, it works!</p>

<p>Thanks for reading until here. If you‚Äôre interested in AST search, I‚Äôm working
in another library that is my ‚Äúnode pattern‚Äù implementation running without
RuboCop dependency. The idea is just starting: https://github.com/jonatas/fast</p>

<p>You can do similar things with plain ruby code and arrays to build the matcher:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">match?</span><span class="p">(</span><span class="n">s</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">:a</span><span class="p">),</span> <span class="ss">:b</span><span class="p">),</span> <span class="p">[</span><span class="ss">:send</span><span class="p">,</span> <span class="s1">'...'</span><span class="p">]))</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>Checkout the <a href="https://github.com/jonatas/fast/blob/master/spec/fast_spec.rb#L48">current specs</a>.</p>

<p>In the next step, I‚Äôm thinking about do a <code class="language-plaintext highlighter-rouge">f()</code> for find and <code class="language-plaintext highlighter-rouge">c()</code> to capture things. Not sure
exactly how to proceed but the idea is something like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">match?</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="ss">:send</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">),</span> <span class="s1">'_'</span><span class="p">),</span> <span class="ss">:c</span><span class="p">),</span> <span class="s1">'_'</span><span class="p">)))</span> <span class="c1"># =&gt; s(:send, nil, :a)</span>
</code></pre></div></div>

<p>Any thoughts or ideas about how to be expressive in this search?</p>

</div>
<hr>

<div class="share-page">
  Compartilhar &rarr;
  <a href="https://twitter.com/intent/tweet?text=Search in Ruby AST&url=https://ideia.me/search-in-ruby-ast&via=jonatasdp&related=jonatasdp" rel="nofollow"title="Compartilhar on twitter">Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://ideia.me/search-in-ruby-ast" rel="nofollow" target="_blank" title="Compartilhar no Facebook">Facebook</a>
  <a href="https://plus.google.com/share?url=https://ideia.me/search-in-ruby-ast" rel="nofollow" target="_blank" title="Compartilhar no Google+">Google+</a>
</div>
<hr>
<div class="pagination">
    
      <span class="prev">
        <a href="/ruby-puzzle-gridlock" title="Gridlock game - solving with Ruby">&larr; Before</a>
      </span>
    
    | <span><a href="/archive.html">Archive</a></span> |
    
    <span class="next"><a href="/parsing-ruby-code" title="Parsing Ruby Code">Next &rarr;</a></span>
    
</div>
<hr>

<p>
  [pt-BR]
  <br />
  Ol√°, sou o J√¥natas Davi Paganini e esse √© meu blog. Sou programador, tenho alguns projetos no <a href="https://github.com/jonatas">github</a> e escrevo livremente <a href="/">aqui no ideia.me</a>.
  <br />
  [en]
  <br />
  Hello there, my name is J√¥natas Davi Paganini and this is my blog. I'm
  developer and I have a few projects on <a href="https://github.com/jonatas">github</a>
  and I freely write <a href="/">here at ideia.me</a>.
</p>
<p>Check my
  <a href="/talks">talks</a> or connect via
  <a href="https://twitter.com/jonatasdp" target="_blank">twitter</a> /
  <a href="https://github.com/jonatas" target="_blank">github</a> /
  <a href="https://instagram.com/jonatasdp" target="_blank">instagram</a> /
  <a href="https://fb.com/jonatas.paganini" target="_blank">facebook</a> /
  <a href="https://br.linkedin.com/in/jonatasdp" target="_blank">linkedin</a> /
  <a href="http://soundcloud.com/jonatasdp" target="_blank">soundcloud</a> /
  <a href="https://www.strava.com/athletes/12104550" target="_blank">strava</a> /
  <a href="http://www.meetup.com/members/185190193/" target="_blank">meetup</a>.
</p>



    </div>
  </body>
  <script type='text/javascript'>
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-12893758-1");
      pageTracker._trackPageview();
     } catch(err) {}
    </script>
</html>

