
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Ideia-me!</title>
    
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Immediate dark mode application to prevent flash -->
    <script>
      (function() {
        // Force dark mode for testing purposes
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.documentElement.classList.add('dark-mode');
          document.write('<style>body,html{background-color:#121212!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
        }
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- GitHub-style syntax highlighting -->
    <link href="/css/rouge-github.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/disqus-dark.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Ideia-me!
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      
<div class="container page-container">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <header class="page-header text-center mb-5 pt-3">
        <h1 class="display-4 fw-bold">Ideia-me!</h1>
        
      </header>
      
      <div class="page-content">
        
<div class="hero-section mb-5 p-4 rounded">
  <div class="row align-items-center">
    <div class="col-md-8">
      <p>
  Hello there, my name is Jônatas Davi Paganini and this is my personal blog.
  <br />
  I'm developer advocate at <a href="https://timescale.com">Timescale</a> and
  I also have a few open source projects on <a href="https://github.com/jonatas">github</a>.
</p>
<p>Check my
  <a href="/talks">talks</a> or connect with me via
  <a href="https://br.linkedin.com/in/jonatasdp" target="_blank">linkedin</a> /
  <a href="https://twitter.com/jonatasdp" target="_blank">twitter</a> /
  <a href="https://github.com/jonatas" target="_blank">github</a> /
  <a href="https://instagram.com/jonatasdp" target="_blank">instagram</a> /
  <a href="https://fb.com/jonatas.paganini" target="_blank">facebook</a> /
  <a href="https://www.strava.com/athletes/12104550" target="_blank">strava</a> /
  <a href="http://www.meetup.com/members/185190193/" target="_blank">meetup</a>.
</p>

    </div>
    <div class="col-md-4 text-center">
      <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini" class="profile-image img-fluid mb-3" style="max-width: 250px; border-radius: 10px; cursor: pointer;" title="Click me or hover for 3 seconds!" />
      <div class="social-links">
        <a href="https://github.com/jonatas" class="btn btn-outline-primary btn-sm me-2" target="_blank"><i class="bi bi-github"></i> GitHub</a>
        <a href="https://twitter.com/jonatasdp" class="btn btn-outline-primary btn-sm me-2" target="_blank"><i class="bi bi-twitter"></i> Twitter</a>
        <a href="https://linkedin.com/in/jonatasdp" class="btn btn-outline-primary btn-sm" target="_blank"><i class="bi bi-linkedin"></i> LinkedIn</a>
      </div>
    </div>
  </div>
</div>

<div class="featured-content p-4 rounded mb-5">
  <h2 class="h3 fw-bold mb-4">Featured Content</h2>
  <div class="row">
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h3 class="h5 card-title">Latest Talks</h3>
          <p class="card-text">Explore my recent presentations at conferences and meetups around the world.</p>
          <a href="/talks" class="btn btn-light animated-link">View Talks <i class="bi bi-arrow-right"></i></a>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h3 class="h5 card-title">Technical Articles</h3>
          <p class="card-text">Deep dives into PostgreSQL, TimescaleDB, Ruby, and more.</p>
          <a href="/categories.html#technical-ref" class="btn btn-light animated-link">Read Articles <i class="bi bi-arrow-right"></i></a>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h3 class="h5 card-title">Community Insights</h3>
          <p class="card-text">Thoughts on building and nurturing tech communities.</p>
          <a href="/categories.html#community-ref" class="btn btn-light animated-link">Explore <i class="bi bi-arrow-right"></i></a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="latest-post mb-5">
  <h2 class="h3 fw-bold border-bottom pb-3 mb-4">Latest Post</h2>
  
  <div class="card latest-post-card">
    <div class="card-body">
      <h3 class="card-title h2">
        <a class="post animated-link" href="/benchmarking-ruby-orms">Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</a>
      </h3>
      <p class="card-subtitle text-muted mb-3">
        <i class="bi bi-calendar3"></i> March 19, 2025
        
        <span class="ms-3">
          
          <span class="badge bg-primary">ruby</span>
          
          <span class="badge bg-primary">postgresql</span>
          
          <span class="badge bg-primary">performance</span>
          
        </span>
        
      </p>
      <div class="card-text">
        <p>Hey Ruby friends! This year I’m super excited to offer a PostgreSQL Performance Workshop for Rubyists. I already ran the first one at the <a href="https://rubycommunityconference.com">Ruby Community Conference</a>, and it was a blast!</p>

<p>I wanted to share some key learnings we discovered during the workshop and reflect on how our technology choices impact performance. I’m particularly interested in how we can mix technologies to keep all the conveniences Rails offers while still achieving fast execution and low memory footprint for those high-throughput bottlenecks we all struggle with.</p>

<p><img src="/images/postgresql-performance-workshop.webp" alt="Performance Workshop" title="Performance Workshop ORMs comparison" /></p>

<p>With Ruby 3.3’s impressive performance improvements and Rails 8’s focus on speed, I’ve been watching the ORM performance landscape evolve rapidly. The benchmarks I’ve been running show up to 70% faster Ruby code execution with YJIT in Ruby 3.3, but I kept wondering: how does this translate to real-world database operations? As our applications scale and data grows, choosing the right ORM strategy becomes more critical than ever.</p>

<p>In this post, I’ll dive into the latest performance differences I found between ActiveRecord and Sequel when working with TimescaleDB, a specialized PostgreSQL extension for time-series data. My benchmarks were conducted using Ruby 3.3.6 and the latest versions of both ORMs, and honestly, I was surprised by some of the insights about when and why certain approaches outperform others.</p>

<h2 id="the-orm-performance-benchmark-challenge">The ORM Performance Benchmark Challenge</h2>

<p>My no-brain choice is always ActiveRecord but for the Performance workshop, I started collecting also information in reddit and I decided to also build comparison between different ORMs for the workshop. Each ORM offers unique features, syntax, and performance characteristics. The benchmarks I’m sharing aim to provide insights into these performance differences to help you make informed decisions for your projects.</p>

<p>It’s important to note that these benchmarks focus purely on execution time and memory usage - they don’t account for developer productivity, which is a crucial factor when choosing an ORM. While Sequel may outperform ActiveRecord in raw speed for certain operations, ActiveRecord’s integration with Rails and familiar syntax can significantly reduce development time. The true cost of an ORM includes both execution performance and the time developers spend writing and maintaining code.</p>

<p>Let’s check out the results from my benchmarking tests:</p>

<h3 id="query-types-performance-operations-per-second">Query Types Performance (operations per second)</h3>

<table>
  <thead>
    <tr>
      <th>Operation Type</th>
      <th>ActiveRecord</th>
      <th>Sequel</th>
      <th>Raw SQL</th>
      <th>Key Insights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Simple Select</td>
      <td>82.6</td>
      <td>10,178.6</td>
      <td>12,450.2</td>
      <td>Sequel is ~123x faster than ActiveRecord for simple queries</td>
    </tr>
    <tr>
      <td>Complex Joins</td>
      <td>28.7</td>
      <td>93.3</td>
      <td>105.1</td>
      <td>Sequel offers ~3.3x better performance for complex joins</td>
    </tr>
    <tr>
      <td>Aggregations</td>
      <td>220.2</td>
      <td>164.0</td>
      <td>245.3</td>
      <td>ActiveRecord optimizes count operations well</td>
    </tr>
    <tr>
      <td>Bulk Inserts</td>
      <td>215.7</td>
      <td>272.6</td>
      <td>310.4</td>
      <td>Specialized bulk operations are critical for insert performance</td>
    </tr>
    <tr>
      <td>JSON Operations</td>
      <td>145.3</td>
      <td>188.9</td>
      <td>195.7</td>
      <td>Native JSON operators improve performance across all approaches</td>
    </tr>
  </tbody>
</table>

<h3 id="memory-usage-patterns-mb">Memory Usage Patterns (MB)</h3>

<table>
  <thead>
    <tr>
      <th>Operation Type</th>
      <th>ActiveRecord</th>
      <th>Sequel</th>
      <th>Raw SQL</th>
      <th>Key Insights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Large Result Set</td>
      <td>125</td>
      <td>45</td>
      <td>30</td>
      <td>ActiveRecord objects consume ~2.8x more memory than Sequel</td>
    </tr>
    <tr>
      <td>Batch Processing</td>
      <td>60</td>
      <td>35</td>
      <td>25</td>
      <td>Using <code class="language-plaintext highlighter-rouge">find_each</code> with ActiveRecord helps control memory usage</td>
    </tr>
    <tr>
      <td>JSON Processing</td>
      <td>80</td>
      <td>50</td>
      <td>45</td>
      <td>JSONB is more memory-efficient than standard JSON</td>
    </tr>
    <tr>
      <td>Aggregations</td>
      <td>40</td>
      <td>35</td>
      <td>30</td>
      <td>Memory patterns are similar for aggregation operations</td>
    </tr>
  </tbody>
</table>

<h2 id="key-findings-from-the-benchmark">Key Findings from the Benchmark</h2>

<p>Before diving into the detailed results, I want to share some key insights from my benchmarking study. These findings represent patterns I observed across multiple test scenarios and real-world applications I’ve worked on.</p>

<p><img src="/images/jonatas-paganini-jeremy-evans-polished-ruby-book-rubyconf-thailand-2023.jpeg" alt="Jeremy Evans and I discussing Ruby performance at RubyConf Thailand" title="Meeting with Jeremy Evans, the creator of Sequel, at RubyConf Thailand 2023" /></p>

<p>I had the incredible privilege of meeting Jeremy Evans (that’s us in the photo above), the creator of Sequel and author of “Polished Ruby Programming,” at RubyConf Thailand 2023. His insights have been invaluable in helping me understand the design decisions that make Sequel so performant in many scenarios.</p>

<p>My benchmarks revealed several consistent patterns:</p>

<ol>
  <li>
    <p><strong>Sequel excels at raw speed for simple queries</strong> - For basic CRUD operations, I consistently saw Sequel outperform ActiveRecord by significant margins, often 10-100x faster for simple selects. This blew my mind the first time I measured it!</p>
  </li>
  <li>
    <p><strong>ActiveRecord shines with complex associations</strong> - When I worked with deeply nested associations and complex Rails-integrated workflows, ActiveRecord’s eager loading optimizations sometimes outperformed manual Sequel approaches. This makes sense given Rails’ tight integration.</p>
  </li>
  <li>
    <p><strong>Memory usage is often the limiting factor</strong> - In my high-throughput applications, I found that memory consumption frequently becomes the bottleneck before query speed, making lightweight ORMs particularly valuable. I’ve experienced this pain point firsthand in production.</p>
  </li>
  <li>
    <p><strong>Bulk operations provide the biggest performance gains</strong> - Regardless of which ORM I chose, using bulk operations instead of row-by-row processing offered the most dramatic performance improvements. This was consistent across all my tests.</p>
  </li>
  <li>
    <p><strong>TimescaleDB optimizations amplify performance differences</strong> - When I worked with time-series data in TimescaleDB, I noticed the performance gap between optimized and unoptimized queries grows even wider.</p>
  </li>
</ol>

<p>Let’s examine these findings in more detail with specific benchmark results I captured:</p>

<h3 id="1-batch-processing-comparison">1. Batch Processing Comparison</h3>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Time</th>
      <th>Queries</th>
      <th>Rate</th>
      <th>Relative Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Processing all records at once</td>
      <td>10.342 s</td>
      <td>90,001</td>
      <td>2.9k/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>Using find_each with default batch size</td>
      <td>9.657 s</td>
      <td>90,031</td>
      <td>3.1k/s</td>
      <td>1.1x faster</td>
    </tr>
    <tr>
      <td>Using find_each with custom batch size</td>
      <td>9.441 s</td>
      <td>90,031</td>
      <td>3.2k/s</td>
      <td>1.1x faster</td>
    </tr>
    <tr>
      <td>Using update_all</td>
      <td>0.282 s</td>
      <td>1</td>
      <td>106.4k/s</td>
      <td>36.6x faster</td>
    </tr>
  </tbody>
</table>

<p>The results are clear: bulk operations like <code class="language-plaintext highlighter-rouge">update_all</code> are dramatically faster (36.6x) but bypass ActiveRecord callbacks and validations. I’ve found this represents a common trade-off I need to make between performance and application logic. Sometimes I choose performance, sometimes I need those callbacks!</p>

<h3 id="2-bulk-insert-performance">2. Bulk Insert Performance</h3>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Time</th>
      <th>Queries</th>
      <th>Rate</th>
      <th>Relative Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Individual inserts</td>
      <td>0.041 s</td>
      <td>300</td>
      <td>2.4k/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>Bulk insert with insert_all</td>
      <td>0.002 s</td>
      <td>1</td>
      <td>50.0k/s</td>
      <td>22.0x faster</td>
    </tr>
  </tbody>
</table>

<p>I was amazed to see bulk inserts are 22x faster than individual inserts, with a 300:1 query reduction. This demonstrates how reducing the number of database roundtrips can dramatically improve performance. I use this technique all the time now.</p>

<h3 id="3-upsert-performance">3. Upsert Performance</h3>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Time</th>
      <th>Queries</th>
      <th>Rate</th>
      <th>Relative Speed</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Individual find_or_create_by</td>
      <td>0.049 s</td>
      <td>400</td>
      <td>2.0k/s</td>
      <td>baseline</td>
    </tr>
    <tr>
      <td>Bulk upsert with insert_all</td>
      <td>0.002 s</td>
      <td>1</td>
      <td>47.1k/s</td>
      <td>29.5x faster</td>
    </tr>
    <tr>
      <td>Sequel upsert</td>
      <td>0.002 s</td>
      <td>2</td>
      <td>46.8k/s</td>
      <td>23.2x faster</td>
    </tr>
  </tbody>
</table>

<p>Both ActiveRecord’s <code class="language-plaintext highlighter-rouge">upsert_all</code> and Sequel’s bulk upsert mechanisms offered similar performance benefits in my tests, showing ~25-30x improvement over individual operations. This is huge when you’re processing lots of data!</p>

<h3 id="5-memory-optimization-with-occamsrecord">5. Memory Optimization with OccamsRecord</h3>

<p>OccamsRecord was another gem I learned on reddit when I created my thread and it was amazing that I added it to the benchmark.  This blew my mind - the memory savings here are insane:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Standard ActiveRecord (27.30 MB allocated, 68.34 KB retained)</span>
<span class="n">users_data</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="p">{</span>
    <span class="ss">name: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
    <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
    <span class="ss">post_count: </span><span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># OccamsRecord (16.03 MB allocated, 16.30 KB retained)</span>
<span class="n">users_data</span> <span class="o">=</span> <span class="no">OccamsRecord</span>
  <span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">run</span>
  <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="p">{</span>
    <span class="ss">name: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
    <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
    <span class="ss">post_count: </span><span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span>
  <span class="p">}}</span>
</code></pre></div></div>

<h4 id="understanding-memory-allocation-metrics">Understanding Memory Allocation Metrics</h4>

<p>When looking at the memory metrics above, it’s important to understand the difference between “allocated” and “retained” memory:</p>

<ul>
  <li>
    <p><strong>Allocated Memory</strong>: The total amount of memory requested from the system during execution. This includes all temporary objects created and later discarded.</p>
  </li>
  <li>
    <p><strong>Retained Memory</strong>: The memory that remains in use after the operation completes and isn’t released back to the system. This represents the “memory footprint” that persists.</p>
  </li>
</ul>

<p>High allocation with low retention (like in the OccamsRecord example) indicates efficient garbage collection - objects are created but quickly discarded when no longer needed. This pattern is ideal for memory-intensive operations, as it reduces the risk of memory bloat and out-of-memory errors in production.</p>

<p>The dramatic difference in retained memory (68.34 KB vs 16.30 KB) shows why OccamsRecord can be a game-changer for memory-constrained environments or when processing large datasets.</p>

<h2 id="interactive-benchmarking-examples">Interactive Benchmarking Examples</h2>

<p>You can run these benchmark examples yourself to see the performance differences. Here’s how I set up my benchmarks:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Simple Query Performance</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">1</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - all"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - all"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - where"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">).</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - where"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">where</span><span class="p">(</span><span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">).</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For complex joins, I used:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Complex Join Performance</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">1</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - complex join"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">posts: :comments</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s1">'users.*, COUNT(DISTINCT posts.id) as posts_count, COUNT(comments.id) as comments_count'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s1">'users.id'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - complex join"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
      <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="ss">:posts</span><span class="p">,</span> <span class="ss">user_id: :id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="ss">:comments</span><span class="p">,</span> <span class="ss">post_id: </span><span class="no">Sequel</span><span class="p">[</span><span class="ss">:posts</span><span class="p">][</span><span class="ss">:id</span><span class="p">])</span>
      <span class="p">.</span><span class="nf">select</span><span class="p">(</span>
        <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:id</span><span class="p">],</span>
        <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:name</span><span class="p">],</span>
        <span class="no">Sequel</span><span class="p">.</span><span class="nf">function</span><span class="p">(</span><span class="ss">:count</span><span class="p">,</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:posts</span><span class="p">][</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">as</span><span class="p">(</span><span class="ss">:posts_count</span><span class="p">),</span>
        <span class="no">Sequel</span><span class="p">.</span><span class="nf">function</span><span class="p">(</span><span class="ss">:count</span><span class="p">,</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:comments</span><span class="p">][</span><span class="ss">:id</span><span class="p">]).</span><span class="nf">as</span><span class="p">(</span><span class="ss">:comments_count</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:id</span><span class="p">],</span> <span class="no">Sequel</span><span class="p">[</span><span class="ss">:users</span><span class="p">][</span><span class="ss">:name</span><span class="p">])</span>
      <span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And for bulk operations, I tested:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bulk Operation Performance</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">1</span><span class="p">)</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - bulk insert"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">insert_all</span><span class="p">((</span><span class="mi">1</span><span class="o">..</span><span class="mi">100</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> 
      <span class="p">{</span> <span class="ss">name: </span><span class="s2">"User </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"user</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span> <span class="p">}</span>
    <span class="p">})</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - bulk insert"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">].</span><span class="nf">multi_insert</span><span class="p">((</span><span class="mi">1</span><span class="o">..</span><span class="mi">100</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> 
      <span class="p">{</span> <span class="ss">name: </span><span class="s2">"User </span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">email: </span><span class="s2">"user</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">@example.com"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span> <span class="p">}</span>
    <span class="p">})</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="n1-query-prevention">N+1 Query Prevention</h2>

<p>The infamous N+1 query problem is something I’ve battled many times. It can severely impact application performance. My benchmarks with 1000 users (each with 10 posts and 5 comments per post) showed:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bad - N+1 Query (51 queries, 0.01s)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">count</span>  <span class="c1"># N+1 query for each user</span>
<span class="k">end</span>

<span class="c1"># Good - Eager Loading (2 queries, 0.02s)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">length</span>  <span class="c1"># No additional queries</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="best-practices-for-orm-performance">Best Practices for ORM Performance</h2>

<p>Based on my benchmarks, I’ve compiled some best practices that I now use for optimizing ORM performance:</p>

<h3 id="1-batch-processing">1. Batch Processing</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inefficient</span>
<span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">user</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">status: </span><span class="s1">'active'</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># Efficient (36x faster)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">update_all</span><span class="p">(</span><span class="ss">status: </span><span class="s1">'active'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="2-bulk-operations">2. Bulk Operations</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inefficient</span>
<span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

<span class="c1"># Efficient (22x faster)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">insert_all</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="3-query-optimization">3. Query Optimization</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inefficient</span>
<span class="no">User</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">posts: </span><span class="p">{</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">week</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span> <span class="p">})</span>
    <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s2">"users.id"</span><span class="p">).</span><span class="nf">having</span><span class="p">(</span><span class="s2">"COUNT(posts.id) &gt; 5"</span><span class="p">)</span>

<span class="c1"># Efficient (1.2x faster)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">joins</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"users.*, COUNT(posts.id) as posts_count"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">posts: </span><span class="p">{</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">week</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span> <span class="p">})</span>
    <span class="p">.</span><span class="nf">group</span><span class="p">(</span><span class="s2">"users.id"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">having</span><span class="p">(</span><span class="s2">"COUNT(posts.id) &gt; 5"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="4-upsert-operations">4. Upsert Operations</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Inefficient</span>
<span class="n">records</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">record</span><span class="o">|</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">find_or_create_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">record</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>
<span class="k">end</span>

<span class="c1"># Efficient (29.5x faster)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">upsert_all</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="ss">unique_by: :email</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="5-memory-optimization-with-occamsrecord-1">5. Memory Optimization with OccamsRecord</h3>

<p>I still can’t get over how much memory this saves:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Standard ActiveRecord (27.30 MB allocated, 68.34 KB retained)</span>
<span class="n">users_data</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="p">{</span>
    <span class="ss">name: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
    <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
    <span class="ss">post_count: </span><span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="c1"># OccamsRecord (16.03 MB allocated, 16.30 KB retained)</span>
<span class="n">users_data</span> <span class="o">=</span> <span class="no">OccamsRecord</span>
  <span class="p">.</span><span class="nf">query</span><span class="p">(</span><span class="no">User</span><span class="p">.</span><span class="nf">all</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">eager_load</span><span class="p">(</span><span class="ss">:posts</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">run</span>
  <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="p">{</span>
    <span class="ss">name: </span><span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span>
    <span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
    <span class="ss">post_count: </span><span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span>
  <span class="p">}}</span>
</code></pre></div></div>

<h2 id="join-me-for-postgresql-performance-optimization-at-tropical-on-rails-2025">Join Me for PostgreSQL Performance Optimization at Tropical on Rails 2025!</h2>

<p>Want to dive deeper into these concepts and learn how to optimize your Ruby applications with PostgreSQL? Come hang out with me at my upcoming <strong>PostgreSQL Performance for Ruby Developers</strong> workshop at Tropical on Rails 2025!</p>

<p>The workshop is based on our PostgreSQL Performance course, which has helped hundreds of developers optimize their database interactions and improve application performance. I’ve refined it based on feedback from previous sessions.</p>

<h3 id="workshop-details">Workshop Details:</h3>
<ul>
  <li><strong>When</strong>: April 2nd, 2025 -  2 PM to 6 PM</li>
  <li><strong>Language</strong>: English</li>
  <li><strong>Location</strong>: São Paulo, Brazil</li>
</ul>

<p><a href="https://www.tropicalonrails.com/#workshops"><img src="/images/banners/tropicalonrails-2025-banner.png" alt="Tropical On Rails Banner" /></a></p>

<p><a href="https://www.tropicalonrails.com/#workshops">Register for the workshop</a></p>

<h2 id="my-conclusions">My Conclusions</h2>

<p>The choice between ActiveRecord and Sequel isn’t always straightforward. While I’ve found Sequel generally offers better raw performance, especially for simple queries, ActiveRecord provides better integration with the Rails ecosystem and a more Ruby-like syntax that I love.</p>

<p>Here’s what I consider when choosing an ORM:</p>
<ol>
  <li>I use Sequel for performance-critical, data-intensive operations</li>
  <li>I stick with ActiveRecord for standard CRUD and Rails integration</li>
  <li>Sometimes I use both in the same application where appropriate (yes, this works!)</li>
  <li>I always profile my specific use case before committing to an ORM</li>
  <li>I use bulk operations whenever possible for better performance</li>
</ol>

<p>Remember that the best ORM for your application depends on your specific requirements and constraints. My benchmarks provide a starting point for your decision-making process, but your mileage may vary!</p>

<p>What’s your experience with ORM performance? I’d love to hear your thoughts in the comments. And if you’re interested in diving deeper, join me at Tropical on Rails 2025 to continue the conversation!</p>

<h2 id="more-benchmarking-techniques">More Benchmarking Techniques</h2>

<p>During our <strong>PostgreSQL Performance for Ruby Developers</strong> workshop, I’ll dive deeper into advanced benchmarking techniques that go beyond simple comparisons. Here’s a preview of what you’ll learn:</p>

<h3 id="1-profiling-database-queries-with-timescaledb">1. Profiling Database Queries with TimescaleDB</h3>

<p>TimescaleDB extends PostgreSQL with specialized time-series capabilities that can dramatically improve performance for certain workloads. I use this approach all the time:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Standard PostgreSQL time-series query</span>
<span class="n">readings</span> <span class="o">=</span> <span class="no">SensorReading</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">created_at: </span><span class="mi">30</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">group_by_day</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">average</span><span class="p">(</span><span class="ss">:temperature</span><span class="p">)</span>
  <span class="c1"># Can take several seconds with millions of records</span>

<span class="c1"># With TimescaleDB optimizations</span>
<span class="n">readings</span> <span class="o">=</span> <span class="no">SensorReading</span>
  <span class="p">.</span><span class="nf">from</span><span class="p">(</span><span class="s2">"sensor_readings_1h_summary"</span><span class="p">)</span> <span class="c1"># Pre-aggregated hypertable</span>
  <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">bucket: </span><span class="mi">30</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">select</span><span class="p">(</span><span class="s2">"bucket, avg_temperature"</span><span class="p">)</span>
  <span class="c1"># Returns in milliseconds regardless of underlying data volume</span>
</code></pre></div></div>

<h3 id="2-real-world-memory-management-techniques">2. Real-world Memory Management Techniques</h3>

<p>I’ll share practical techniques I’ve used for managing memory in Ruby applications with large datasets:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Memory-efficient processing of large result sets</span>
<span class="no">CSV</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s2">"large_report.csv"</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">csv</span><span class="o">|</span>
  <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="s2">"ID"</span><span class="p">,</span> <span class="s2">"Name"</span><span class="p">,</span> <span class="s2">"Email"</span><span class="p">,</span> <span class="s2">"Post Count"</span><span class="p">]</span>
  
  <span class="c1"># Stream results to avoid loading everything into memory</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="ss">:posts</span><span class="p">).</span><span class="nf">find_each</span><span class="p">(</span><span class="ss">batch_size: </span><span class="mi">1000</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="n">csv</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="nf">posts</span><span class="p">.</span><span class="nf">size</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="3-query-building-approaches-for-better-performance">3. Query Building Approaches for Better Performance</h3>

<p>Here’s how different query building approaches affected performance in my testing:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Benchmark Query Building Approaches</span>
<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">config</span><span class="p">(</span><span class="ss">time: </span><span class="mi">2</span><span class="p">,</span> <span class="ss">warmup: </span><span class="mi">1</span><span class="p">)</span>

  <span class="n">conditions</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">created_at: </span><span class="mi">1</span><span class="p">.</span><span class="nf">day</span><span class="p">.</span><span class="nf">ago</span><span class="o">..</span><span class="no">Time</span><span class="p">.</span><span class="nf">current</span> <span class="p">}</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="s2">"%test%"</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"ActiveRecord - method chain"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"name LIKE ?"</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="ss">created_at: :desc</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">to_a</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"Sequel - method chain"</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DB</span><span class="p">[</span><span class="ss">:users</span><span class="p">]</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">conditions</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="no">Sequel</span><span class="p">.</span><span class="nf">like</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>
      <span class="p">.</span><span class="nf">order</span><span class="p">(</span><span class="no">Sequel</span><span class="p">.</span><span class="nf">desc</span><span class="p">(</span><span class="ss">:created_at</span><span class="p">))</span>
      <span class="p">.</span><span class="nf">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="resources">Resources</h2>

<ol>
  <li><a href="https://github.com/timescale/timescaledb-ruby">TimescaleDB Ruby Gem</a></li>
  <li><a href="https://github.com/timescale/postgresql-performance-for-rubyists">PostgreSQL Performance Workshop for Rubyists</a></li>
  <li><a href="https://github.com/jeremyevans/sequel">Sequel Documentation</a></li>
  <li><a href="https://guides.rubyonrails.org/active_record_querying.html">ActiveRecord Query Interface</a></li>
  <li><a href="https://github.com/jhollinger/occams-record">OccamsRecord</a></li>
</ol>

<h3 id="practical-insights-from-community-experience">Practical Insights from Community Experience</h3>

<p>From discussions I’ve had on reddit, several patterns emerged regarding real-world usage:</p>

<ol>
  <li>
    <p><strong>Sequel shines for raw data operations</strong><br />
Developers consistently report to me 3-10x performance improvements when using Sequel for data-intensive operations, especially with large datasets.</p>
  </li>
  <li>
    <p><strong>ActiveRecord remains king for typical web apps</strong><br />
For standard CRUD operations in typical web applications, I’ve seen that ActiveRecord’s integration with Rails often outweighs the raw performance benefits of alternatives.</p>
  </li>
  <li>
    <p><strong>Memory management is crucial for scaling</strong><br />
Many teams I’ve worked with discovered that memory usage, not query speed, was their primary bottleneck when scaling applications.</p>
  </li>
  <li>
    <p><strong>Mixed approaches are increasingly common</strong><br />
More teams I talk to are adopting hybrid approaches, using different ORMs for different parts of their application based on specific performance requirements.</p>
  </li>
  <li>
    <p><strong>Specialized gems fill performance gaps</strong><br />
Tools like OccamsRecord, BatchLoader, and ar_lazy_preload are frequently mentioned in my conversations as solutions for specific performance challenges while remaining in the ActiveRecord ecosystem.</p>
  </li>
</ol>

<p>These real-world experiences highlight the importance of benchmarking your specific use cases rather than relying solely on general recommendations.</p>

<h2 id="take-your-postgresql-performance-to-the-next-level">Take Your PostgreSQL Performance to the Next Level!</h2>

<p>Looking for even more dramatic performance improvements in your Ruby + PostgreSQL applications? Check out the <a href="https://github.com/timescale/timescaledb-ruby">timescaledb gem</a> that I maintain! This powerful extension enables time-series data optimization, hypertables, and advanced query capabilities that can deliver 10-100x performance gains for time-series workloads.</p>

<p>As a maintainer, I’ve seen teams transform their application performance with minimal code changes. Drop me a message if you have questions or need implementation advice - I love helping people optimize their database performance!</p>

<p>👉 <strong><a href="https://github.com/timescale/timescaledb-ruby">Get started with TimescaleDB for Ruby today!</a></strong></p>

      </div>
    </div>
  </div>
  
</div>

<div class="post-list">
  <h2 class="h3 fw-bold border-bottom pb-3 mb-4">Recent Posts</h2>
  <div class="list-group post-list-group">
    
    <a href="/benchmarking-ruby-orms" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> March 19, 2025
          
          <span class="ms-3">
            
            <span class="badge bg-primary">ruby</span>
            
            <span class="badge bg-primary">postgresql</span>
            
            <span class="badge bg-primary">performance</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/programming-is-a-drug" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">Programming is a Drug: How AI Amplified My 20-Year Coding Addiction</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> March 18, 2025
          
          <span class="ms-3">
            
            <span class="badge bg-primary">personal</span>
            
            <span class="badge bg-primary">technical</span>
            
            <span class="badge bg-primary">ai</span>
            
            <span class="badge bg-primary">tools</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/soulless-economy" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">The Souless Economy - How AI Agents will change our economy completely</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> November 22, 2024
          
          <span class="ms-3">
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/timescaledb-gem-continuous-aggregates-updates" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">TimescaleDB Gem Continuous Aggregates Updates</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> October 07, 2024
          
          <span class="ms-3">
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/my-first-contribution-to-rubygems" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">My First Contribution To Rubygems</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> July 04, 2024
          
          <span class="ms-3">
            
            <span class="badge bg-primary">time-series</span>
            
            <span class="badge bg-primary">timescaledb</span>
            
            <span class="badge bg-primary">opensource</span>
            
            <span class="badge bg-primary">performance</span>
            
            <span class="badge bg-primary">ruby</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/grepping-sql-code-like-a-boss" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">Grepping SQL Code like a boss</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> May 27, 2024
          
          <span class="ms-3">
            
            <span class="badge bg-primary">talk</span>
            
            <span class="badge bg-primary">sql</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/postgresql-for-everything" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">PostgreSQL for Everything!</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> May 22, 2024
          
          <span class="ms-3">
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/website-seo-improvements-and-category-standardization" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">Enhancing Website Consistency and SEO: A Technical Journey</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> March 10, 2024
          
          <span class="ms-3">
            
            <span class="badge bg-primary">website</span>
            
            <span class="badge bg-primary">technical</span>
            
            <span class="badge bg-primary">seo</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/website-revamp-and-recent-talks" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">Website Revamp and Recent Speaking Adventures</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> March 09, 2024
          
          <span class="ms-3">
            
            <span class="badge bg-primary">website</span>
            
            <span class="badge bg-primary">community</span>
            
            <span class="badge bg-primary">talks</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
    <a href="/community-is-not-for-sale" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-1">Community is not for Sale</h5>
        <small class="text-muted">
          <i class="bi bi-calendar3"></i> March 01, 2024
          
          <span class="ms-3">
            
            <span class="badge bg-primary">community</span>
            
          </span>
          
        </small>
      </div>
      <span class="badge bg-light text-dark rounded-pill">
        <i class="bi bi-arrow-right"></i>
      </span>
    </a>
    
  </div>
  <div class="text-center mt-4">
    <a href="/archive.html" class="btn btn-primary">View All Posts <i class="bi bi-journal-text"></i></a>
  </div>
</div>

      </div>
    </div>
  </div>
</div>


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.documentElement.classList.add('dark-mode');
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
              console.log('Dark mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            } else {
              document.documentElement.classList.remove('dark-mode');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
              console.log('Light mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            }
            
            // Force reload the page to ensure all styles are applied correctly
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
        }
        
        // Apply highlighting to code blocks after content loads
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Configure Disqus for dark mode if needed
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        if (isDarkMode) {
          // Insert dark mode CSS for Disqus
          const style = document.createElement('style');
          style.innerHTML = `
            #disqus_thread {
              background-color: #1e1e1e !important;
              color: #f0f2f5 !important;
              padding: 20px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            }
          `;
          document.head.appendChild(style);
          
          // Set Disqus config variable for dark mode
          window.disqus_config = function() {
            this.page.identifier = window.location.pathname;
            this.page.url = window.location.href;
            this.language = 'en';
            this.sso = {
              name: 'SiteName',
            };
            this.callbacks.onReady = [function() {
              const interval = setInterval(function() {
                if (document.getElementById('dsq-app2')) {
                  clearInterval(interval);
                  const disqusIframe = document.getElementById('dsq-app2');
                  disqusIframe.contentWindow.postMessage({
                    name: 'setTheme',
                    data: 'dark',
                  }, '*');
                }
              }, 100);
            }];
          };
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
    
    <!-- Disqus Dark Mode Handler -->
    <script>
      // Function to handle Disqus dark mode
      function setupDisqusDarkMode() {
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        // Add a style element to target the Disqus iframe
        const disqusStyle = document.createElement('style');
        disqusStyle.innerHTML = `
          html.dark-mode iframe, body.dark-mode iframe {
            color-scheme: dark !important;
          }
          
          html.dark-mode #disqus_thread, body.dark-mode #disqus_thread {
            background-color: #1e1e1e !important;
            color: #f0f2f5 !important;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        `;
        document.head.appendChild(disqusStyle);
        
        // Check for Disqus iframe and inject dark styles if needed
        const checkForDisqus = setInterval(() => {
          const disqusThread = document.getElementById('disqus_thread');
          const disqusIframes = document.querySelectorAll('iframe[src*="disqus.com"]');
          
          if (disqusThread || disqusIframes.length > 0) {
            clearInterval(checkForDisqus);
            
            if (isDarkMode) {
              // Try to signal Disqus to use dark theme
              if (window.DISQUS) {
                try {
                  window.DISQUS.host._loadEmbed({
                    color: 'dark',
                  });
                } catch (e) {
                  console.log('Could not set Disqus theme via API');
                }
              }
              
              // Direct CSS approach to all iframes
              disqusIframes.forEach(iframe => {
                try {
                  // Try to access the iframe document
                  const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                  
                  // Add dark mode classes and styles
                  if (iframeDocument.body) {
                    iframeDocument.body.classList.add('dark-mode');
                    
                    const darkStyle = iframeDocument.createElement('style');
                    darkStyle.textContent = `
                      body { background-color: #1e1e1e !important; color: #f0f2f5 !important; }
                      .textarea-wrapper, .post-actions, .alert { background-color: #2a2d31 !important; }
                      .wysiwyg__placeholder, input, textarea { color: #f0f2f5 !important; }
                      .publisher-background-color { background-color: #1e1e1e !important; }
                      .publisher-border-color { border-color: rgba(255, 255, 255, 0.1) !important; }
                      .publisher-anchor-color, a { color: #5c9eff !important; }
                    `;
                    iframeDocument.head.appendChild(darkStyle);
                  }
                } catch (e) {
                  console.log('Could not modify Disqus iframe due to CORS policy');
                  
                  // Add a fallback with filter approach
                  if (isDarkMode) {
                    // Apply a CSS filter to invert the colors
                    iframe.style.filter = 'invert(92%) hue-rotate(180deg)';
                  }
                }
              });
            }
          }
        }, 500);
      }
      
      // Run setup when DOM is loaded and after any content changes
      document.addEventListener('DOMContentLoaded', setupDisqusDarkMode);
      document.addEventListener('ajaxComplete', setupDisqusDarkMode);
      
      // Also run after a delay in case Disqus loads later
      setTimeout(setupDisqusDarkMode, 2000);
      setTimeout(setupDisqusDarkMode, 5000);
    </script>
    
    <!-- Dedicated Disqus dark mode handler -->
    <script src="/js/disqus-dark.js"></script>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        // Check saved preference first
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Apply theme based on saved preference or system preference
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
          console.log('Dark mode applied on initial load');
        } else {
          document.body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
          console.log('Light mode applied on initial load');
        }
        
        // Listen for changes in the OS color scheme only if no saved preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          // Only apply system preference if user hasn't manually chosen a theme
          if (localStorage.getItem('theme') === null) {
            const newColorScheme = e.matches ? 'dark' : 'light';
            if (newColorScheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.documentElement.classList.add('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = true;
              console.log('Dark mode applied from system preference change');
            } else {
              document.body.classList.remove('dark-mode');
              document.documentElement.classList.remove('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = false;
              console.log('Light mode applied from system preference change');
            }
          }
        });
      }

      // Initialize dark mode immediately before DOM content is fully loaded
      detectColorScheme();
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
      });
    </script>
  </body>
</html>

