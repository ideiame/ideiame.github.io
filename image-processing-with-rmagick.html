
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Image processing with Ruby</title>
    <meta name="description" content="During my vacations, I decide to play in a different project. I'd like to make some hashi art with packs of used chopsticks my girlfriend is collecting from ...">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Immediate dark mode application to prevent flash -->
    <script>
      (function() {
        // Force dark mode for testing purposes
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.documentElement.classList.add('dark-mode');
          document.write('<style>body,html{background-color:#121212!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
        }
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- GitHub-style syntax highlighting -->
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/disqus-dark.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Image processing with Ruby
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>Image processing with Ruby</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> January 06, 2019</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 11 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>During my vacations, I decide to play in a different project. I’d like to make
some hashi art with packs of used chopsticks my girlfriend is collecting from the Japanese restaurant that she works.</p>

<p>We have hundreds and will reach thousands of chopsticks collected soon. We cleaned them to reuse in some art and we decide to build a plaque with holes that could
potentially turn into some art.</p>

<p>The project is pretty simple, we got a random stencil image from the web, and we
want to convert the painted black part into dots. Like this image:</p>

<p><img src="/images/skull.jpg" alt="skull" /></p>

<p>Into dots format:</p>

<p><img src="/images/skull-dots1-5.jpg" alt="skull with dots" /></p>

<p>The software is basic. We navigate into pixels and check if they’re not white.
If they’re not the background, we can plot a circle and keep jumping considering a padding and chopstick diameter configuration.</p>

<p>The project is open source here: https://github.com/jonatas/hashi.</p>

<p>So you can play on your own. So, let’s build the idea step by step.</p>

<h2 id="creating-the-new-project-with-bundler-gem">Creating the new project with bundler gem</h2>

<p>I love to use <code class="language-plaintext highlighter-rouge">bundle gem</code>  on all my ruby projects because it’s easier
to start from scratch and easy to adapt later than play in a single file and add the gems manually.</p>

<p>The first step is <code class="language-plaintext highlighter-rouge">bundle gem hashi</code> that is supposed to be the name of our project.</p>

<h2 id="add-libraries-to-the-project-with-bundler-add">Add libraries to the project with <code class="language-plaintext highlighter-rouge">bundler add</code></h2>

<p>I love <a href="http://pryrepl.org">pry</a>, and I need it since the beginning, so let’s add it.</p>

<p><code class="language-plaintext highlighter-rouge">bundle add pry</code></p>

<p>I also will need RMagick, so let’s add it as well:</p>

<p><code class="language-plaintext highlighter-rouge">bundle add rmagick</code></p>

<h2 id="setup-pry-on-binconsole">Setup pry on <code class="language-plaintext highlighter-rouge">bin/console</code></h2>

<p>When you use the <code class="language-plaintext highlighter-rouge">bundle gem</code> it creates a <code class="language-plaintext highlighter-rouge">bin/console</code> utility that brings your environment into an IRB session. It’s pretty useful for debugging
purposes and understanding the libraries. As the first step, let’s switch to
<code class="language-plaintext highlighter-rouge">pry</code> instead of IRB:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s2">"bundler/setup"</span>
<span class="nb">require</span> <span class="s2">"hashi"</span>
<span class="nb">require</span> <span class="s2">"pry"</span>
<span class="no">Pry</span><span class="p">.</span><span class="nf">start</span>
</code></pre></div></div>

<p>There’s no secret in the code. We just require the bundler requirements
plus the files into our project and start a pry session.</p>

<p>The next step is and picks some image to learn the basics of the image reading.</p>

<h2 id="pick-an-image-from-the-web-with-curl">Pick an image from the web with <code class="language-plaintext highlighter-rouge">curl</code></h2>

<p>Now, let’s pick some random image from the web to follow the process. I’ll use
<a href="http://cliparts.co/cliparts/rcj/KMa/rcjKMaMzi.jpg">this one</a>.</p>

<p>Let’s download the image in the project folder naming it <code class="language-plaintext highlighter-rouge">skull.png</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl http://cliparts.co/cliparts/rcj/KMa/rcjKMaMzi.jpg <span class="o">&gt;</span> skull.png
</code></pre></div></div>

<p>With the <code class="language-plaintext highlighter-rouge">skull.png</code> we can play and learn more about the image with RMagick.</p>

<h2 id="reading-image-with-rmagick">Reading image with RMagick</h2>

<p><a href="http://rmagick.github.io">RMagick</a> is a powerful library, and we’re going to
superficially cover our needs.</p>

<p>The first thing is to learn more about image details:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rmagick'</span>
<span class="no">Magick</span><span class="o">::</span><span class="no">Image</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'skull.jpg'</span><span class="p">)</span>
<span class="c1"># =&gt; [skull.jpg JPEG 441x651 4)l41x651+0+0 DirectClass 8-bit 56kb]</span>
</code></pre></div></div>
<p>Check that it returns an array of images because it probably can process
multiple images. In this case, let’s pick the first.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image</span> <span class="o">=</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Image</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'skull.jpg'</span><span class="p">).</span><span class="nf">first</span>
<span class="c1"># =&gt; skull.jpg JPEG 441x651 441x651+0+0 DirectClass 8-bit 56kb</span>
</code></pre></div></div>

<p>Now let’s check some crucial properties to follow our small image processor.</p>
<pre class="prettyprint">
image.rows # =&gt; 651
image.columns # =&gt; 441
</pre>
<p>With the number of row and columns, we can navigate pixel by pixel and
calculate the position of each pixel discovering the row and column based on
the pixel index.</p>

<p>If the image have 651 rows and 441 columns, we can imagine the image have 287091
pixels from (651 * 441) spots we have.</p>

<h2 id="calculate-row-and-column-from-pixel-index">Calculate row and column from pixel index</h2>

<p>To discover the row, let’s build some example:</p>

<p>Let’s say that we’re analyzing the pixel <code class="language-plaintext highlighter-rouge">1234</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pixel_index</span> <span class="o">=</span> <span class="mi">1234</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">pixel_index</span> <span class="o">/</span> <span class="n">image</span><span class="p">.</span><span class="nf">rows</span> <span class="c1"># =&gt; 1</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">pixel_index</span> <span class="o">%</span> <span class="n">image</span><span class="p">.</span><span class="nf">columns</span> <span class="c1"># =&gt; 352</span>
</code></pre></div></div>

<p>We don’t need the <code class="language-plaintext highlighter-rouge">pixel_index</code>, but the <code class="language-plaintext highlighter-rouge">col</code> and <code class="language-plaintext highlighter-rouge">row</code> values are crucial to plot the dots in the new image.</p>

<p>Now, let’s discover the proper method to get the pixels from image:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image</span><span class="p">.</span><span class="nf">methods</span><span class="p">.</span><span class="nf">grep</span> <span class="sr">/pixel/</span> <span class="c1"># =&gt; [:get_pixels, :store_pixels, ... import_pixels, :each_pixel, :pixel_color]</span>
</code></pre></div></div>
<p>Cool! looks like we can use <code class="language-plaintext highlighter-rouge">get_pixels</code> or iterate directly with
 <code class="language-plaintext highlighter-rouge">each_pixel</code>.</p>

<p>Following my “Binding Pry Driven Development” flow, let’s jump into the first
pixel:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">image</span><span class="p">.</span><span class="nf">each_pixel</span> <span class="k">do</span> <span class="o">|</span><span class="n">px</span><span class="o">|</span>
  <span class="nb">binding</span><span class="p">.</span><span class="nf">pry</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Right after execute this line, it will jump into another pry session:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">px</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Magick::Pixel:0x00007f8c2d58fd98&gt;</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">px</span><span class="p">.</span><span class="nf">methods</span><span class="p">.</span><span class="nf">grep</span> <span class="sr">/color/</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:to_color</span><span class="p">]</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">px</span><span class="p">.</span><span class="nf">to_color</span>
<span class="o">=&gt;</span> <span class="s2">"white"</span>
</code></pre></div></div>

<p>Tada! We have almost all pieces ready to start the real implementation. We know
the color and the pixel position.</p>

<p>Let’s start building a smart iterator that can yield the information we need for
create the rules and drawings that we want:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">navigate_on_pixels_with_index</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">image</span><span class="p">.</span><span class="nf">each_pixel</span> <span class="k">do</span> <span class="o">|</span><span class="n">pixel</span><span class="o">|</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">image</span><span class="p">.</span><span class="nf">rows</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">image</span><span class="p">.</span><span class="nf">columns</span>
    <span class="k">yield</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">i</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Also, the method can yield the information we need to create our drawing.</p>

<p>Going back to command line, let’s see how the <code class="language-plaintext highlighter-rouge">Draw</code> object works:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">draw</span> <span class="o">=</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Draw</span><span class="p">.</span><span class="nf">new</span>
<span class="o">=&gt;</span> <span class="p">(</span><span class="n">no</span> <span class="n">primitives</span> <span class="n">defined</span><span class="p">)</span>
<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">draw</span><span class="p">.</span><span class="nf">methods</span><span class="p">.</span><span class="nf">grep</span> <span class="sr">/circle/</span>
<span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:circle</span><span class="p">]</span>
</code></pre></div></div>

<p>One of my favorite shortcuts is <code class="language-plaintext highlighter-rouge">$</code> on pry. It’s a shortcut for <code class="language-plaintext highlighter-rouge">show-doc</code> of
something. Let’s inspect the <code class="language-plaintext highlighter-rouge">circle</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="err">$</span> <span class="n">draw</span><span class="p">.</span><span class="nf">circle</span>

<span class="no">From</span><span class="p">:</span> <span class="sr">/Users/</span><span class="n">jonatasdp</span><span class="o">/</span><span class="p">.</span><span class="nf">rbenv</span><span class="o">/</span><span class="n">versions</span><span class="o">/</span><span class="mf">2.5</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ruby</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="mf">2.5</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">gems</span><span class="o">/</span><span class="n">rmagick</span><span class="o">-</span><span class="mf">2.16</span><span class="o">.</span><span class="mi">0</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rmagick_internal</span><span class="p">.</span><span class="nf">rb</span> <span class="err">@</span> <span class="n">line</span> <span class="mi">244</span><span class="p">:</span>
<span class="no">Owner</span><span class="p">:</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Draw</span>
<span class="no">Visibility</span><span class="p">:</span> <span class="kp">public</span>
<span class="no">Number</span> <span class="n">of</span> <span class="ss">lines: </span><span class="mi">3</span>

<span class="k">def</span> <span class="nf">circle</span><span class="p">(</span><span class="n">originX</span><span class="p">,</span> <span class="n">originY</span><span class="p">,</span> <span class="n">perimX</span><span class="p">,</span> <span class="n">perimY</span><span class="p">)</span>
  <span class="n">primitive</span> <span class="s1">'circle '</span> <span class="o">+</span> <span class="nb">sprintf</span><span class="p">(</span><span class="s1">'%g,%g %g,%g'</span><span class="p">,</span> <span class="n">originX</span><span class="p">,</span> <span class="n">originY</span><span class="p">,</span> <span class="n">perimX</span><span class="p">,</span> <span class="n">perimY</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can see the method need the <code class="language-plaintext highlighter-rouge">originX</code> and <code class="language-plaintext highlighter-rouge">originY</code> that are <code class="language-plaintext highlighter-rouge">col</code> and
<code class="language-plaintext highlighter-rouge">row</code> position. The <code class="language-plaintext highlighter-rouge">perimX </code>and <code class="language-plaintext highlighter-rouge">perimY</code> will depend on the hashi
diameter + <code class="language-plaintext highlighter-rouge">col</code> and <code class="language-plaintext highlighter-rouge">row</code> position.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">draw_hashi_on</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
  <span class="n">hashi_size</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="n">draw</span><span class="p">.</span><span class="nf">circle</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="n">hashi_size</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="n">hashi_size</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We still need to take care of the padding. Otherwise, we’re going to iterate
under all the pixels and it will become a blurred image of dots.</p>

<p>As we want to have some distance between the circles, we need to define this
distance and ignore the pixels that are not in this position.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">navigate_on_pixels_with_row_and_col</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">padding</span> <span class="o">=</span> <span class="mi">8</span>
  <span class="n">image</span><span class="p">.</span><span class="nf">each_pixel</span> <span class="k">do</span> <span class="o">|</span><span class="n">pixel</span><span class="o">|</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">image</span><span class="p">.</span><span class="nf">rows</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">image</span><span class="p">.</span><span class="nf">columns</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">%</span> <span class="n">padding</span><span class="p">).</span><span class="nf">zero?</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">col</span> <span class="o">%</span> <span class="n">padding</span><span class="p">).</span><span class="nf">zero?</span>
      <span class="k">yield</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span>
    <span class="k">end</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we’re ignoring all pixels that are not divisible by 8, and it means that
we’re jumping every 8 pixels to make the check. Why? Because of if we want only
to plot dots every 8 pixels, I don’t need to navigate and check the pixels
between them.</p>

<p>Improving our iterator will make it easy to concentrate on your very basic rule:</p>

<p>Non-white pixels should have circles. Putting all together in the <code class="language-plaintext highlighter-rouge">process!</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">process!</span>
  <span class="n">navigate_on_pixels_with_row_and_col</span> <span class="k">do</span> <span class="o">|</span><span class="n">pixel</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">pixel</span><span class="p">.</span><span class="nf">to_color</span> <span class="o">!=</span> <span class="s2">"white"</span>
      <span class="n">draw_hashi_on</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">save_new_image</span>
<span class="k">end</span>
</code></pre></div></div>
<p>We still missed a final step that saves the new drawing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save_new_image</span>
  <span class="n">img</span> <span class="o">=</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Hashi</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">rows</span><span class="p">,</span> <span class="no">Hashi</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">columns</span><span class="p">)</span>
  <span class="n">draw</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
  <span class="n">img</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="s1">'skull-dots.jpg'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>
<p>If you save the file probably it will work in some how.</p>

<p>It was the necessary steps I follow to create this small project. Looking the entire
code that accepts the filename, hashi size and padding as a command line input:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"hashi/version"</span>
<span class="nb">require</span> <span class="s1">'rmagick'</span>
<span class="nb">require</span> <span class="s1">'set'</span>

<span class="k">module</span> <span class="nn">Hashi</span>
  <span class="kp">module_function</span>

  <span class="k">def</span> <span class="nf">image_file</span>
    <span class="vi">@file</span> <span class="o">=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="s1">'stencil.png'</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">image</span>
    <span class="vi">@image</span> <span class="o">||=</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Image</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">image_file</span><span class="p">).</span><span class="nf">first</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">dots_image_file</span>
    <span class="nb">name</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">image_file</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">-dots.</span><span class="si">#{</span><span class="n">extension</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">draw</span>
    <span class="vi">@draw</span> <span class="o">||=</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Draw</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hashi_size</span>
    <span class="vi">@hashi_size</span> <span class="o">||=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">||</span> <span class="mi">10</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hashi_padding</span>
    <span class="vi">@hashi_padding</span> <span class="o">||=</span> <span class="no">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">to_i</span> <span class="o">||</span> <span class="n">hashi_size</span> <span class="o">*</span> <span class="mi">3</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">padding</span>
    <span class="vi">@padding</span> <span class="o">||=</span> <span class="n">hashi_size</span> <span class="o">+</span> <span class="n">hashi_padding</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">navigate_on_pixels_with_index</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">image</span><span class="p">.</span><span class="nf">each_pixel</span> <span class="k">do</span> <span class="o">|</span><span class="n">pixel</span><span class="o">|</span>
      <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="n">image</span><span class="p">.</span><span class="nf">rows</span>
      <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">image</span><span class="p">.</span><span class="nf">columns</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">%</span> <span class="n">padding</span><span class="p">).</span><span class="nf">zero?</span> <span class="o">&amp;&amp;</span>
         <span class="p">(</span><span class="n">col</span> <span class="o">%</span> <span class="n">padding</span><span class="p">).</span><span class="nf">zero?</span>
        <span class="k">yield</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">i</span>
      <span class="k">end</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">process!</span>
    <span class="vi">@hashi_map</span> <span class="o">=</span> <span class="no">Set</span><span class="p">.</span><span class="nf">new</span>
    <span class="n">navigate_on_pixels_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">pixel</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">pixel</span><span class="p">.</span><span class="nf">to_color</span> <span class="o">!=</span> <span class="s2">"white"</span>
        <span class="n">hashi_on</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">finish!</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">finish!</span>
    <span class="nb">print</span> <span class="s2">"drawing the new image.."</span>
    <span class="n">img</span> <span class="o">=</span> <span class="no">Magick</span><span class="o">::</span><span class="no">Image</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">Hashi</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">rows</span><span class="p">,</span> <span class="no">Hashi</span><span class="p">.</span><span class="nf">image</span><span class="p">.</span><span class="nf">columns</span><span class="p">)</span>
    <span class="n">draw</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">img</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">dots_image_file</span><span class="p">)</span>
    <span class="sb">`open </span><span class="si">#{</span><span class="n">dots_image_file</span><span class="si">}</span><span class="sb">`</span>
    <span class="nb">print</span> <span class="s2">"... done!"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hashi_on</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span>
    <span class="n">draw</span><span class="p">.</span><span class="nf">circle</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="n">hashi_size</span><span class="p">,</span> <span class="n">row</span> <span class="o">+</span> <span class="n">hashi_size</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<h2 id="conclusion">Conclusion</h2>

<p>If you look at the code, it has a few extra messages, but the basics are what
was explained here.</p>

<p>It walks through each n pixels on an image, check if it’s not a white color and
plot a dot. It creates this beautiful effect, and you can expand the program to
make other details.</p>

<p>I’m not caring about the code organization but my experience automatically
divide the problem into multiple steps, and I organize the methods as I was exploring the library into the console session.</p>

<p>If you know what you want to build, it’s easy to explore focused on the final
result you want to achieve. With this prototype, we can easily envision how the final work looks like, how many chopsticks we need and so on.</p>

<p>My code is not tested, and I just had fun with code. My next step is export this
coordinated dots positions to work directly into 3D files. I’ll convert to <a href="/tutorial-programacao-3d-openscad">stl
file</a> and print it in 3D printing. My idea is
creating cylinders from the chopstick coordinates and then use another cube to subtract it and get the perfect plaque with all the holes to make the final hashi art.</p>


  </div>
  
  
  <div class="article-tags">
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Image+processing+with+Ruby&url=https%3A%2F%2Fideia.me%2Fimage-processing-with-rmagick&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fimage-processing-with-rmagick" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fimage-processing-with-rmagick&title=Image+processing+with+Ruby" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fimage-processing-with-rmagick&title=Image+processing+with+Ruby" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/retrospective-2018" title="Retrospective 2018">
        Retrospective 2018
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/complex-ast-search-with-ruby" title="Complex AST search with Ruby">
        Complex AST search with Ruby
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
        
        
          <div class="col-12">
            <p>No related posts found. Check out <a href="/archive.html">recent posts</a> instead.</p>
          </div>
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread" class="comments-section"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/image-processing-with-rmagick';
    this.page.identifier = '/image-processing-with-rmagick';
    
    // Handle dark mode for Disqus
    const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                        document.body.classList.contains('dark-mode') || 
                        window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (isDarkMode) {
      // Enable dark mode for Disqus
      this.page.functions = [];
      this.callbacks = {
        onReady: [function() {
          // Message the iframe to apply dark theme once loaded
          const message = {
            name: 'theme',
            data: {
              theme: 'dark'
            }
          };
          
          // Try to send the message multiple times as Disqus can load slowly
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 2000);
          
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 4000);
        }]
      };
    }
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    
    // Add dark styling for container
    if (document.documentElement.classList.contains('dark-mode') || 
        document.body.classList.contains('dark-mode') || 
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // Style the container immediately
      const style = document.createElement('style');
      style.textContent = `
        #disqus_thread {
          background-color: #1e1e1e !important;
          color: #f0f2f5 !important;
          padding: 20px;
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          margin-top: 30px;
          margin-bottom: 30px;
        }
        
        iframe {
          background-color: #1e1e1e !important;
          color-scheme: dark !important;
        }
        
        /* Force the iframe document to use dark mode */
        iframe[src*="disqus.com"] {
          color-scheme: dark !important;
          filter: invert(90%) hue-rotate(180deg) !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.documentElement.classList.add('dark-mode');
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
              console.log('Dark mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            } else {
              document.documentElement.classList.remove('dark-mode');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
              console.log('Light mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            }
            
            // Force reload the page to ensure all styles are applied correctly
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
        }
        
        // Apply highlighting to code blocks after content loads
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Configure Disqus for dark mode if needed
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        if (isDarkMode) {
          // Insert dark mode CSS for Disqus
          const style = document.createElement('style');
          style.innerHTML = `
            #disqus_thread {
              background-color: #1e1e1e !important;
              color: #f0f2f5 !important;
              padding: 20px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            }
          `;
          document.head.appendChild(style);
          
          // Set Disqus config variable for dark mode
          window.disqus_config = function() {
            this.page.identifier = window.location.pathname;
            this.page.url = window.location.href;
            this.language = 'en';
            this.sso = {
              name: 'SiteName',
            };
            this.callbacks.onReady = [function() {
              const interval = setInterval(function() {
                if (document.getElementById('dsq-app2')) {
                  clearInterval(interval);
                  const disqusIframe = document.getElementById('dsq-app2');
                  disqusIframe.contentWindow.postMessage({
                    name: 'setTheme',
                    data: 'dark',
                  }, '*');
                }
              }, 100);
            }];
          };
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
    
    <!-- Disqus Dark Mode Handler -->
    <script>
      // Function to handle Disqus dark mode
      function setupDisqusDarkMode() {
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        // Add a style element to target the Disqus iframe
        const disqusStyle = document.createElement('style');
        disqusStyle.innerHTML = `
          html.dark-mode iframe, body.dark-mode iframe {
            color-scheme: dark !important;
          }
          
          html.dark-mode #disqus_thread, body.dark-mode #disqus_thread {
            background-color: #1e1e1e !important;
            color: #f0f2f5 !important;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        `;
        document.head.appendChild(disqusStyle);
        
        // Check for Disqus iframe and inject dark styles if needed
        const checkForDisqus = setInterval(() => {
          const disqusThread = document.getElementById('disqus_thread');
          const disqusIframes = document.querySelectorAll('iframe[src*="disqus.com"]');
          
          if (disqusThread || disqusIframes.length > 0) {
            clearInterval(checkForDisqus);
            
            if (isDarkMode) {
              // Try to signal Disqus to use dark theme
              if (window.DISQUS) {
                try {
                  window.DISQUS.host._loadEmbed({
                    color: 'dark',
                  });
                } catch (e) {
                  console.log('Could not set Disqus theme via API');
                }
              }
              
              // Direct CSS approach to all iframes
              disqusIframes.forEach(iframe => {
                try {
                  // Try to access the iframe document
                  const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                  
                  // Add dark mode classes and styles
                  if (iframeDocument.body) {
                    iframeDocument.body.classList.add('dark-mode');
                    
                    const darkStyle = iframeDocument.createElement('style');
                    darkStyle.textContent = `
                      body { background-color: #1e1e1e !important; color: #f0f2f5 !important; }
                      .textarea-wrapper, .post-actions, .alert { background-color: #2a2d31 !important; }
                      .wysiwyg__placeholder, input, textarea { color: #f0f2f5 !important; }
                      .publisher-background-color { background-color: #1e1e1e !important; }
                      .publisher-border-color { border-color: rgba(255, 255, 255, 0.1) !important; }
                      .publisher-anchor-color, a { color: #5c9eff !important; }
                    `;
                    iframeDocument.head.appendChild(darkStyle);
                  }
                } catch (e) {
                  console.log('Could not modify Disqus iframe due to CORS policy');
                  
                  // Add a fallback with filter approach
                  if (isDarkMode) {
                    // Apply a CSS filter to invert the colors
                    iframe.style.filter = 'invert(92%) hue-rotate(180deg)';
                  }
                }
              });
            }
          }
        }, 500);
      }
      
      // Run setup when DOM is loaded and after any content changes
      document.addEventListener('DOMContentLoaded', setupDisqusDarkMode);
      document.addEventListener('ajaxComplete', setupDisqusDarkMode);
      
      // Also run after a delay in case Disqus loads later
      setTimeout(setupDisqusDarkMode, 2000);
      setTimeout(setupDisqusDarkMode, 5000);
    </script>
    
    <!-- Dedicated Disqus dark mode handler -->
    <script src="/js/disqus-dark.js"></script>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        // Check saved preference first
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Apply theme based on saved preference or system preference
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
          console.log('Dark mode applied on initial load');
        } else {
          document.body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
          console.log('Light mode applied on initial load');
        }
        
        // Listen for changes in the OS color scheme only if no saved preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          // Only apply system preference if user hasn't manually chosen a theme
          if (localStorage.getItem('theme') === null) {
            const newColorScheme = e.matches ? 'dark' : 'light';
            if (newColorScheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.documentElement.classList.add('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = true;
              console.log('Dark mode applied from system preference change');
            } else {
              document.body.classList.remove('dark-mode');
              document.documentElement.classList.remove('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = false;
              console.log('Light mode applied from system preference change');
            }
          }
        });
      }

      // Initialize dark mode immediately before DOM content is fully loaded
      detectColorScheme();
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
      });
    </script>
  </body>
</html>

