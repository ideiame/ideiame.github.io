
<!DOCTYPE html>
<html lang="en" class="dark-mode">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Customize multiple refreshes for continuous aggregates</title>
    <meta name="description" content="TimescaleDB, an open-source time-series database optimized for fast ingest and complex queries, offers a unique feature called Continuous Aggregates (CAGGs)....">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Always use dark mode -->
    <script>
      (function() {
        document.documentElement.classList.add('dark-mode');
        document.write('<style>body,html{background-color:#0c0c0c!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JetBrains Mono and other developer fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    
    <!-- Site styles -->
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/modern-theme.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/modern-effects.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body class="dark-mode">
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Geometric background pattern -->
    <div class="geometric-bg"></div>

    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <span class="logo">
            <span class="i">i</span>
            <span class="d">d</span>
            <span class="e">e</span>
            <span class="i2">i</span>
            <span class="a">a</span>
            <span class="dot">.</span>
            <span class="m">m</span>
            <span class="e2">e</span>
          </span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              </a>
              <ul class="dropdown-menu shadow-sm glass-card" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Customize multiple refreshes for continuous aggregates
          </div>
          
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> November 30, 2023</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 8 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#databases-ref" class="text-muted">databases</a>, 
        
          <a href="#programming-ref" class="text-muted">programming</a>, 
        
          <a href="#technology-ref" class="text-muted">technology</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>TimescaleDB, an open-source time-series database optimized for fast ingest and complex queries, offers a unique feature called Continuous Aggregates (CAGGs). These CAGGs are game-changers in how we handle time-series data, allowing for real-time aggregate views that are automatically refreshed. In this post, we’ll explore how to create a custom refresh policy for hierarchical continuous aggregates and delve into the flexibility and simplicity TimescaleDB offers.</p>

<h2 id="the-scenario">The scenario</h2>

<p>Imagine you have a <code class="language-plaintext highlighter-rouge">metrics</code> hypertable in TimescaleDB and you’re aggregating this data over different time intervals: hourly, daily, and weekly. Managing these aggregations can get complex, especially when you want to refresh them in a specific sequence.</p>

<h3 id="setting-up-the-hypertable">Setting up the hypertable</h3>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">metrics</span> <span class="p">(</span>
  <span class="nb">time</span> <span class="n">timestamptz</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">device_id</span> <span class="nb">int</span><span class="p">,</span>
  <span class="n">value</span> <span class="nb">float</span>
<span class="p">);</span>
<span class="k">SELECT</span> <span class="n">create_hypertable</span><span class="p">(</span><span class="s1">'metrics'</span><span class="p">,</span> <span class="s1">'time'</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="setting-up-caggs">Setting up CAGGS</h3>

<p>Now, it’s time to set up our continuous aggregates. We create three materialized views for our <code class="language-plaintext highlighter-rouge">metrics</code> table: <code class="language-plaintext highlighter-rouge">metrics_by_hour</code>, <code class="language-plaintext highlighter-rouge">metrics_by_day</code>, and <code class="language-plaintext highlighter-rouge">metrics_by_week</code>. These views will aggregate data over their respective time intervals.</p>

<p>The hourly view goes to raw data:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">metrics_by_hour</span>
<span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 hour'</span><span class="p">,</span> <span class="nb">time</span><span class="p">)</span> <span class="k">AS</span> <span class="n">bucket</span><span class="p">,</span>
<span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">metrics</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>The daily view reuses hourly data:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">metrics_by_day</span> <span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 day'</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span> <span class="k">AS</span> <span class="n">bucket</span><span class="p">,</span>
  <span class="k">sum</span><span class="p">(</span><span class="k">count</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span>
<span class="k">FROM</span> <span class="n">metrics_by_hour</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<p>The week view reuses daily data:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="n">MATERIALIZED</span> <span class="k">VIEW</span> <span class="n">metrics_by_week</span> <span class="k">WITH</span> <span class="p">(</span><span class="n">timescaledb</span><span class="p">.</span><span class="n">continuous</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">time_bucket</span><span class="p">(</span><span class="s1">'1 week'</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span> <span class="k">AS</span> <span class="n">bucket</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="k">count</span><span class="p">)</span> <span class="k">AS</span> <span class="k">count</span> <span class="k">FROM</span> <span class="n">metrics_by_day</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="the-power-of-recursive-in-sql">The power of RECURSIVE in SQL</h2>

<p>Before we dive into the practical application, let’s understand a critical piece of the puzzle: the use of <code class="language-plaintext highlighter-rouge">RECURSIVE</code> in SQL. This concept might be new to some, so I’ll walk through an example to shed light on its functionality.</p>

<p>Kudos to <a href="https://twitter.com/fabriziomello">@fabriziomello</a> that shared the recursive SQL code which was used as a guide to find the right continuous aggregates order.</p>

<p>Consider the following SQL snippet:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">caggs</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">mat_hypertable_id</span><span class="p">,</span> <span class="n">parent_mat_hypertable_id</span><span class="p">,</span> <span class="n">user_view_name</span>
    <span class="k">FROM</span> <span class="n">_timescaledb_catalog</span><span class="p">.</span><span class="n">continuous_agg</span>
    <span class="k">WHERE</span> <span class="n">user_view_name</span> <span class="o">=</span> <span class="s1">'metrics_by_week'</span>
    <span class="k">UNION</span> <span class="k">ALL</span>
    <span class="k">SELECT</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">mat_hypertable_id</span><span class="p">,</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">parent_mat_hypertable_id</span><span class="p">,</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">user_view_name</span>
    <span class="k">FROM</span> <span class="n">_timescaledb_catalog</span><span class="p">.</span><span class="n">continuous_agg</span>
    <span class="k">JOIN</span> <span class="n">caggs</span> <span class="k">ON</span> <span class="n">caggs</span><span class="p">.</span><span class="n">parent_mat_hypertable_id</span> <span class="o">=</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">mat_hypertable_id</span>
<span class="p">)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">caggs</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">mat_hypertable_id</span><span class="p">;</span>
</code></pre></div></div>

<p>In this snippet, we are using a <code class="language-plaintext highlighter-rouge">WITH RECURSIVE</code> query to create a Common Table Expression (CTE) named <code class="language-plaintext highlighter-rouge">caggs</code>. The recursive part of this CTE does two things:</p>
<ol>
  <li>Initially, it selects data from the <code class="language-plaintext highlighter-rouge">_timescaledb_catalog.continuous_agg</code> table where our continuous aggregate view is <code class="language-plaintext highlighter-rouge">metrics_by_week</code>.</li>
  <li>Then, it recursively joins this data with the same catalog table to find all related continuous aggregates. This is crucial for understanding the hierarchy of our aggregates.</li>
</ol>

<p>The result is a neatly organized list of continuous aggregates along with their parent-child relationships. Understanding this relationship is key to setting up a custom refresh policy that respects the dependency chain.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">┌───────────────────┬──────────────────────────┬─────────────────┐</span>
<span class="err">│</span> <span class="n">mat_hypertable_id</span> <span class="err">│</span> <span class="n">parent_mat_hypertable_id</span> <span class="err">│</span> <span class="n">user_view_name</span>  <span class="err">│</span>
<span class="err">├───────────────────┼──────────────────────────┼─────────────────┤</span>
<span class="err">│</span>               <span class="mi">148</span> <span class="err">│</span>                          <span class="err">│</span> <span class="n">metrics_by_hour</span> <span class="err">│</span>
<span class="err">│</span>               <span class="mi">149</span> <span class="err">│</span>                      <span class="mi">148</span> <span class="err">│</span> <span class="n">metrics_by_day</span>  <span class="err">│</span>
<span class="err">│</span>               <span class="mi">150</span> <span class="err">│</span>                      <span class="mi">149</span> <span class="err">│</span> <span class="n">metrics_by_week</span> <span class="err">│</span>
<span class="err">└───────────────────┴──────────────────────────┴─────────────────┘</span>
</code></pre></div></div>

<h2 id="implementing-the-custom-refresh-policy">Implementing the custom refresh policy</h2>

<p>With the recursive CTE in place, we can now proceed to the next step: implementing a custom refresh policy for our continuous aggregates. This policy ensures that each aggregate is refreshed in the correct sequence, respecting their hierarchical dependencies.</p>

<h3 id="building-a-cascading-refresh-policy">Building a cascading refresh policy</h3>

<p>To ensure our aggregates are refreshed in the right order, we’ll write a procedure that refreshes each aggregate in sequence. This is crucial because our daily aggregate depends on the hourly one, and the weekly aggregate depends on the daily one.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">PROCEDURE</span> <span class="n">refresh_all_caggs</span><span class="p">(</span><span class="n">job_id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">config</span> <span class="n">jsonb</span><span class="p">)</span>
<span class="k">LANGUAGE</span> <span class="n">PLPGSQL</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="k">DECLARE</span>
    <span class="n">_cagg</span> <span class="n">RECORD</span><span class="p">;</span>
<span class="k">BEGIN</span>
    <span class="k">FOR</span> <span class="n">_cagg</span> <span class="k">IN</span>
        <span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">caggs</span> <span class="k">AS</span> <span class="p">(</span>
            <span class="k">SELECT</span> <span class="n">mat_hypertable_id</span><span class="p">,</span> <span class="n">parent_mat_hypertable_id</span><span class="p">,</span> <span class="n">user_view_name</span>
            <span class="k">FROM</span> <span class="n">_timescaledb_catalog</span><span class="p">.</span><span class="n">continuous_agg</span>
            <span class="k">WHERE</span> <span class="n">user_view_name</span> <span class="o">=</span> <span class="s1">'metrics_by_week'</span>
            <span class="k">UNION</span> <span class="k">ALL</span>
            <span class="k">SELECT</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">mat_hypertable_id</span><span class="p">,</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">parent_mat_hypertable_id</span><span class="p">,</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">user_view_name</span>
            <span class="k">FROM</span> <span class="n">_timescaledb_catalog</span><span class="p">.</span><span class="n">continuous_agg</span>
            <span class="k">JOIN</span> <span class="n">caggs</span> <span class="k">ON</span> <span class="n">caggs</span><span class="p">.</span><span class="n">parent_mat_hypertable_id</span> <span class="o">=</span> <span class="n">continuous_agg</span><span class="p">.</span><span class="n">mat_hypertable_id</span>
        <span class="p">)</span>
        <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">caggs</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">mat_hypertable_id</span>
    <span class="n">LOOP</span>
        <span class="k">EXECUTE</span> <span class="n">format</span><span class="p">(</span><span class="s1">'CALL refresh_continuous_aggregate(%L, NULL, NULL)'</span><span class="p">,</span> <span class="n">_cagg</span><span class="p">.</span><span class="n">user_view_name</span><span class="p">);</span>
        <span class="k">COMMIT</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="scheduling-the-jobs">Scheduling the jobs</h3>

<p>Now, just schedule the function to run every 5 seconds:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">add_job</span><span class="p">(</span><span class="s1">'refresh_all_caggs'</span><span class="p">,</span> <span class="s1">'5 seconds'</span><span class="p">);</span>
</code></pre></div></div>

<p>With our functions ready, we use TimescaleDB’s job scheduling feature to run these functions at regular intervals. This step is where the “magic happens” - our database is now self-managing, continuously updating our aggregate views and inserting new data.</p>

<h3 id="automated-data-insertion-for-testing">Automated data insertion for testing</h3>

<p><a href="https://docs.timescale.com/api/latest/actions/">Actions</a> are amazing to develop small POCs and can be handy to detach long processing to a background worker.</p>

<p>To test our setup, we’ll create another custom action that inserts random metrics into our <code class="language-plaintext highlighter-rouge">metrics</code> table. This action simulates real-time data insertion, helping us see our continuous aggregates in action.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">insert_random_metrics</span><span class="p">(</span><span class="n">job_id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">config</span> <span class="n">jsonb</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">VOID</span> <span class="k">LANGUAGE</span> <span class="n">PLPGSQL</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="k">DECLARE</span>
    <span class="n">last_time</span> <span class="n">timestamptz</span><span class="p">;</span>
    <span class="n">interval_value</span> <span class="n">interval</span> <span class="k">DEFAULT</span> <span class="s1">'1 minute'</span><span class="p">;</span> <span class="c1">-- default interval</span>
<span class="k">BEGIN</span>
    <span class="c1">-- Attempt to fetch the most recent timestamp from the metrics table</span>
    <span class="k">SELECT</span> <span class="k">INTO</span> <span class="n">last_time</span> <span class="k">MAX</span><span class="p">(</span><span class="nb">time</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">metrics</span><span class="p">;</span>

    <span class="c1">-- If no data is found, default to one week ago</span>
    <span class="n">IF</span> <span class="n">last_time</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span>
        <span class="n">last_time</span> <span class="p">:</span><span class="o">=</span> <span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">interval</span> <span class="s1">'1 week'</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>

    <span class="c1">-- Check if an interval is provided in the config and use it if available</span>
    <span class="n">IF</span> <span class="n">config</span> <span class="o">?</span> <span class="s1">'interval'</span> <span class="k">THEN</span>
        <span class="n">interval_value</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">config</span> <span class="o">-&gt;&gt;</span> <span class="s1">'interval'</span><span class="p">)::</span><span class="n">interval</span><span class="p">;</span>
    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>

    <span class="c1">-- Insert new data starting from the determined timestamp</span>
    <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">metrics</span> <span class="p">(</span><span class="nb">time</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="n">last_time</span> <span class="o">+</span> <span class="n">interval_value</span><span class="p">,</span> <span class="n">trunc</span><span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)::</span><span class="nb">int</span><span class="p">,</span> <span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span><span class="p">;</span>
</code></pre></div></div>

<p>After creating the function, you can schedule it to run at regular intervals using TimescaleDB’s job scheduling system. In this case, as we’re just wanting results fast as possible, we’ll insert a new row every second with data starting from a week ago and appending 35 min from the previous time.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">add_job</span><span class="p">(</span><span class="s1">'insert_random_metrics'</span><span class="p">,</span> <span class="s1">'1 second'</span><span class="p">,</span> <span class="s1">'{"interval": "35 minutes"}'</span><span class="p">);</span>
</code></pre></div></div>

<p>We’ve also made this function flexible, allowing us to specify the interval between data points using a JSONB payload.</p>

<h3 id="exploring-with-psql">Exploring with psql</h3>

<p>All of this can be explored using <code class="language-plaintext highlighter-rouge">psql</code>, PostgreSQL’s interactive terminal. I’m a big fan of the simplicity and power of single-file SQL scripts for learning and experimentation. You can easily run these scripts in <code class="language-plaintext highlighter-rouge">psql</code> to see how TimescaleDB handles continuous aggregates and background jobs.</p>

<h3 id="the-power-of-continuous-aggregates-caggs">The power of Continuous Aggregates (CAGGs)</h3>

<p>Continuous aggregates in TimescaleDB offer incredible flexibility. You can rewrite the rules for how and when your data is aggregated, making it fit your specific use case. They’re a testament to the power of open-source databases in handling time-series data effectively.</p>

<h3 id="see-it-in-action">See it in action</h3>

<p>You can find the complete SQL script for this procedure <a href="https://github.com/jonatas/sql-snippets/blob/master/cagg-refresh-cascade.sql">here</a>. Note, the last line has a <code class="language-plaintext highlighter-rouge">\watch</code> which assumes you’ll run it using <code class="language-plaintext highlighter-rouge">psql</code>.</p>

<p>To truly appreciate the beauty of this setup, check out this <a href="https://asciinema.org/a/624234">asciinema recording</a> where I walk through the entire process. It’s a great way to see these concepts in action.</p>

<p><a href="https://asciinema.org/a/624234" target="_blank"><img src="https://asciinema.org/a/624234.svg" /></a></p>

<p>TimescaleDB’s continuous aggregates and background actions offer a level of flexibility and ease of use that’s hard to match. I love it and it reminds me how good is the life working with Postgresql. Simple, easy. No secrets behind the scenes.</p>

<p>I love how I can simply have everything in a sql which I can simply type <code class="language-plaintext highlighter-rouge">psql playground -f my-poc.sql</code> and see things in action.</p>

<p>Whether you’re aggregating data over various time intervals or building custom refresh policies, TimescaleDB simplifies the process, allowing you to focus on what’s important - your data.</p>

<p>Happy coding!</p>


  </div>
  
  
  <div class="article-tags">
    
      <a href="#databases-ref" class="article-tag">databases</a>
    
      <a href="#programming-ref" class="article-tag">programming</a>
    
      <a href="#technology-ref" class="article-tag">technology</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Customize+multiple+refreshes+for+continuous+aggregates&url=https%3A%2F%2Fideia.me%2Fcustomize-multiple-refreshes-continuous-aggregates&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fcustomize-multiple-refreshes-continuous-aggregates" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fcustomize-multiple-refreshes-continuous-aggregates&title=Customize+multiple+refreshes+for+continuous+aggregates" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fcustomize-multiple-refreshes-continuous-aggregates&title=Customize+multiple+refreshes+for+continuous+aggregates" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/anonymizing-your-sql" title="Anonymize your SQL statements">
        Anonymize your SQL statements
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/retrospective-2023" title="Retrospective 2023">
        Retrospective 2023
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
          
          
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
            
        
        
        
        
        
          
            
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/benchmarking-ruby-orms">Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> March 19, 2025
                        </small>
                      </p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/soulless-economy">The Soulless Economy</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> November 22, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Reflections on the impact of AI and automation on human connections and community building.</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/timescaledb-gem-continuous-aggregates-updates">TimescaleDB Gem Continuous Aggregates Updates</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> October 07, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Exploring the latest updates to the TimescaleDB gem's continuous aggregates functionality.</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/my-first-contribution-to-rubygems">My First Contribution to RubyGems</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> July 04, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">A journey through my first contribution to the RubyGems ecosystem.</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/grepping-sql-code-like-a-boss">Grepping SQL Code like a boss</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> May 27, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Here's the outline of the content of my talk in Poland I presented at the Lambda Days 2024.</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
            
        
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/customize-multiple-refreshes-continuous-aggregates';
    this.page.identifier = '/customize-multiple-refreshes-continuous-aggregates';
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Consolidated JS -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Apply highlighting to code blocks after content loads
        if (typeof enhanceCodeBlocks === 'function') {
          enhanceCodeBlocks();
        }
        
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Add fade-in animations
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Apply fade-in to cards and other elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .glass-card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Minimal delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
        
        // Smooth page transitions
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    
    <!-- Dedicated scripts -->
  </body>
</html>

