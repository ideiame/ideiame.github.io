
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Chave Dicotômica</title>
    <meta name="description" content="Hoje, inspirado pelo [post de ontem][post] decidi começar a [abrir alguns exemplos][github] que venho produzindo. Este primeiro trata-se de um aplicativo que...">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Immediate dark mode application to prevent flash -->
    <script>
      (function() {
        // Force dark mode for testing purposes
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.documentElement.classList.add('dark-mode');
          document.write('<style>body,html{background-color:#121212!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
        }
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/code-highlighting.css" rel="stylesheet">
    <link href="/css/disqus-dark.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Style overrides for Prism -->
    <style>
      /* Override Prism default styles to fix text shadow issues */
      code[class*="language-"],
      pre[class*="language-"],
      pre code,
      .token {
        text-shadow: none !important;
        -webkit-text-shadow: none !important;
        border: none !important;
        background: none;
      }
      
      /* Ensure proper background only on container elements */
      pre[class*="language-"] {
        background: var(--prism-background);
      }
      
      .dark-mode pre[class*="language-"] {
        background: var(--prism-background);
      }
    </style>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-ruby.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <div id="fb-root"></div>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        // Check saved preference first
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Apply theme based on saved preference or system preference
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
          console.log('Dark mode applied on initial load');
        } else {
          document.body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
          console.log('Light mode applied on initial load');
        }
        
        // Listen for changes in the OS color scheme only if no saved preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          // Only apply system preference if user hasn't manually chosen a theme
          if (localStorage.getItem('theme') === null) {
            const newColorScheme = e.matches ? 'dark' : 'light';
            if (newColorScheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.documentElement.classList.add('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = true;
              console.log('Dark mode applied from system preference change');
            } else {
              document.body.classList.remove('dark-mode');
              document.documentElement.classList.remove('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = false;
              console.log('Light mode applied from system preference change');
            }
          }
        });
      }

      // Initialize dark mode immediately before DOM content is fully loaded
      detectColorScheme();

      // Add code block enhancements
      function enhanceCodeBlocks() {
        document.querySelectorAll('pre code').forEach((codeBlock, index) => {
          // Get the parent pre element
          const preElement = codeBlock.parentElement;
          if (!preElement.classList.contains('enhanced')) {
            preElement.classList.add('enhanced');
            
            // Create a wrapper div with the highlight class
            const highlightDiv = document.createElement('div');
            highlightDiv.className = 'highlight';
            
            // Insert the wrapper before the pre element
            preElement.parentNode.insertBefore(highlightDiv, preElement);
            
            // Move the pre element inside the wrapper
            highlightDiv.appendChild(preElement);
            
            // Get language class from code element
            let language = '';
            codeBlock.classList.forEach(className => {
              if (className.startsWith('language-')) {
                language = className.substring(9);
              }
            });
            
            // Auto-detect language if none is specified
            if (!language) {
              // Check for Ruby
              if (codeBlock.textContent.includes('require') || 
                  codeBlock.textContent.includes('def ') ||
                  codeBlock.textContent.includes('class ') ||
                  codeBlock.textContent.includes('module ') ||
                  codeBlock.textContent.match(/\w+\s*=\s*\w+/g)) {
                language = 'ruby';
                codeBlock.classList.add('language-ruby');
              }
              // Check for SQL
              else if (codeBlock.textContent.includes('SELECT') || 
                       codeBlock.textContent.includes('FROM') ||
                       codeBlock.textContent.includes('WHERE') ||
                       codeBlock.textContent.includes('CREATE TABLE')) {
                language = 'sql';
                codeBlock.classList.add('language-sql');
              }
            }
            
            // If language is found, add it as a data attribute
            if (language) {
              highlightDiv.setAttribute('data-language', language);
            }
            
            // Create copy button
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = 'Copy';
            copyButton.setAttribute('aria-label', 'Copy code to clipboard');
            copyButton.onclick = function() {
              navigator.clipboard.writeText(codeBlock.textContent)
                .then(() => {
                  copyButton.textContent = 'Copied!';
                  copyButton.classList.add('copied');
                  setTimeout(() => {
                    copyButton.textContent = 'Copy';
                    copyButton.classList.remove('copied');
                  }, 2000);
                })
                .catch(err => {
                  console.error('Could not copy text: ', err);
                });
            };
            
            // Add copy button to the highlight div
            highlightDiv.appendChild(copyButton);
          }
        });
      }
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
        enhanceCodeBlocks();
      });
    </script>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Chave Dicotômica
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>Chave Dicotômica</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> March 08, 2012</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 8 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
          <a href="#ruby-ref" class="text-muted">ruby</a>, 
        
          <a href="#android-ref" class="text-muted">android</a>, 
        
          <a href="#dsl-ref" class="text-muted">dsl</a>
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>Hoje, inspirado pelo <a href="/2012/03/07/pequenas-decisoes-grandes-mudancas.html">post de ontem</a> decidi começar a <a href="https://github.com/jonatas/chave-dicotomica-android">abrir alguns exemplos</a> que venho produzindo. Este primeiro trata-se de um aplicativo que estou criando com minha namorada Tânia que é bióloga para identificação de espécies de árvores. Estamos criando uma árvore de navegação apartir de um mecanismo árduo de leitura traduzido no livro que ela usava como base. O nome do mecanismo é <a href="http://pt.wikipedia.org/wiki/Chave_(biologia)">Chave Dicotômica</a>. A necessidade surgiu que o trabalho de procurar e navegar no livro é chato e lento, pois é necessário entender as especificações técnicas de cada parte da árvore e saber o que é cada particularidade de cada parte do contexto. Além de folhar várias vezes pra frente e pra trás. Veja meia página das menores chaves do livro.</p>

<p><img src="../../../images/foto-livro-chave-dicotomica.jpg" alt="fotolivro" /></p>

<p>Estive alguns dias na floresta com ela e foi muito divertido aprender um pouco de cada detalhe para identificação de uma espécie. Tivemos poucas evoluções no código, mas já criei a parte da navegação que é o pior trabalho com o livro.</p>

<p>O livro que ela usa tem 156 páginas de espécies divididas em 7 chaves principais. Já estamos na chave 4. Neste exemplo irei apenas utilizar a Chave 1 e 2 que são as mesmas da foto anterior.</p>

<h2 id="o-desafio-da-linguagem-natural">O desafio da linguagem natural</h2>

<p>Para chegar ao texto acima foi um caso muito pensado. Após a Tânia me explicar a ideia de como funcionava a chave, fiquei em dúvida sobre como ela iria alimentar o sistema com estas informações. Criar um cadastro de chaves? De espécies? Ou de termos? Tudo passava pela cabeça pois os conteúdos estavam a disposição e quem iria inserir os conteúdos não era eu.</p>

<p>Decidi então por copiar o texto na integra e iria criar um parser com expressões regulares para criar a chave dicotômica em formato de árvore mesmo. Analisei a chave e consegui absorver todo o conteúdo nas seguintes regras:</p>

<ol>
  <li>Definições de novas chaves, estão em letra maiúscula</li>
  <li>Definições de items iniciam com números que serão seus id’s</li>
  <li>Items terminados com …. mais um número conectam a outro item com o mesmo id</li>
  <li>Espécies iniciam com 4 espaços</li>
</ol>

<h2 id="exemplo-do-livro">Exemplo do livro</h2>

<p>Esta foi a linguagem natural mais próxima ao exemplo da foto anterior.</p>

<div><pre>
CHAVE 1 - PLANTAS DESPROVIDAS DE FOLHAS
1. Ramos suculentos, colunares, sucados longitudinalmente, com tufos de acúleos, sem espinhos terminais
    14.1 Cereus hildmannianus
1. Ramos não suculentos, comprimidos lateralmente, com espinho terminal, decussados, ocasionalmente de formato triangular
    61.1 Colletia paradoxa
CHAVE 2 - PALMEIRAS
1. Plantas com acúleos
    9.1 Acrocomia aculeata
1. Plantas sem acúleos .... 2
2. Lâminas em forma de leque, tão largas quanto compridas
    9.9 Trithrinax brasiliensis
2. Lâminas não em forma de leque, mais compridas que largas .... 3
3. Base dos pecíolos permanecendo ao longo do caule
    9.2 Butiaca pitata
    9.3 Butia eriospatha
    9.4 Butia yatay
3. Base dos pecíolos não permanecendo nos caules .... 4
4. Segmentos da folha dispostos em mais dois planos
    9.8 Syagros romanzoffiana
4. Segmentos da folha dispostos em dois planos .... 5
5. Base dos pecíolos de cor acinzentada
    9.5 Butyagros x nabuannandii
5. Base dos pecíolos de cor verde .... 6
6. Bainhas foliares envolvendo completamente a porção apical do caule
    9.6 Euterpe edulis
6. Bainhas foliares não envolvendo completamente a porção apical do caule
    9.7 Geonoma schottiana
</pre></div>

<h2 id="expressões-regulares---diversão-pra-noite-toda">Expressões regulares - diversão pra noite toda</h2>

<p>Agora chegamos as expressões. Absorvendo caso a caso vamos criar as expressões regulares separadas.</p>

<h3 id="1-definições-de-novas-chaves-estão-em-letra-maiúscula">1. Definições de novas chaves, estão em letra maiúscula</h3>

<p>Essa foi fácil, sempre <em>inicia</em> com a palavra CHAVE, tém um número sequencial e um traço que divide da descrição.</p>
<div><pre class="prettyprint">
CHAVE = /^CHAVE (.*) - (.*)/
</pre></div>

<h3 id="2-definições-de-items-iniciam-com-números-que-serão-seus-ids">2. Definições de items iniciam com números que serão seus id’s</h3>

<p>Os items como “1. Plantas com acúleos” ou que apontam para outros como  “5. Base dos pecíolos de cor verde …. 6” casam nesta expressão regular. Inicia(^) com número(\d+) seguido de ponto (\.) com barra invertida pois “.” é um caractér especial nas expressões regulares. 
Neste caso a expressão está apenas buscando genéricamente por qualquer final, sem distinção de ter ou não o link.</p>

<div><pre class="prettyprint">
ITEM = /^(\d+)\.\s(.*)$/
</pre></div>

<h3 id="3-items-terminados-com--mais-um-número-conectam-a-outro-item-com-o-mesmo-id">3. Items terminados com …. mais um número conectam a outro item com o mesmo id</h3>

<p>Os items terminados com link para outros items são o segredo que mata o trabalho árduo de pesquisar no livro. A conecção está ligada com logo em seguida. Estes itens serão conectados a outros itens em um futuro próximo.</p>

<div><pre class="prettyprint">
LINK = /\s\.{4}\s(\d+)$/
</pre></div>

<h3 id="4-espécies-iniciam-com-4-espaços">4. Espécies iniciam com 4 espaços</h3>

<p>\s identifica um espaço e isso torna mais claro do que construir uma expressão como <code class="language-plaintext highlighter-rouge">/ {4}/</code>, e as chaves permitem adicionar o número de ocorrências.</p>

<div><pre class="prettyprint">
SPECIE = /^\s{4}(.*)/
</pre></div>

<h2 id="chave-completa">Chave completa</h2>

<p>Então unindo todas estas expressões sobre o arquivo anterior, devemos criar uma árvore com nodos. Reusufruindo do mundo opensource, vamos extender a classe Tree::TreeNode da biblioteca ruby-tree.</p>

<p>Para instalar a biblioteca digite:</p>

<div><pre>gem install ruby-tree</pre></div>

<p>A biblioteca tem uma classe principal chamada TreeNode, ela tem os attributos nome e conteúdo, sendo o nome de cada nodo único. A classe Dicotomica representa a raiz de todas as chaves dicotômicas, logo irá adicionar todas as chaves a raiz e cada item dentro de cada chave conforme as regras comentadas anteriormente.</p>

<div><pre class="prettyprint">
require "rubygems"
require "tree"
class Dicotomica &lt; Tree::TreeNode
  attr_reader :last_node, :last_root
  def initialize name = "Chave Dicotômica", content = nil, load_from = "dicotomica.txt"
    @pending_replace = {}
    super name,content

     if load_from
       File.readlines(load_from).each do |instruction|
         know(instruction.chomp)
       end
     end
  end

  CHAVE = /^CHAVE (.*) - (.*)/
  ITEM = /^(\d+)\.\s(.*)$/
  LINK = /\s\.{4}\s(\d+)$/
  SPECIE = /^\s{4}(.*)/
  
  def know(string)
    if string
      case string
      when CHAVE 
        add_root  [$1,$2].join(" - ")
      when ITEM
        if replace_node = @pending_replace[$1]
           @last_node = replace_node &lt;&lt; Tree::TreeNode.new(string)
        else
           add_node string
        end
        if string =~ LINK
           @pending_replace[$1] = @last_node
        end
      when SPECIE
         add_specie $1
      end
    end
   end
   def add_root name
      @last_root = self &lt;&lt; Tree::TreeNode.new(name, 'root')
   end
   def add_node name
      @last_node = @last_root &lt;&lt; Tree::TreeNode.new(name, 'node')
   end
   def add_specie name
      @last_node &lt;&lt; Tree::TreeNode.new(name, "specie")
   end
end
</pre></div>

<p>Rodando o arquivo texto com o algorítmo acima temos uma nova árvore pronta para ser desfrutada:</p>

<p>O bacana de trabalhar com ruby é poder utilizar cada parte do código independente. Observe a utilização desta árvore dentro do <a href="https://github.com/jonatas/chave-dicotomica-android">fonte</a>.</p>

<div><pre>
jonatas@jonatax:~/chave-dicotomica-android/src$ irb -r dicotomica.rb 
irb(main):001:0&gt; Dicotomica.new.print_tree;nil
* Chave Dicotômica
|---+ 1 - PLANTAS DESPROVIDAS DE FOLHAS
|    |---+ 1. Ramos suculentos, colunares, sucados longitudinalmente, com tufos de acúleos, sem espinhos terminais
|        +---&gt; 14.1 Cereus hildmannianus
|    +---+ 1. Ramos não suculentos, comprimidos lateralmente, com espinho terminal, decussados, ocasionalmente de formato triangular
        +--- \\&gt; 61.1 Colletia paradoxa
+---+ 2 - PALMEIRAS
    |---+ 1. Plantas com acúleos
|        +---&gt; 9.1 Acrocomia aculeata
    +---+ 1. Plantas sem acúleos .... 2
        |---+ 2. Lâminas em forma de leque, tão largas quanto compridas
|            +---&gt; 9.9 Trithrinax brasiliensis
        +---+ 2. Lâminas não em forma de leque, mais compridas que largas .... 3
            |---+ 3. Base dos pecíolos permanecendo ao longo do caule
|                |---&gt; 9.2 Butiaca pitata
|                |---&gt; 9.3 Butia eriospatha
|                +---&gt; 9.4 Butia yatay
            +---+ 3. Base dos pecíolos não permanecendo nos caules .... 4
                |---+ 4. Segmentos da folha dispostos em mais dois planos
|                    +---&gt; 9.8 Syagros romanzoffiana
                +---+ 4. Segmentos da folha dispostos em dois planos .... 5
                    |---+ 5. Base dos pecíolos de cor acinzentada
|                        +---&gt; 9.5 Butyagros x nabuannandii
                    +---+ 5. Base dos pecíolos de cor verde .... 6
                        |---+ 6. Bainhas foliares envolvendo completamente a porção apical do caule
|                            +---&gt; 9.6 Euterpe edulis
                        +---+ 6. Bainhas foliares não envolvendo completamente a porção apical do caule
                            +---\\&gt; 9.7 Geonoma schottiana
=&gt; nil
irb(main):002:0&gt; 
</pre></div>

<h2 id="ruboto">Ruboto</h2>

<p>Ruboto é uma gem muito legal que permite portar jruby e criar aplicativos para android usando jruby ao invés de java. É bem divertido e como sou apaixonado por ruby tive que experimentar.</p>

<div><pre>
gem install ruboto
</pre></div>

<p>Ruboto é estilo rails e tem seu próprio gerador de aplicativos e outras atividades. Para criar o aplicativo usei o seguinte comando:</p>

<div><pre>
ruboto gen app --package=me.ideia --target 1 --name ChaveDicotomicaAndroid --path /diretorio/destino
</pre></div>

<p>Use <code class="language-plaintext highlighter-rouge">ruboto gen app --help</code> para ver todas as opções. No site <a href="http://ruboto.org">ruboto</a> tem muitas coisas interessantes para se aprender e o melhor mesmo é baixar o projeto do ruboto-irb para testar no próprio aparelho.</p>

<p>E aqui está o código da aplicação que é apenas uma Activity principal:</p>

<div><pre class="prettyprint">
require 'ruboto/activity'
require 'ruboto/widget'
require 'ruboto/menu'
require 'ruboto/util/toast'
require 'dicotomica'
ruboto_import_widgets :LinearLayout, :EditText, :TextView, :ListView, :Button
$activity.start_ruboto_activity "$dicotomica" do
  @dicotomica = Dicotomica.new
  def on_create(bundle)
    start_tree
  end
  def start_tree
      @node = @dicotomica
      go_to_list 
  end
  def go_to_list 
    items = @node.children.collect(&amp;:name)
    setContentView(list_view :list =&gt; items, 
          :on_item_long_click_listener =&gt; proc{|av, v, pos, item_id| 
                @node = @node.children[pos]
                help_about
          },
          :on_item_click_listener =&gt; proc{|av, v, pos, item_id| 
                @node = @node.children[pos]
                if @node and @node.hasChildren?
                  go_to_list
                else

                  toast("Espécie encontrada")
                end
         }
    )
  end
  def about_us
    setContentView(Ruboto::R::layout::about)
    true
  end
  def help_about
    toast("Help about: #{@node.name}")
  end
  handle_create_options_menu do |menu|
    add_menu("Chave Dicotômica") { start_tree }
    add_menu("Sobre nós") { about_us }
    add_menu("Exit") {finish}
    true
  end
end
</pre></div>

<p>Se você tem um android <a href="https://github.com/jonatas/chave-dicotomica-android/raw/master/bin/Dicotomica.apk">baixe aqui</a> e instale no seu próprio aparelho esse exemplo.</p>

<p>Abaixo seguem os printscreens do aplicativo:</p>

<h2 id="tela-inicial">Tela inicial</h2>

<p>A tela inicial já começa com um list view, e é indicado pelo método on_create do código anterior. O list view, por sua vez vem carregado com os filhos do primeiro nível da chave dicotômica, que neste caso são as chaves.</p>

<p><img src="../../../images/cda-tela-inicial.png" alt="inicial" /></p>

<h2 id="tela-inicial-com-o-menu">Tela inicial com o menu</h2>

<p>O menu foi criado no último bloco do arquivo anterior com handle_create_menu_options</p>

<p><img src="../../../images/cda-com-menu.png" alt="inicialcommenu" /></p>

<h2 id="tela-sobre">Tela sobre</h2>

<p>A tela de sobre é um caso diferente e que foi o mais difícil até encontrar a solução. Este caso está utilizando a interface de recursos gerados pelo android através do xml. Note que o resource <em>R</em> vem <em>dentro</em> do módulo <em>Ruboto</em>, sendo <em>Ruboto::R</em> ao invés do <em>R</em> convencional na programação android.</p>

<p><img src="../../../images/cda-about.png" alt="sobre" /></p>

<h2 id="navegando-entre-nodos">Navegando entre nodos</h2>

<p>Este print screen apenas pra mostrar que está funcionando a navegação entre nodos internos da árvore.</p>

<p><img src="../../../images/cda-navegando.png" alt="navegando" /></p>

<h2 id="espécie-encontrada">Espécie encontrada</h2>

<p>Exemplo do toast rodando :D</p>

<p><img src="../../../images/cda-encontrou-especie.png" alt="encontrou" /></p>

<h2 id="conclusões">Conclusões</h2>

<p>Aparentemente é muito simples trabalhar com jRuby no Android, no entanto ainda não parece ser tão viável pela demora do jRuby para inicializar. Estou contando que as próximas versões se superem pois atualmente demora 17 segundos para inicializar o jruby no meu aparelho (Sansung Galaxy Ace). A inicialização do app é muito rápida, quando roda sobre o irb, é muito fácil de perceber que a VM é que demora pra carregar, e tirando isso é excelente.</p>


  </div>
  
  
  <div class="article-tags">
    
      <a href="#ruby-ref" class="article-tag">ruby</a>
    
      <a href="#android-ref" class="article-tag">android</a>
    
      <a href="#dsl-ref" class="article-tag">dsl</a>
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Chave+Dicot%C3%B4mica&url=https%3A%2F%2Fideia.me%2Fchave-dicotomica-android&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Fchave-dicotomica-android" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Fchave-dicotomica-android&title=Chave+Dicot%C3%B4mica" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Fchave-dicotomica-android&title=Chave+Dicot%C3%B4mica" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/pequenas-decisoes-grandes-mudancas" title="Pequenas mudanças e grandes decisões">
        Pequenas mudanças e grandes decisões
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/camera-overlay-open-source" title="Câmera Overlay Open Source">
        Câmera Overlay Open Source
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
                
                  
                  
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
          
            
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/benchmarking-ruby-orms">Benchmarking Ruby ORMs: ActiveRecord vs Sequel Performance with TimescaleDB</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> March 18, 2025
                        </small>
                      </p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
          
            
            
              
            
              
            
              
            
              
            
              
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body">
                      <h5 class="card-title">
                        <a href="/my-first-contribution-to-rubygems">My First Contribution To Rubygems</a>
                      </h5>
                      <p class="card-text text-muted">
                        <small>
                          <i class="bi bi-calendar3"></i> July 04, 2024
                        </small>
                      </p>
                      
                        <p class="card-text">Adding to my goal of being helpful in the software world, I had my first contribution to RubyGems [merged][new_pr] 🎉</p>
                      
                    </div>
                  </div>
                </div>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
          
          
        
        
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread" class="comments-section"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/chave-dicotomica-android';
    this.page.identifier = '/chave-dicotomica-android';
    
    // Handle dark mode for Disqus
    const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                        document.body.classList.contains('dark-mode') || 
                        window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (isDarkMode) {
      // Enable dark mode for Disqus
      this.page.functions = [];
      this.callbacks = {
        onReady: [function() {
          // Message the iframe to apply dark theme once loaded
          const message = {
            name: 'theme',
            data: {
              theme: 'dark'
            }
          };
          
          // Try to send the message multiple times as Disqus can load slowly
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 2000);
          
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 4000);
        }]
      };
    }
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    
    // Add dark styling for container
    if (document.documentElement.classList.contains('dark-mode') || 
        document.body.classList.contains('dark-mode') || 
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // Style the container immediately
      const style = document.createElement('style');
      style.textContent = `
        #disqus_thread {
          background-color: #1e1e1e !important;
          color: #f0f2f5 !important;
          padding: 20px;
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          margin-top: 30px;
          margin-bottom: 30px;
        }
        
        iframe {
          background-color: #1e1e1e !important;
          color-scheme: dark !important;
        }
        
        /* Force the iframe document to use dark mode */
        iframe[src*="disqus.com"] {
          color-scheme: dark !important;
          filter: invert(90%) hue-rotate(180deg) !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.documentElement.classList.add('dark-mode');
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
              console.log('Dark mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            } else {
              document.documentElement.classList.remove('dark-mode');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
              console.log('Light mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            }
            
            // Force reload the page to ensure all styles are applied correctly
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
        }
        
        // Apply highlighting to code blocks after content loads
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Configure Disqus for dark mode if needed
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        if (isDarkMode) {
          // Insert dark mode CSS for Disqus
          const style = document.createElement('style');
          style.innerHTML = `
            #disqus_thread {
              background-color: #1e1e1e !important;
              color: #f0f2f5 !important;
              padding: 20px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            }
          `;
          document.head.appendChild(style);
          
          // Set Disqus config variable for dark mode
          window.disqus_config = function() {
            this.page.identifier = window.location.pathname;
            this.page.url = window.location.href;
            this.language = 'en';
            this.sso = {
              name: 'SiteName',
            };
            this.callbacks.onReady = [function() {
              const interval = setInterval(function() {
                if (document.getElementById('dsq-app2')) {
                  clearInterval(interval);
                  const disqusIframe = document.getElementById('dsq-app2');
                  disqusIframe.contentWindow.postMessage({
                    name: 'setTheme',
                    data: 'dark',
                  }, '*');
                }
              }, 100);
            }];
          };
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
    
    <!-- Disqus Dark Mode Handler -->
    <script>
      // Function to handle Disqus dark mode
      function setupDisqusDarkMode() {
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        // Add a style element to target the Disqus iframe
        const disqusStyle = document.createElement('style');
        disqusStyle.innerHTML = `
          html.dark-mode iframe, body.dark-mode iframe {
            color-scheme: dark !important;
          }
          
          html.dark-mode #disqus_thread, body.dark-mode #disqus_thread {
            background-color: #1e1e1e !important;
            color: #f0f2f5 !important;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        `;
        document.head.appendChild(disqusStyle);
        
        // Check for Disqus iframe and inject dark styles if needed
        const checkForDisqus = setInterval(() => {
          const disqusThread = document.getElementById('disqus_thread');
          const disqusIframes = document.querySelectorAll('iframe[src*="disqus.com"]');
          
          if (disqusThread || disqusIframes.length > 0) {
            clearInterval(checkForDisqus);
            
            if (isDarkMode) {
              // Try to signal Disqus to use dark theme
              if (window.DISQUS) {
                try {
                  window.DISQUS.host._loadEmbed({
                    color: 'dark',
                  });
                } catch (e) {
                  console.log('Could not set Disqus theme via API');
                }
              }
              
              // Direct CSS approach to all iframes
              disqusIframes.forEach(iframe => {
                try {
                  // Try to access the iframe document
                  const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                  
                  // Add dark mode classes and styles
                  if (iframeDocument.body) {
                    iframeDocument.body.classList.add('dark-mode');
                    
                    const darkStyle = iframeDocument.createElement('style');
                    darkStyle.textContent = `
                      body { background-color: #1e1e1e !important; color: #f0f2f5 !important; }
                      .textarea-wrapper, .post-actions, .alert { background-color: #2a2d31 !important; }
                      .wysiwyg__placeholder, input, textarea { color: #f0f2f5 !important; }
                      .publisher-background-color { background-color: #1e1e1e !important; }
                      .publisher-border-color { border-color: rgba(255, 255, 255, 0.1) !important; }
                      .publisher-anchor-color, a { color: #5c9eff !important; }
                    `;
                    iframeDocument.head.appendChild(darkStyle);
                  }
                } catch (e) {
                  console.log('Could not modify Disqus iframe due to CORS policy');
                  
                  // Add a fallback with filter approach
                  if (isDarkMode) {
                    // Apply a CSS filter to invert the colors
                    iframe.style.filter = 'invert(92%) hue-rotate(180deg)';
                  }
                }
              });
            }
          }
        }, 500);
      }
      
      // Run setup when DOM is loaded and after any content changes
      document.addEventListener('DOMContentLoaded', setupDisqusDarkMode);
      document.addEventListener('ajaxComplete', setupDisqusDarkMode);
      
      // Also run after a delay in case Disqus loads later
      setTimeout(setupDisqusDarkMode, 2000);
      setTimeout(setupDisqusDarkMode, 5000);
    </script>
    
    <!-- Dedicated Disqus dark mode handler -->
    <script src="/js/disqus-dark.js"></script>
  </body>
</html>

