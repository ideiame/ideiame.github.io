
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<link rel="stylesheet"
    type="text/css"
    href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"
    data-cfasync="false"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
    // Reads the value of a cookie by name or returns empty string
    function getCookie(name) {
        var b = document.cookie.match('(^|[^;]+)\\s*' + name + '\\s*=\\s*([^;]+)');
        return b ? b.pop() : '';
    }

    // Actually starting analytics up
    function addAnalytics() {
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-NV80WM9HT0');
    }

    // Waiting for the load event
    window.addEventListener("load", function () {
        // Reading "cookieconsent_status" cookie
        const cookieConsent = getCookie('cookieconsent_status');

        // Start analytics if user consented or did not deny
        if (cookieConsent === 'allow' || cookieConsent === '') {
            addAnalytics();
        }

        // Initialise cookie consent banner
        window.cookieconsent.initialise({
            "palette": {
                "popup": {
                    "background": "#efefef",
                    "text": "#404040"
                },
                "button": {
                    "background": "#8ec760",
                    "text": "#ffffff"
                }
            },
            "type": "opt-out",
            "content": {
                "allow": "Approve",
                "dismiss": "Approve",
                "deny": "Reject"
            },
            // Reload the page on user choice to make sure cookie is set
            onStatusChange: function (status, chosenBefore) {
                location.reload();
            }
        })
    });
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Fast supports SQL from Postgresql!</title>
    <meta name="description" content="Hey, I'm thrilled to share my recent work on the [Fast gem][fast] - an update that's close to my heart. I've just merged a pull request that's all about brin...">
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Immediate dark mode application to prevent flash -->
    <script>
      (function() {
        // Force dark mode for testing purposes
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.documentElement.classList.add('dark-mode');
          document.write('<style>body,html{background-color:#121212!important;color:#f0f2f5!important;}div{background-color:transparent!important;}</style>');
        }
      })();
    </script>

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Modern stylesheet links -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600&family=Poppins:wght@400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <!-- GitHub-style syntax highlighting -->
    <link href="/css/rouge-github.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/disqus-dark.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- Modern JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- GitHub-style code block enhancement -->
    <script src="/js/github-code-blocks.js"></script>
    
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand py-0" href="/">
          <img class="rounded-circle" alt="ideiame logo" src="/images/ideiame.png">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle py-1" href="#" id="pagesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
               Ideia.me 
              </a>
              <ul class="dropdown-menu shadow-sm" aria-labelledby="pagesDropdown">
                <li><a class="dropdown-item" href="/archive">Archive</a></li>
                <li><a class="dropdown-item" href="/talks">Talks</a></li>
                <li><a class="dropdown-item" href="/categories">Categories</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="https://www.linkedin.com/in/jonatasdp"><i class="bi bi-linkedin"></i> Linkedin</a></li>
                <li><a class="dropdown-item" href="https://github.com/jonatas"><i class="bi bi-github"></i> Github</a></li>
                <li><a class="dropdown-item" href="https://twitter.com/jonatasdp"><i class="bi bi-twitter"></i> Twitter</a></li>
                <li><a class="dropdown-item" href="https://instagram.com/jonatasdp"><i class="bi bi-instagram"></i> Instagram</a></li>
                <li><a class="dropdown-item" href="https://www.youtube.com/user/jonatasdp"><i class="bi bi-youtube"></i> Youtube</a></li>
              </ul>
            </li>
          </ul>
          
          <div class="d-none d-md-block page-title-nav me-auto ms-2">
            Fast supports SQL from Postgresql!
          </div>
          
          <div class="form-check form-switch d-flex align-items-center ms-auto">
            <input class="form-check-input me-1" type="checkbox" id="darkModeToggle">
            <label class="form-check-label text-light" for="darkModeToggle">
              <i class="bi bi-moon-stars"></i>
            </label>
          </div>
        </div>
      </div>
    </nav>
    
    <div class="container content-container mt-5 pt-5">
      

<div class="article-wrapper">
  <div class="article-header">
    <h1>Fast supports SQL from Postgresql!</h1>
    <div class="article-meta">
      <span><i class="bi bi-calendar3"></i> November 17, 2023</span>
      <span class="separator">•</span>
      
  
  
    <span class="reading-time" title="Estimated read time">
      <i class="bi bi-clock"></i> 4 min read
    </span>
  
 
      
      
      <span class="separator">•</span>
      <span>
        <i class="bi bi-folder"></i> 
        
      </span>
      
    </div>
  </div>
  
  <div class="article-content">
    <p>Hey, I’m thrilled to share my recent work on the <a href="https://github.com/jonatas/fast">Fast gem</a> - an update that’s close to my heart.
I’ve just merged a pull request that’s all about bringing SQL support.
This journey wasn’t just about coding; it was about creating something that could
really make a difference in how we handle SQL within our projects.</p>

<div class="video-container">
       <iframe width="560" height="420" frameborder="0" allowfullscreen="" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" src="https://www.youtube.com/embed/_p651dSIFIQ?color=white&amp;theme=light">
       </iframe>
    </div>

<p>I always visualize one day I’d translate the pg_query AST to a format closer to
Ruby AST that I can use Fast to search and refactor code.</p>

<p>My journey started with a clear goal: to enable a rewrite interface for SQL in the Fast gem. It was a challenging yet exciting to understand and translate the source buffer, finding the positions from the tokens and allowing to refactor.</p>

<p>As I delved deeper, I realized the potential impact of this feature. The idea was to make SQL handling through Ruby language not just easier, but more intuitive and efficient.</p>

<p>I always work in a prototyping mode which I begin the groundwork by trying short POCs of the building blocks I need to explore.</p>

<p>My first challenge was just get a clear AST similar to Ruby, without blanks and
default nodes. This required deep diving into several SQL statments and analyze the SQL AST to see what was really key representation of the features.</p>

<p>Long story short, this is the type of thing that you can do with the library:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span>
  <span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from my_table"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)</span>
<span class="c1"># "select * from customers"</span>
</code></pre></div></div>

<p>It’s the same as:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span>
  <span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customerss"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">,</span> <span class="o">&amp;-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">replace</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>Looks like boring and you could easily do with string replacement right?</p>

<p>Probably, But let’s analyze deeper why it matters.</p>

<p>This is the AST representation:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customers"</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="n">s</span><span class="p">(</span><span class="ss">:select_stmt</span><span class="p">,</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:target_list</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">))))),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:from_clause</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:range_var</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">))))</span>
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">#replace</code> method is a shortcut to <code class="language-plaintext highlighter-rouge">replace</code> method from the
TreeRewriter that comes from the parser gem. So the previous code is exactly as
the next. The <code class="language-plaintext highlighter-rouge">relname</code> is just the “search” for node type “relname”. Then, you
can use a block of code to also do your edits or just the previous replace
method that is a shortcut to the lambda function:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customerss"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">,</span> <span class="o">&amp;-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span><span class="n">replace</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)})</span>
</code></pre></div></div>

<p>The function runs on <code class="language-plaintext highlighter-rouge">TreeRewriter#instance_exec</code> allowing you to do several
things at once:</p>

<p>Example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customerss"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
  <span class="n">insert_before</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"-- some comment in the beginning </span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">).</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)</span>
  <span class="n">insert_after</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">-- some comment after"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The output will be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-- some comment in the beginning
select * from customers
-- some comment after
</code></pre></div></div>

<p>Same replacement of relname. Now, let’s compare the AST of both cases:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Fast</span><span class="p">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="nv">"table customers"</span><span class="p">)</span> <span class="o">==</span>
  <span class="n">Fast</span><span class="p">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="nv">"select * from customers"</span><span class="p">)</span> <span class="o">#</span> <span class="o">=&gt;</span> <span class="k">true</span>
</code></pre></div></div>

<p>As you can see, different statements have same AST. It can allow you to get
several syntax styles and refactor them at once.</p>

<h2 id="key-features-of-the-update">Key Features of the Update</h2>

<p>Here’s what the latest update brings to the table:</p>

<ul>
  <li><strong>SQL Rewrite Interface</strong>: A new way to handle SQL queries within Ruby projects. This interface is designed to be intuitive and user-friendly, making SQL interactions seamless.</li>
  <li><strong>Enhanced Documentation</strong>: To ensure everyone can make the most of this new feature, I’ve put together <a href="https://jonatas.github.io/fast/sql-support/">comprehensive documentation</a>. It’s detailed, yet easy to follow – your guide to mastering SQL handling in Fast:</li>
  <li><strong>A Fresh Look</strong>: Along with functional upgrades, the Fast gem also got a visual facelift with an updated logo. It’s all about keeping things fresh and modern.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>I hope this update to the Fast gem is more than just a new feature; it’s a testament to the power of community and open-source collaboration. I’m so happy to be able to just use projects like <a href="https://github.com/pganalyze/pg_query">pg_query</a> and I can’t wait to see what people will do with it!</p>

<p>Your feedback is not just welcome, it’s essential for continuous improvement. If you use fast of anything and want to share, feel free to reach out via <a href="!https://www.linkedin.com/in/jonatasdp">linkedin</a> or open an issue on <a href="https://github.com/jonatas/fast">fast</a>.</p>

<p>Happy coding!</p>


  </div>
  
  
  <div class="article-tags">
    
  </div>
  
  
  
<div class="social-sharing mb-4">
  <h5>Share this article</h5>
  <div class="sharing-buttons">
    
    <a href="https://twitter.com/intent/tweet?text=Fast+supports+SQL+from+Postgresql%21&url=https%3A%2F%2Fideia.me%2Ffast-supports-sql&via=jonatasdp" 
       class="btn btn-twitter btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-twitter"></i> Twitter
    </a>
    
    
    
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fideia.me%2Ffast-supports-sql" 
       class="btn btn-facebook btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    
    
    
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fideia.me%2Ffast-supports-sql&title=Fast+supports+SQL+from+Postgresql%21" 
       class="btn btn-linkedin btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-linkedin"></i> LinkedIn
    </a>
    
    
    
    <a href="https://reddit.com/submit?url=https%3A%2F%2Fideia.me%2Ffast-supports-sql&title=Fast+supports+SQL+from+Postgresql%21" 
       class="btn btn-reddit btn-sm" 
       target="_blank"
       rel="noopener noreferrer">
      <i class="bi bi-reddit"></i> Reddit
    </a>
    
  </div>
</div>
 
  <div class="author-bio">
  <img src="/images/jonatas-davi-paganini-profile-2025.png" alt="Jônatas Davi Paganini">
  <div class="author-bio-content">
    <h4>Jônatas Davi Paganini</h4>
    <p>Developer and writer passionate about PostgreSQL, TimescaleDB, and building better systems. Currently sharing knowledge about time series databases and system architecture.</p>
    <div class="author-social">
      <a href="https://github.com/jonatas" target="_blank" title="GitHub"><i class="bi bi-github"></i></a>
      <a href="https://twitter.com/jonatasdp" target="_blank" title="Twitter"><i class="bi bi-twitter"></i></a>
      <a href="https://linkedin.com/in/jonatasdp" target="_blank" title="LinkedIn"><i class="bi bi-linkedin"></i></a>
      
      <a href="https://instagram.com/jonatasdp" target="_blank" title="Instagram"><i class="bi bi-instagram"></i></a>
      
    </div>
  </div>
</div> 
  <div class="content-nav">
  <div class="content-nav-previous">
    
      <small>Previous</small>
      <a href="/sonification-device" title="Sonification Device">
        Sonification Device
      </a>
    
  </div>
  
  <div class="content-nav-next">
    
      <small>Next</small>
      <a href="/building-a-sql-formatter-with-fast" title="Building a SQL formatter with Fast">
        Building a SQL formatter with Fast
      </a>
    
  </div>
</div> 
  
<div class="related-posts">
  <div class="card">
    <div class="card-header">
      <h4>Related Articles</h4>
    </div>
    <div class="card-body">
      <div class="row">
        
        
        
        
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
            
              
              
              
              
            
          
          
          
        
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
        
          
            
              
              
                
              
                
              
              
              
            
          
          
          
            
        
        
        
        
        
        
        
          <div class="col-12">
            <p>No related posts found. Check out <a href="/archive.html">recent posts</a> instead.</p>
          </div>
        
      </div>
    </div>
  </div>
</div>
 
  
<div id="disqus_thread" class="comments-section"></div>
<script>
  var disqus_config = function () {
    this.page.url = '/fast-supports-sql';
    this.page.identifier = '/fast-supports-sql';
    
    // Handle dark mode for Disqus
    const isDarkMode = document.documentElement.classList.contains('dark-mode') || 
                        document.body.classList.contains('dark-mode') || 
                        window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (isDarkMode) {
      // Enable dark mode for Disqus
      this.page.functions = [];
      this.callbacks = {
        onReady: [function() {
          // Message the iframe to apply dark theme once loaded
          const message = {
            name: 'theme',
            data: {
              theme: 'dark'
            }
          };
          
          // Try to send the message multiple times as Disqus can load slowly
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 2000);
          
          setTimeout(function() {
            const iframe = document.querySelector('iframe[title="Disqus"]');
            if (iframe && iframe.contentWindow) {
              iframe.contentWindow.postMessage(message, '*');
            }
          }, 4000);
        }]
      };
    }
  };

  (function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://ideiame.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    
    // Add dark styling for container
    if (document.documentElement.classList.contains('dark-mode') || 
        document.body.classList.contains('dark-mode') || 
        window.matchMedia('(prefers-color-scheme: dark)').matches) {
      // Style the container immediately
      const style = document.createElement('style');
      style.textContent = `
        #disqus_thread {
          background-color: #1e1e1e !important;
          color: #f0f2f5 !important;
          padding: 20px;
          border-radius: 8px;
          border: 1px solid rgba(255, 255, 255, 0.1) !important;
          margin-top: 30px;
          margin-bottom: 30px;
        }
        
        iframe {
          background-color: #1e1e1e !important;
          color-scheme: dark !important;
        }
        
        /* Force the iframe document to use dark mode */
        iframe[src*="disqus.com"] {
          color-scheme: dark !important;
          filter: invert(90%) hue-rotate(180deg) !important;
        }
      `;
      document.head.appendChild(style);
    }
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 
</div>

<link rel="stylesheet" href="/css/enhanced.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="/css/disable-line-numbers.css">
<script src="/js/disable-line-numbers.js"></script>


    </div>
    
    <footer class="footer bg-light py-4 mt-5">
      <div class="container text-center">
        <p class="text-muted mb-0">© 2025 Jônatas Davi Paganini. All rights reserved.</p>
      </div>
    </footer>

    <!-- Additional scripts for code highlighting and dark mode toggle -->
    <script>
      // Toggle dark mode manually with smoother transition
      document.addEventListener('DOMContentLoaded', function() {
        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
          darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
              document.documentElement.classList.add('dark-mode');
              document.body.classList.add('dark-mode');
              localStorage.setItem('theme', 'dark');
              console.log('Dark mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            } else {
              document.documentElement.classList.remove('dark-mode');
              document.body.classList.remove('dark-mode');
              localStorage.setItem('theme', 'light');
              console.log('Light mode enabled via toggle');
              
              // Update Disqus theme if it exists
              if (window.DISQUS) {
                try {
                  DISQUS.reset({
                    reload: true,
                    config: function () {
                      this.page.identifier = window.disqus_identifier;
                      this.page.url = window.disqus_url;
                      this.page.title = window.disqus_title;
                      this.forum = window.disqus_shortname;
                    }
                  });
                } catch (e) {
                  console.log('Error resetting Disqus:', e);
                }
              }
            }
            
            // Force reload the page to ensure all styles are applied correctly
            setTimeout(() => {
              window.location.reload();
            }, 100);
          });
        }
        
        // Apply highlighting to code blocks after content loads
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
        
        // Configure Disqus for dark mode if needed
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        if (isDarkMode) {
          // Insert dark mode CSS for Disqus
          const style = document.createElement('style');
          style.innerHTML = `
            #disqus_thread {
              background-color: #1e1e1e !important;
              color: #f0f2f5 !important;
              padding: 20px;
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.1);
            }
          `;
          document.head.appendChild(style);
          
          // Set Disqus config variable for dark mode
          window.disqus_config = function() {
            this.page.identifier = window.location.pathname;
            this.page.url = window.location.href;
            this.language = 'en';
            this.sso = {
              name: 'SiteName',
            };
            this.callbacks.onReady = [function() {
              const interval = setInterval(function() {
                if (document.getElementById('dsq-app2')) {
                  clearInterval(interval);
                  const disqusIframe = document.getElementById('dsq-app2');
                  disqusIframe.contentWindow.postMessage({
                    name: 'setTheme',
                    data: 'dark',
                  }, '*');
                }
              }, 100);
            }];
          };
        }
      });
      
      // Reapply highlighting after any AJAX content loads
      document.addEventListener('ajaxComplete', function() {
        enhanceCodeBlocks();
        if (window.Prism) {
          setTimeout(function() {
            Prism.highlightAll();
          }, 100);
        }
      });
    </script>

    <!-- SEO and content improvement scripts -->
    <script src="/assets/js/seo-helper.js"></script>
    <script src="/assets/js/category-standardizer.js"></script>
    <script src="/assets/js/link-validator.js"></script>

    <!-- Add this at the end of the body, just before closing body tag -->
    <script>
      // Scroll animation for fade-in elements - modified to be more selective
      document.addEventListener('DOMContentLoaded', function() {
        const fadeElements = document.querySelectorAll('.fade-in');
        
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('visible');
            }
          });
        }, {
          threshold: 0.1
        });
        
        fadeElements.forEach(element => {
          observer.observe(element);
        });
        
        // Only apply fade-in to non-critical UI elements
        // Avoid applying to main content or navigation elements
        const animateElements = document.querySelectorAll('.card:not(.latest-post-card):not(.post-content), .featured-content .card, .post-list-group .list-group-item');
        animateElements.forEach((element, index) => {
          // Add minimal delay to reduce blinking effect
          element.classList.add('fade-in');
          element.style.transitionDelay = `${index * 0.02}s`; // Reduced delay
        });
        
        // Copy code button functionality
        const codeBlocks = document.querySelectorAll('pre');
        codeBlocks.forEach((block) => {
          if (!block.querySelector('.copy-button')) {
            const button = document.createElement('button');
            button.className = 'copy-button';
            button.textContent = 'Copy';
            
            button.addEventListener('click', () => {
              const code = block.querySelector('code').textContent;
              navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                  button.textContent = 'Copy';
                  button.classList.remove('copied');
                }, 2000);
              });
            });
            
            block.appendChild(button);
          }
        });
      });
    </script>

    <!-- Ensure smooth page transitions -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Add fade-in class to the main content container
        const contentContainer = document.querySelector('.content-container');
        if (contentContainer) {
          // Set initial opacity
          contentContainer.style.opacity = '0';
          
          // Fade in the content
          setTimeout(() => {
            contentContainer.style.transition = 'opacity 0.3s ease';
            contentContainer.style.opacity = '1';
          }, 50);
        }
        
        // Handle page navigation with smooth transitions
        document.querySelectorAll('a').forEach(link => {
          // Only apply to internal links
          if (link.hostname === window.location.hostname && !link.hasAttribute('target')) {
            link.addEventListener('click', function(e) {
              // Don't apply to download links or anchor links
              if (link.hasAttribute('download') || link.getAttribute('href').startsWith('#')) {
                return;
              }
              
              e.preventDefault();
              const destination = link.href;
              
              // Fade out
              if (contentContainer) {
                contentContainer.style.opacity = '0';
              }
              
              // Navigate after a short delay
              setTimeout(() => {
                window.location.href = destination;
              }, 300);
            });
          }
        });
      });
    </script>
    <!-- Profile image swap functionality -->
    <script src="/js/profile-image-swap.js"></script>
    
    <!-- Disqus Dark Mode Handler -->
    <script>
      // Function to handle Disqus dark mode
      function setupDisqusDarkMode() {
        const isDarkMode = document.documentElement.classList.contains('dark-mode');
        
        // Add a style element to target the Disqus iframe
        const disqusStyle = document.createElement('style');
        disqusStyle.innerHTML = `
          html.dark-mode iframe, body.dark-mode iframe {
            color-scheme: dark !important;
          }
          
          html.dark-mode #disqus_thread, body.dark-mode #disqus_thread {
            background-color: #1e1e1e !important;
            color: #f0f2f5 !important;
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
          }
        `;
        document.head.appendChild(disqusStyle);
        
        // Check for Disqus iframe and inject dark styles if needed
        const checkForDisqus = setInterval(() => {
          const disqusThread = document.getElementById('disqus_thread');
          const disqusIframes = document.querySelectorAll('iframe[src*="disqus.com"]');
          
          if (disqusThread || disqusIframes.length > 0) {
            clearInterval(checkForDisqus);
            
            if (isDarkMode) {
              // Try to signal Disqus to use dark theme
              if (window.DISQUS) {
                try {
                  window.DISQUS.host._loadEmbed({
                    color: 'dark',
                  });
                } catch (e) {
                  console.log('Could not set Disqus theme via API');
                }
              }
              
              // Direct CSS approach to all iframes
              disqusIframes.forEach(iframe => {
                try {
                  // Try to access the iframe document
                  const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
                  
                  // Add dark mode classes and styles
                  if (iframeDocument.body) {
                    iframeDocument.body.classList.add('dark-mode');
                    
                    const darkStyle = iframeDocument.createElement('style');
                    darkStyle.textContent = `
                      body { background-color: #1e1e1e !important; color: #f0f2f5 !important; }
                      .textarea-wrapper, .post-actions, .alert { background-color: #2a2d31 !important; }
                      .wysiwyg__placeholder, input, textarea { color: #f0f2f5 !important; }
                      .publisher-background-color { background-color: #1e1e1e !important; }
                      .publisher-border-color { border-color: rgba(255, 255, 255, 0.1) !important; }
                      .publisher-anchor-color, a { color: #5c9eff !important; }
                    `;
                    iframeDocument.head.appendChild(darkStyle);
                  }
                } catch (e) {
                  console.log('Could not modify Disqus iframe due to CORS policy');
                  
                  // Add a fallback with filter approach
                  if (isDarkMode) {
                    // Apply a CSS filter to invert the colors
                    iframe.style.filter = 'invert(92%) hue-rotate(180deg)';
                  }
                }
              });
            }
          }
        }, 500);
      }
      
      // Run setup when DOM is loaded and after any content changes
      document.addEventListener('DOMContentLoaded', setupDisqusDarkMode);
      document.addEventListener('ajaxComplete', setupDisqusDarkMode);
      
      // Also run after a delay in case Disqus loads later
      setTimeout(setupDisqusDarkMode, 2000);
      setTimeout(setupDisqusDarkMode, 5000);
    </script>
    
    <!-- Dedicated Disqus dark mode handler -->
    <script src="/js/disqus-dark.js"></script>

    <!-- Dark Mode Script -->
    <script>
      function detectColorScheme() {
        // Check saved preference first
        const savedTheme = localStorage.getItem('theme');
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        // Apply theme based on saved preference or system preference
        if (savedTheme === 'dark' || (savedTheme === null && prefersDarkMode)) {
          document.body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = true;
          console.log('Dark mode applied on initial load');
        } else {
          document.body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          if (darkModeToggle) darkModeToggle.checked = false;
          console.log('Light mode applied on initial load');
        }
        
        // Listen for changes in the OS color scheme only if no saved preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          // Only apply system preference if user hasn't manually chosen a theme
          if (localStorage.getItem('theme') === null) {
            const newColorScheme = e.matches ? 'dark' : 'light';
            if (newColorScheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.documentElement.classList.add('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = true;
              console.log('Dark mode applied from system preference change');
            } else {
              document.body.classList.remove('dark-mode');
              document.documentElement.classList.remove('dark-mode');
              if (darkModeToggle) darkModeToggle.checked = false;
              console.log('Light mode applied from system preference change');
            }
          }
        });
      }

      // Initialize dark mode immediately before DOM content is fully loaded
      detectColorScheme();
      
      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        detectColorScheme();
      });
    </script>
  </body>
</html>

