
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NV80WM9HT0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NV80WM9HT0');
</script>

    <script async
src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1171230226237014"
crossorigin="anonymous"></script>

    <meta charset="utf-8">
    <title>Fast supports SQL from Postgresql!</title>
    
    <meta name="author" content="Jônatas Davi Paganini">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link id="bootstrap" href="/css/bootstrap.css" rel="stylesheet">
    <link id="bootstrap" href="/css/bootswatch.min.css" rel="stylesheet">
    <link href="/css/nimbus-pygments.css" rel="stylesheet">

    <script src="/js/jquery.js"></script>
    <script type="text/javascript" src="/js/bootstrap-dropdown.js"></script>
    <div id="fb-root"></div>

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">
  <script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
    addEventListener('load', function (event) {
      var agent=navigator.userAgent.toLowerCase();
      var links = document.getElementsByTagName('a');
      var regex = new RegExp('^'+window.location.protocol + '//' + window.location.hostname);

      for (var i = 0, linksLength = links.length; i < linksLength; i++) {
        if ( ! links[i].href.match(regex)) {
           links[i].setAttribute('target', '_blank');
       }
     }

    }, false);
// ]]>
</script>
</head>
<body>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v2.5&appId=138593009602387";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a href="/">
            <img class="img-circle" alt="ideiame logo" style="padding-top: 6px" src="/images/ideiame.png"></a>
            <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
           </button>
       </div>
   <div class="navbar-collapse collapse" id="navbar-main">
     <ul class="nav navbar-nav">
      <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Social<b class="caret"></b></a>
            <ul class="dropdown-menu" id="swatch-menu">
              <li><a href="https://github.com/jonatas">Github</a></li>
              <li><a href="https://twitter.com/jonatasdp">Twitter</a></li>
              <li><a href="https://instagram.com/jonatasdp">Instagram</a></li>
              <li><a href="https://www.meetup.com/Floripa-on-Rails/members/185190193/">Meetup</a></li>
              <li><a href="https://www.slideshare.net/jonataspaganini/">SlideShare</a></li>
              <li><a href="https://facebook.com/jonatas.paganini">Facebook</a></li>
              <li><a href="https://www.youtube.com/user/jonatasdp">Youtube</a></li>
           </ul>
          </li>
          <li class="dropdown">
            <a class="dropdown-toggle" data-toggle="dropdown" href="#">Projects<b class="caret"></b></a>
            <ul class="dropdown-menu">
            <li><a href="https://github.com/jonatas/fast">Fast</a></li>
            <li><a href="http://torf.ideia.me">2015: True Or False Game</a></li>
            <li><a href="http://github.com/jonatas/pixel.ideia.me">2013: Pixel art (collaborative) </a></li>
            <li><a href="http://github.com/jonatas/trybliss">2013: Try Bliss</a</li>
            <li><a href="http://github.com/jonatas/churumelas">2012: Regexp challenges</a></li>
            <li><a href="/camera-overlay">2012: Camera Overlay </a></li>
           </ul>
          </li>
          
          
          


  
    
      
      	
      	<li><a href="/archive">Arquivo</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories">Categorias</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  



          </ul>
        </div>
      </div>
     </div>
    </div>
    <div class="container">
      
<div class="page-header">
    <h1>
       <img class="thumb img-circle" src="https://avatars0.githubusercontent.com/u/15484?s=50" title="Jônatas Davi Paganini" alt="Jônatas Davi Paganini profile pic"></img>
       Fast supports SQL from Postgresql! <small><br/>17/11/2023
    
      <span class="categories">
        
       </span>
     
     </small>
  </h1>
</div>
<div class="content">
    <p>Hey, I’m thrilled to share my recent work on the <a href="https://github.com/jonatas/fast">Fast gem</a> - an update that’s close to my heart.
I’ve just merged a pull request that’s all about bringing SQL support.
This journey wasn’t just about coding; it was about creating something that could
really make a difference in how we handle SQL within our projects.</p>

<div class="video-container">
       <iframe width="560" height="420" frameborder="0" allowfullscreen="" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" src="https://www.youtube.com/embed/_p651dSIFIQ?color=white&amp;theme=light">
       </iframe>
    </div>

<p>I always visualize one day I’d translate the pg_query AST to a format closer to
Ruby AST that I can use Fast to search and refactor code.</p>

<p>My journey started with a clear goal: to enable a rewrite interface for SQL in the Fast gem. It was a challenging yet exciting to understand and translate the source buffer, finding the positions from the tokens and allowing to refactor.</p>

<p>As I delved deeper, I realized the potential impact of this feature. The idea was to make SQL handling through Ruby language not just easier, but more intuitive and efficient.</p>

<p>I always work in a prototyping mode which I begin the groundwork by trying short POCs of the building blocks I need to explore.</p>

<p>My first challenge was just get a clear AST similar to Ruby, without blanks and
default nodes. This required deep diving into several SQL statments and analyze the SQL AST to see what was really key representation of the features.</p>

<p>Long story short, this is the type of thing that you can do with the library:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span>
  <span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from my_table"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)</span>
<span class="c1"># "select * from customers"</span>
</code></pre></div></div>

<p>It’s the same as:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span>
  <span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customerss"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">,</span> <span class="o">&amp;-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span> <span class="n">replace</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<p>Looks like boring and you could easily do with string replacement right?</p>

<p>Probably, But let’s analyze deeper why it matters.</p>

<p>This is the AST representation:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customers"</span><span class="p">)</span>
 <span class="o">=&gt;</span> <span class="n">s</span><span class="p">(</span><span class="ss">:select_stmt</span><span class="p">,</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:target_list</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:res_target</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:val</span><span class="p">,</span>
        <span class="n">s</span><span class="p">(</span><span class="ss">:column_ref</span><span class="p">,</span>
          <span class="n">s</span><span class="p">(</span><span class="ss">:fields</span><span class="p">))))),</span>
  <span class="n">s</span><span class="p">(</span><span class="ss">:from_clause</span><span class="p">,</span>
    <span class="n">s</span><span class="p">(</span><span class="ss">:range_var</span><span class="p">,</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relname</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:inh</span><span class="p">,</span> <span class="kp">true</span><span class="p">),</span>
      <span class="n">s</span><span class="p">(</span><span class="ss">:relpersistence</span><span class="p">,</span> <span class="s2">"p"</span><span class="p">))))</span>
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">#replace</code> method is a shortcut to <code class="language-plaintext highlighter-rouge">replace</code> method from the
TreeRewriter that comes from the parser gem. So the previous code is exactly as
the next. The <code class="language-plaintext highlighter-rouge">relname</code> is just the “search” for node type “relname”. Then, you
can use a block of code to also do your edits or just the previous replace
method that is a shortcut to the lambda function:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customerss"</span><span class="p">)</span>
  <span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">,</span> <span class="o">&amp;-&gt;</span><span class="p">(</span><span class="n">e</span><span class="p">){</span><span class="n">replace</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)})</span>
</code></pre></div></div>

<p>The function runs on <code class="language-plaintext highlighter-rouge">TreeRewriter#instance_exec</code> allowing you to do several
things at once:</p>

<p>Example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Fast</span><span class="p">.</span><span class="nf">parse_sql</span><span class="p">(</span><span class="s2">"select * from customerss"</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="s2">"_"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
  <span class="n">insert_before</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"-- some comment in the beginning </span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
  <span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">first</span><span class="p">(</span><span class="s2">"relname"</span><span class="p">).</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"customers"</span><span class="p">)</span>
  <span class="n">insert_after</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="nf">loc</span><span class="p">.</span><span class="nf">expression</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">-- some comment after"</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The output will be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-- some comment in the beginning
select * from customers
-- some comment after
</code></pre></div></div>

<p>Same replacement of relname. Now, let’s compare the AST of both cases:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Fast</span><span class="p">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="nv">"table customers"</span><span class="p">)</span> <span class="o">==</span>
  <span class="n">Fast</span><span class="p">.</span><span class="n">parse_sql</span><span class="p">(</span><span class="nv">"select * from customers"</span><span class="p">)</span> <span class="o">#</span> <span class="o">=&gt;</span> <span class="k">true</span>
</code></pre></div></div>

<p>As you can see, different statements have same AST. It can allow you to get
several syntax styles and refactor them at once.</p>

<h2 id="key-features-of-the-update">Key Features of the Update</h2>

<p>Here’s what the latest update brings to the table:</p>

<ul>
  <li><strong>SQL Rewrite Interface</strong>: A new way to handle SQL queries within Ruby projects. This interface is designed to be intuitive and user-friendly, making SQL interactions seamless.</li>
  <li><strong>Enhanced Documentation</strong>: To ensure everyone can make the most of this new feature, I’ve put together comprehensive documentation. It’s detailed, yet easy to follow – your guide to mastering SQL handling in Fast: https://jonatas.github.io/fast/sql-support/</li>
  <li><strong>A Fresh Look</strong>: Along with functional upgrades, the Fast gem also got a visual facelift with an updated logo. It’s all about keeping things fresh and modern.</li>
</ul>

<h2 id="conclusion">Conclusion</h2>

<p>I hope this update to the Fast gem is more than just a new feature; it’s a testament to the power of community and open-source collaboration. I’m so happy to be able to just use projects like <a href="https://github.com/pganalyze/pg_query">pg_query</a> and I can’t wait to see what people will do with it!</p>

<p>Your feedback is not just welcome, it’s essential for continuous improvement. If you use fast of anything and want to share, feel free to reach out via <a href="!https://www.linkedin.com/in/jonatasdp">linkedin</a> or open an issue on <a href="https://github.com/jonatas/fast">fast</a></p>

<p>Happy coding!</p>


</div>
<hr>

<div class="share-page">
  Share &rarr;
  <a href="https://twitter.com/intent/tweet?text=Fast supports SQL from Postgresql!&url=https://ideia.me/fast-supports-sql&via=jonatasdp&related=jonatasdp" rel="nofollow"title="Share on twitter">Twitter</a>
  <a href="https://facebook.com/sharer.php?u=https://ideia.me/fast-supports-sql" rel="nofollow" target="_blank" title="Share on Facebook">Facebook</a>
  <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://ideia.me/fast-supports-sql" rel="nofollow" target="_blank" title="Share on Linkedin">Linkedin</a>
</div>
<hr>
<div class="pagination">
    
      <span class="prev">
        <a href="/sonification-device" title="Sonification Device">&larr; Before</a>
      </span>
    
    | <span><a href="/archive.html">Archive</a></span> |
    
    <span class="next disabled"><a>Next &rarr;</a>
    
</div>
<hr>

<p>
  Hello there, my name is Jônatas Davi Paganini and this is my personal blog.
  <br />
  I'm developer advocate at <a href="https://timescale.com">Timescale</a> and
  I also have a few open source projects on <a href="https://github.com/jonatas">github</a>.
</p>
<p>Check my
  <a href="/talks">talks</a> or connect with me via
  <a href="https://br.linkedin.com/in/jonatasdp" target="_blank">linkedin</a> /
  <a href="https://twitter.com/jonatasdp" target="_blank">twitter</a> /
  <a href="https://github.com/jonatas" target="_blank">github</a> /
  <a href="https://instagram.com/jonatasdp" target="_blank">instagram</a> /
  <a href="https://fb.com/jonatas.paganini" target="_blank">facebook</a> /
  <a href="https://www.strava.com/athletes/12104550" target="_blank">strava</a> /
  <a href="http://www.meetup.com/members/185190193/" target="_blank">meetup</a>.
</p>



    </div>
  </body>
</html>

